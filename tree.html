<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tree Spirit MVP</title>
  <style>
    :root{
      --bg1:#0b1222;
      --panel:#121c33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#9fb0d9;
      --line:rgba(255,255,255,.10);
      --ok:#49d17d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#7aa2ff;
    }
    *{box-sizing:border-box}
    body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 20% -10%, rgba(122,162,255,.22), transparent 60%),
    radial-gradient(900px 600px at 90% 10%, rgba(73,209,125,.18), transparent 55%),
    linear-gradient(180deg, var(--bg1), #070b16);
  min-height:100vh;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:16px;
  padding-top:24px;
}
    .app{
      width:min(520px, 100%);
      background: rgba(18,28,51,.78);
      border:1px solid var(--line);
      border-radius:18px;
      max-height: calc(100vh - 32px); /* –≤–∞–∂–Ω–æ */
  overflow:auto;                  /* –≤–∞–∂–Ω–æ */
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    header{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      border-bottom:1px solid var(--line);
    }
    header .title{
      font-weight:800;
      letter-spacing:.2px;
    }
    header .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .wrap{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .scene{
      position:relative;
      height:380px;
      border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow:hidden;
    }
    /* –î–µ–Ω—å/–Ω–æ—á—å —Ñ–æ–Ω–æ–º: –ø–æ–∫–∞ –ø—Ä–∏–º–∏—Ç–∏–≤, –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ */
    .scene.day{
      background:
        radial-gradient(900px 420px at 20% -20%, rgba(255,230,150,.30), transparent 65%),
        radial-gradient(800px 420px at 90% 0%, rgba(122,162,255,.28), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }
    .scene.night{
      background:
        radial-gradient(900px 520px at 30% -10%, rgba(140,120,255,.22), transparent 65%),
        radial-gradient(800px 420px at 90% 0%, rgba(73,209,125,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }

    /* –¥–µ—Ä–µ–≤–æ (–ø–æ–∫–∞ —Å–∏–º–≤–æ–ª, –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏–º –Ω–∞ —Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–µ/–∫–∞—Ä—Ç–∏–Ω–∫–∏) */
    .tree{
      position:absolute;
      left:50%;
      top:54%;
      transform: translate(-50%, -50%);
      font-size: 110px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      transition: transform .35s ease;
      user-select:none;
    }
    .tree.pulse{ transform: translate(-50%, -50%) scale(1.05); }

    /* –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
    .glow{
      position:absolute;
      left:50%;
      top:56%;
      width:180px;
      height:180px;
      transform: translate(-50%, -50%);
      border-radius:999px;
      background: radial-gradient(circle, rgba(255,240,180,.18), rgba(140,120,255,.06), transparent 70%);
      filter: blur(1px);
      opacity:.85;
      pointer-events:none;
    }

    /* –ø–∞–Ω–µ–ª—å –º–µ—Ç—Ä–∏–∫ */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .card{
      border:1px solid var(--line);
      background: rgba(15,23,48,.65);
      border-radius:14px;
      padding:10px 12px;
    }
    .k{ font-size:12px; color:var(--muted); }
    .v{ margin-top:4px; font-weight:800; font-size:16px; }
    .bar{
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      margin-top:8px;
    }
    .bar > div{
      height:100%;
      width:50%;
      background: var(--accent);
    }

    /* –∫–Ω–æ–ø–∫–∏ */
    .actions{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    button{
      border:1px solid var(--line);
      background: rgba(122,162,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }
    .btn2{ background: rgba(73,209,125,.12); }
    .btnDanger{ background: rgba(255,107,107,.10); }

    /* –ª–æ–≥–∏ */
    .log{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      min-height: 16px;
    }

    /* –ø–∞–¥–∞—é—â–∏–µ –ª–∏—Å—Ç—å—è (—á–∞—Å—Ç–∏—Ü—ã) */
    .leaf{
      position:absolute;
      top:-20px;
      font-size:18px;
      opacity:.9;
      pointer-events:none;
      animation: fall linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }
    @keyframes fall{
      to{
        transform: translate(var(--dx), 320px) rotate(var(--rot));
        opacity: .1;
      }
    }
    
    /* ===== Quiz screen ===== */
.quiz{
  display:none;
  border:1px solid var(--line);
  background: rgba(15,23,48,.55);
  border-radius:16px;
  padding:12px;
  margin-bottom:12px;
}
.quiz.active{ display:block; }

.qTitle{
  font-weight:900;
  font-size:16px;
  margin-bottom:6px;
}
.qSub{ color:var(--muted); font-size:12px; margin-bottom:10px; }

.qCard{
  border:1px solid var(--line);
  background: rgba(18,28,51,.65);
  border-radius:14px;
  padding:10px 10px;
  margin:10px 0;
}
.qQuestion{ font-weight:800; margin-bottom:8px; }

.qOptions{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.qOpt{
  text-align:left;
  width:100%;
  background: rgba(122,162,255,.10);
}
.qOpt small{ display:block; color:var(--muted); font-weight:600; margin-top:2px; }

.quizFooter{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}
.pill{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  color: var(--muted);
  font-size:12px;
}

/* ===== Quiz option cards (image buttons) ===== */
.qOptions{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
.qOpt{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 10px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(122,162,255,.10);
}
.qOpt:active{ transform: translateY(1px); }
.qOpt.selected{
  outline: 2px solid rgba(255,255,255,.25);
  background: rgba(122,162,255,.18);
}
.qOptImg{
  width:46px;
  height:46px;
  border-radius:12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  flex:0 0 auto;
}
.qOptImg img{ width:100%; height:100%; object-fit:cover; display:block; }
.qOptText{ text-align:left; }
.qOptText b{ display:block; font-weight:900; }
.qOptText small{ display:block; color:var(--muted); font-weight:600; margin-top:2px; }

/* ===== Result screen ===== */
.result{
  display:none;
  border:1px solid var(--line);
  background: rgba(15,23,48,.55);
  border-radius:16px;
  padding:12px;
  margin-bottom:12px;
}
.result.active{ display:block; }

.rTitle{
  font-weight:900;
  font-size:16px;
  margin-bottom:6px;
}
.rSub{ color:var(--muted); font-size:12px; margin-bottom:10px; }

.rGrid{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
.rCard{
  display:flex;
  gap:12px;
  border:1px solid var(--line);
  background: rgba(18,28,51,.65);
  border-radius:14px;
  padding:10px;
}
.rImg{
  width:112px;
  height:112px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  overflow:hidden;
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
}
.rImg img{ width:100%; height:100%; object-fit:cover; display:block; }
.rBody{ flex:1 1 auto; }
.rBody .name{ font-weight:950; font-size:16px; }
.rBody .desc{ color:var(--muted); font-size:12px; line-height:1.35; margin-top:4px; }
.rBody .mods{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  color: var(--text);
  font-size:12px;
  font-weight:800;
}

.rActions{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}

@keyframes rainFall{
  from{ transform: translateY(-40px) rotate(10deg); opacity:.0; }
  10%{ opacity:1; }
  to{ transform: translateY(380px) rotate(10deg); opacity:0; }
}
@keyframes fogPulse{
  0%,100%{ opacity:.45; }
  50%{ opacity:.8; }
}
@keyframes windSweep{
  0%,100%{ opacity:.0; transform: translateX(-30%); }
  40%{ opacity:.35; }
  60%{ opacity:.35; }
  100%{ opacity:.0; transform: translateX(30%); }
}

#dayNightLayer{
  border-radius:16px;
  transition: background 1200ms ease, opacity 1200ms ease;
  opacity: 1;
}

.firefly{
  position:absolute;
  width:6px; height:6px;
  border-radius:999px;
  background: rgba(255,255,255,.28);
  box-shadow: 0 0 14px rgba(255,255,255,.35);
  animation: fly 4.5s ease-in-out infinite;
  opacity:.0;
}
@keyframes fly{
  0%{ transform: translate(0,0); opacity:0; }
  20%{ opacity:.8; }
  60%{ opacity:.65; }
  100%{ transform: translate(40px,-30px); opacity:0; }
}

#heightGauge{
  position:absolute;
  left:12px;
  top:12px;

  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;

  width:auto;
  padding:10px 10px 12px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  border-radius:14px;
  backdrop-filter: blur(6px);
  pointer-events:none;
}

#heightGauge .hgValue{
  font-weight:900;
  font-size:16px;
  line-height:1;
}

#heightGauge .hgBar{
  width:10px;
  height:160px;
  background: rgba(255,255,255,.08);
  border-radius:999px;
  overflow:hidden;
}

#heightFill{
  width:100%;
  height:0%;
  background: rgba(255,204,102,.55);
  transition: height 900ms ease;
}

#heightGauge .hgText{ min-width:86px; }
#heightGauge .hgLabel{ font-size:12px; color:var(--muted); opacity:.85; }


.scene{ transition: background 1200ms ease; }

.scene[data-stage-major="0"]{
  background:
    radial-gradient(500px 280px at 50% 25%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(900px 500px at 30% 0%, rgba(91,124,255,.16), transparent 65%),
    rgba(10,15,32,.75);
}
.scene[data-stage-major="1"]{
  background:
    radial-gradient(520px 320px at 55% 22%, rgba(255,255,255,.12), transparent 60%),
    radial-gradient(900px 520px at 35% 0%, rgba(79,209,125,.12), transparent 65%),
    rgba(10,15,32,.75);
}
.scene[data-stage-major="2"]{
  background:
    radial-gradient(520px 360px at 55% 18%, rgba(255,255,255,.14), transparent 60%),
    radial-gradient(900px 520px at 35% 0%, rgba(255,204,102,.12), transparent 65%),
    rgba(10,15,32,.75);
}
.scene[data-stage-major="3"]{
  background:
    radial-gradient(540px 380px at 55% 14%, rgba(255,255,255,.16), transparent 60%),
    radial-gradient(900px 520px at 35% 0%, rgba(186,85,255,.12), transparent 65%),
    rgba(10,15,32,.75);
}

@keyframes sway{
  0%{ transform: translateX(0px) rotate(-1deg); }
  50%{ transform: translateX(2px) rotate(1deg); }
  100%{ transform: translateX(0px) rotate(-1deg); }
}

.scene{
  position: relative;
  overflow: hidden;
}

.glow, #weatherLayer, #dayNightLayer, #groundLayer, #decorLayer, #tree{
  will-change: transform;
  transition: transform 180ms ease;
}

#treeSway{
  width: 100%;
  height: 100%;
  transform-origin: 50% 95%;
}

@keyframes swayRot{
  0%{ transform: rotate(-1deg); }
  50%{ transform: rotate(1deg); }
  100%{ transform: rotate(-1deg); }
}

/* ===== HUD TOP ===== */
.hudTop{
  margin-bottom: 10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.hudRow{
  display:flex;
  gap:10px;
}

.pill{
  flex:1;
  border:1px solid var(--line);
  background: rgba(15,23,48,.55);
  border-radius:16px;
  padding:10px;
  backdrop-filter: blur(8px);
}

.pillK{
  font-size:12px;
  color: var(--muted);
  opacity:.85;
  font-weight:800;
}

.pillV{
  font-weight:900;
  font-size:16px;
  margin-top:2px;
}

.pillBar{
  height:10px;
  border-radius:999px;
  background: rgba(255,255,255,.08);
  overflow:hidden;
  margin-top:8px;
}

/* –º–∞–ª–µ–Ω—å–∫–∏–µ (16-18) */
.pillSmall{
  flex:1;
  border:1px solid var(--line);
  background: rgba(15,23,48,.45);
  border-radius:999px;
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  font-weight:900;
}

/* ===== RIGHT ACTIONS ===== */
.hudRight{
  position:absolute;
  right:12px;
  bottom:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:5;
}

.iconBtn{
  width:52px;
  height:52px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(15,23,48,.55);
  display:grid;
  place-items:center;
}

/* ===== MEDITATION ORB (10) ===== */
.meditateOrb{
  position:absolute;
  left:50%;
  top:44%;
  transform: translate(-50%,-50%);
  width:56px;
  height:56px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.10);
  color: var(--text);
  font-size:22px;
  display:grid;
  place-items:center;
  backdrop-filter: blur(8px);
  z-index:4;
}

#bgLayer{
  position:absolute;
  inset:-40px;               /* –∑–∞–ø–∞—Å, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–¥–≤–∏–≥–µ –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç—ã—Ö –∫—Ä–∞—ë–≤ */
  background-size: cover;
  background-position: center;
  background-repeat:no-repeat;
  transform: translate3d(0,0,0) scale(1.06);
  transition: background-image .8s ease, filter .8s ease;
  will-change: transform;
  z-index: 0;
}

/* —á—Ç–æ–±—ã –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –±—ã–ª–æ –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ */
.scene > *:not(#bgLayer){
  z-index: 1;
}

button{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

.btnIcon{
  width:22px;
  height:22px;
  object-fit:contain;
  pointer-events:none;
}

#btnShop{ background: transparent; }
    
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div>
        <div class="title">üå≥ –î—É—Ö –î–µ—Ä–µ–≤–∞ (MVP)</div>
      </div>
      <button class="btnDanger" id="btnReset" type="button">–°–±—Ä–æ—Å</button>
    </header>

    <div class="wrap">

  <!-- QUIZ -->
  <div class="quiz" id="quiz">
    <div class="qTitle">üå≥ –í—ã–±–æ—Ä –î—É—Ö–∞ –î–µ—Ä–µ–≤–∞</div>
    <div class="qSub">–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 4 –≤–æ–ø—Ä–æ—Å–∞, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –¥–µ—Ä–µ–≤–æ.</div>

    <div class="qCard">
      <div class="qQuestion">1) –ì–¥–µ –≤–∞—à–µ–º—É –î—É—Ö—É —Å–ø–æ–∫–æ–π–Ω–µ–µ?</div>
      <div class="qOptions">
        <button class="qOpt" type="button" data-q="q1" data-a="forest">
          <span class="qOptImg"><img data-img="forest" alt=""></span>
          <span class="qOptText"><b>–í –≥—É—Å—Ç–æ–º –ª–µ—Å—É</b><small>—Ç–µ–Ω—å, —Ç–∏—à–∏–Ω–∞</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q1" data-a="meadow">
          <span class="qOptImg"><img data-img="meadow" alt=""></span>
          <span class="qOptText"><b>–ù–∞ –ø–æ–ª—è–Ω–µ</b><small>–ø—Ä–æ—Å—Ç–æ—Ä, —Å–≤–µ—Ç</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q1" data-a="water">
          <span class="qOptImg"><img data-img="water" alt=""></span>
          <span class="qOptText"><b>–£ –≤–æ–¥—ã</b><small>–¥–≤–∏–∂–µ–Ω–∏–µ, –≥–ª—É–±–∏–Ω–∞</small></span>
        </button>
      </div>
    </div>

    <div class="qCard">
      <div class="qQuestion">2) –ö–æ–≥–¥–∞ –≤—Å—ë –ø–æ—à–ª–æ –Ω–µ –ø–æ –ø–ª–∞–Ω—É, –≤—ã‚Ä¶</div>
      <div class="qOptions">
        <button class="qOpt" type="button" data-q="q2" data-a="rock">
          <span class="qOptImg"><img data-img="rock" alt=""></span>
          <span class="qOptText"><b>–°—Ç–æ–∏—Ç–µ –∫–∞–∫ —Å–∫–∞–ª–∞</b><small>—É–ø—Ä—è–º—Å—Ç–≤–æ</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q2" data-a="adapt">
          <span class="qOptImg"><img data-img="adapt" alt=""></span>
          <span class="qOptText"><b>–ì–Ω—ë—Ç–µ—Å—å, –º–µ–Ω—è–µ—Ç–µ—Å—å, –Ω–æ –≤—ã–∂–∏–≤–∞–µ—Ç–µ</b><small>–∞–¥–∞–ø—Ç–∞—Ü–∏—è</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q2" data-a="wait">
          <span class="qOptImg"><img data-img="wait" alt=""></span>
          <span class="qOptText"><b>–ü–µ—Ä–µ–∂–∏–¥–∞–µ—Ç–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ—Å—å</b><small>–≤—ã–¥–µ—Ä–∂–∫–∞</small></span>
        </button>
      </div>
    </div>

    <div class="qCard">
      <div class="qQuestion">3) –í–∞—à –≥–ª–∞–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π</div>
      <div class="qOptions">
        <button class="qOpt" type="button" data-q="q3" data-a="wise">
          <span class="qOptImg"><img data-img="wise" alt=""></span>
          <span class="qOptText"><b>–ú—É–¥—Ä–æ—Å—Ç—å –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ</b></span>
        </button>

        <button class="qOpt" type="button" data-q="q3" data-a="drive">
          <span class="qOptImg"><img data-img="drive" alt=""></span>
          <span class="qOptText"><b>–≠–Ω–µ—Ä–≥–∏—è –∏ –¥–≤–∏–∂–µ–Ω–∏–µ</b></span>
        </button>

        <button class="qOpt" type="button" data-q="q3" data-a="care">
          <span class="qOptImg"><img data-img="care" alt=""></span>
          <span class="qOptText"><b>–ù–µ–∂–Ω–æ—Å—Ç—å –∏ –∑–∞–±–æ—Ç–∞</b></span>
        </button>

        <button class="qOpt" type="button" data-q="q3" data-a="magic">
          <span class="qOptImg"><img data-img="magic" alt=""></span>
          <span class="qOptText"><b>–¢–∞–π–Ω–∞ –∏ –º–∞–≥–∏—è</b></span>
        </button>
      </div>
    </div>

    <div class="qCard">
      <div class="qQuestion">4) –õ—é–±–∏–º–æ–µ –≤—Ä–µ–º—è –≥–æ–¥–∞</div>
      <div class="qOptions">
        <button class="qOpt" type="button" data-q="q4" data-a="winter">
          <span class="qOptImg"><img data-img="winter" alt=""></span>
          <span class="qOptText"><b>–ó–∏–º–∞</b><small>—è—Å–Ω–æ—Å—Ç—å –∏ —Ç–∏—à–∏–Ω–∞</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q4" data-a="spring">
          <span class="qOptImg"><img data-img="spring" alt=""></span>
          <span class="qOptText"><b>–í–µ—Å–Ω–∞</b><small>–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q4" data-a="summer">
          <span class="qOptImg"><img data-img="summer" alt=""></span>
          <span class="qOptText"><b>–õ–µ—Ç–æ</b><small>—è—Ä–∫–æ—Å—Ç—å</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q4" data-a="autumn">
          <span class="qOptImg"><img data-img="autumn" alt=""></span>
          <span class="qOptText"><b>–û—Å–µ–Ω—å</b><small>–º—è–≥–∫–∞—è –≥–ª—É–±–∏–Ω–∞</small></span>
        </button>
      </div>
    </div>
    
      <div class="quizFooter">
    <span class="pill" id="quizProgress">0/4</span>
    <button id="btnQuizReset" type="button" class="btnDanger">–°–±—Ä–æ—Å–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
  </div>
   </div>

  <!-- RESULT -->
  <div class="result" id="result">
    <div class="rTitle">üåø –í–∞—à –î—É—Ö –î–µ—Ä–µ–≤–∞</div>
    <div class="rSub">–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ä–µ–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—á–µ—Ç—Å—è –≤—ã—Ä–∞—â–∏–≤–∞—Ç—å.</div>

    <div class="rGrid" id="resultGrid"></div>

    <div class="rActions">
      <button id="btnResultBack" type="button">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–µ—Å—Ç—É</button>
    </div>
  </div>
  
   <!--shop-->
   <div class="decor" id="decor" style="display:none; border:1px solid var(--line); background: rgba(15,23,48,.55); border-radius:16px; padding:12px; margin-bottom:12px;">
  <div class="rTitle">ü™µ –£–∫—Ä–∞—à–µ–Ω–∏—è</div>
  <div class="rSub">–°–¥–µ–ª–∞–π—Ç–µ –º–µ—Å—Ç–æ —É—é—Ç–Ω–µ–µ. –ü–æ–∫—É–ø–∫–∞ –∑–∞ –ª–∏—Å—Ç—å—è.</div>

  <div class="rGrid" id="decorGrid"></div>

  <div class="rActions">
    <button id="btnDecorBack" type="button">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
</div>

 <!-- TOP HUD (1-4 + 16-18) -->
<div class="hudTop" id="hudTop">
  <div class="hudRow">
    <!-- 1 XP -->
    <div class="pill">
      <div class="pillK">XP</div>
      <div class="pillV" id="xpTextMini">‚Äî</div>
      <div class="pillBar"><div id="xpBar"></div></div>
    </div>

    <!-- 2 HP -->
    <div class="pill">
      <div class="pillK">HP</div>
      <div class="pillV" id="healthText">‚Äî</div>
      <div class="pillBar"><div id="healthBar"></div></div>
    </div>

    <!-- 3 Bugs -->
    <div class="pill">
      <div class="pillK">Bugs</div>
      <div class="pillV" id="pestsText">‚Äî</div>
      <div class="pillBar"><div id="pestsBar"></div></div>
    </div>

    <!-- 4 Water -->
    <div class="pill">
      <div class="pillK">Water</div>
      <div class="pillV" id="waterText">‚Äî</div>
      <div class="pillBar"><div id="waterBar"></div></div>
    </div>
  </div>

  <div class="hudRow">
    <!-- 16 Fruits -->
    <div class="pillSmall">
      <span class="pillK">üçé</span>
      <span class="pillV" id="invFruits">0</span>
    </div>

    <!-- 17 Essence -->
    <div class="pillSmall">
      <span class="pillK">‚ú®</span>
      <span class="pillV" id="invEssence">0</span>
    </div>

    <!-- 18 Leaves -->
    <div class="pillSmall">
      <span class="pillK">üçÉ</span>
      <span class="pillV" id="invLeaves">0</span>
    </div>
  </div>
</div>
 
 <!-- MAIN SCENE -->
    <div class="scene" id="scene">
        <div id="bgLayer"></div>
  <div class="glow"></div>
  <div id="weatherLayer" style="position:absolute; inset:0; pointer-events:none;"></div>
  <div id="heightGauge">
  <div id="heightBig" class="hgValue">‚Äî</div>
  <div class="hgBar">
    <div id="heightFill"></div>
  </div>
</div>
  <div class="tree" id="tree">
  <div id="treeSway">
    <img id="treeImg" alt="" style="width:120px;height:120px;object-fit:contain;">
    <button id="btnMeditate" class="meditateOrb" type="button" title="Meditation">‚òÄÔ∏è</button>
  </div>
</div>
  <div id="dayNightLayer" style="position:absolute; inset:0; pointer-events:none;"></div>

  <div id="groundLayer" style="position:absolute; left:0; right:0; bottom:0; height:64px; pointer-events:none;"></div>

  <div id="groundCounter" style="position:absolute; left:12px; bottom:10px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(0,0,0,.22); color: var(--text); font-size:12px; font-weight:800; display:none;">
    üçÉ <span id="groundCount">0</span>
  </div>
  <div id="decorLayer" style="position:absolute; inset:0; pointer-events:none;"></div>
  
  <!-- RIGHT ACTIONS (7-9 + 20) -->
<div class="hudRight" id="hudRight">
  <button id="btnClean" type="button">
  <img src="icons/bugs.png" class="btnIcon" alt="">
</button>
  <button id="btnWater" type="button">
  <img src="icons/water.png" class="btnIcon" alt="">
</button>
 <button id="btnCollect" type="button">
  <img src="icons/leaves.png" class="btnIcon" alt="">
</button>
 <button class="iconBtn" id="btnShop" type="button" title="Shop">
  <img src="icons/shop.png" class="btnIcon" alt="">
</button>
</div>
</div>
      
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
      
      
    // =========================
    // 1) –£—Ç–∏–ª–∏—Ç—ã
    // =========================
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    let worldStarted = false;
    const nowMs = () => Date.now();

    function isNightByLocalTime(){
      const h = new Date().getHours();
      return (h >= 20 || h < 7); // –Ω–æ—á—å 20:00-07:00
    }
    
    function heightMetersByLevel(level){
  const base = 0.03; // 3 —Å–º –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
  return +(base * Math.pow(1.65, level)).toFixed(2);
}

function fmtLeft(ms){
  if(ms <= 0) return "–Ω–µ—Ç";
  const m = Math.ceil(ms / 60000);
  const h = Math.floor(m / 60);
  const mm = m % 60;
  if(h <= 0) return `${mm}–º`;
  return `${h}—á ${mm}–º`;
}

function setupParallax(){
  const scene = document.getElementById("scene");
  if(!scene) return;

  const glow = scene.querySelector(".glow");
  const weather = document.getElementById("weatherLayer");
  const night = document.getElementById("dayNightLayer");
  const ground = document.getElementById("groundLayer");
  const decor = document.getElementById("decorLayer");
  const tree = document.getElementById("tree");

  let tx = 0, ty = 0; // target (-1..1)
  let x = 0, y = 0;   // current
  let raf = 0;

  function apply(){
    raf = 0;

    // —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
    x += (tx - x) * 0.18;
    y += (ty - y) * 0.18;

    // —Å–ª–æ–∏ (—É –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –Ω–µ—Ç –±–∞–∑–æ–≤–æ–≥–æ translate)
    if(weather) weather.style.transform = `translate(${x*14}px, ${y*14}px)`;
    if(night)   night.style.transform   = `translate(${x*6}px,  ${y*6}px)`;
    if(ground)  ground.style.transform  = `translate(${x*4}px,  ${y*2}px)`;
    if(decor)   decor.style.transform   = `translate(${x*8}px,  ${y*5}px)`;

    // –í–ê–ñ–ù–û: glow –∏ tree —Ü–µ–Ω—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ translate(-50%, -50%) ‚Äî –µ–≥–æ –Ω–µ–ª—å–∑—è —Ç–µ—Ä—è—Ç—å
    if(glow) glow.style.transform = `translate(-50%, -50%) translate(${x*10}px, ${y*10}px)`;
    if(tree) tree.style.transform = `translate(-50%, -50%) translate(${x*3}px,  ${y*2}px)`;

    if(Math.abs(tx-x) > 0.002 || Math.abs(ty-y) > 0.002){
      raf = requestAnimationFrame(apply);
    }
  }

  function setTargetFromEvent(e){
    const r = scene.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;

    const px = (e.clientX - cx) / (r.width/2);
    const py = (e.clientY - cy) / (r.height/2);

    tx = Math.max(-1, Math.min(1, px));
    ty = Math.max(-1, Math.min(1, py));

    if(!raf) raf = requestAnimationFrame(apply);
  }

  function resetTarget(){
    tx = 0; ty = 0;
    if(!raf) raf = requestAnimationFrame(apply);
  }

  scene.addEventListener("pointermove", setTargetFromEvent);

  // –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö ‚Äú–∑–∞–ª–∏–ø–∞–µ—Ç‚Äù, –µ—Å–ª–∏ –ø–∞–ª–µ—Ü –æ—Ç–ø—É—Å—Ç–∏–ª–∏ –≤ —É–≥–ª—É
  scene.addEventListener("pointerup", resetTarget);
  scene.addEventListener("pointercancel", resetTarget);
  scene.addEventListener("pointerleave", resetTarget);

  // —á—Ç–æ–±—ã —Å–æ–±—ã—Ç–∏—è —à–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ
  try { scene.style.touchAction = "none"; } catch(e){}
}

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function yesterdayKey(){
  const d = new Date(Date.now() - 86400000);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

    // =========================
    // 2) –î–∞–Ω–Ω—ã–µ (—Å—Ç–∞–¥–∏–∏)
    // =========================
    const STAGES = [
       
      { name:"–°–µ–º–µ—á–∫–æ", icon:"üå∞", xpToNext:120 },
      { name:"–†–æ—Å—Ç–æ–∫",  icon:"üå±", xpToNext:220 },
      { name:"–ú–æ–ª–æ–¥–æ–µ", icon:"üåø", xpToNext:420 },
      { name:"–î–µ—Ä–µ–≤–æ",  icon:"üå≥", xpToNext:700 },
    ];
    
    function svgData(svg){
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg.trim());
}

const simpleIcon = (label) => svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
    <rect width="128" height="128" rx="18" fill="#1b2a55"/>
    <circle cx="64" cy="64" r="34" fill="rgba(255,255,255,.18)"/>
    <text x="64" y="72" text-anchor="middle" fill="rgba(255,255,255,.65)"
      font-size="16" font-family="system-ui">${label}</text>
  </svg>
`);

// –ü—Ä–æ—Å—Ç–æ–π hand-drawn —Å—Ç–∏–ª—å: –º—è–≥–∫–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã + ‚Äú—á–µ—Ä–Ω–∏–ª—å–Ω–∞—è‚Äù –ª–∏–Ω–∏—è
const IMG = {
  forest: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
      <rect width="128" height="128" rx="18" fill="#1b2a55"/>
      <circle cx="42" cy="44" r="26" fill="#49d17d" opacity=".22"/>
      <circle cx="80" cy="52" r="30" fill="#7aa2ff" opacity=".18"/>
      <path d="M20 96c22-22 36-18 56-8 18 9 26 6 32-2" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="4" stroke-linecap="round"/>
      <path d="M18 98c24-24 40-20 60-10 18 9 28 6 34-2" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="2" stroke-linecap="round"/>
      <text x="18" y="32" fill="rgba(255,255,255,.65)" font-size="14" font-family="system-ui">–ª–µ—Å</text>
    </svg>
  `),
  meadow: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
      <rect width="128" height="128" rx="18" fill="#23356b"/>
      <circle cx="88" cy="34" r="22" fill="#ffcc66" opacity=".35"/>
      <path d="M10 88c26-10 48-10 68 0 18 9 28 10 40 4" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="4" stroke-linecap="round"/>
      <path d="M10 92c28-12 52-12 72 0 18 10 28 10 38 4" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="2" stroke-linecap="round"/>
      <text x="14" y="32" fill="rgba(255,255,255,.65)" font-size="14" font-family="system-ui">–ø–æ–ª—è–Ω–∞</text>
    </svg>
  `),
  water: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
      <rect width="128" height="128" rx="18" fill="#1b2a55"/>
      <path d="M14 78c16-10 30-10 46 0 16 10 32 10 54 0" fill="none" stroke="rgba(122,162,255,.55)" stroke-width="6" stroke-linecap="round"/>
      <path d="M14 88c16-10 30-10 46 0 16 10 32 10 54 0" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="4" stroke-linecap="round"/>
      <text x="14" y="32" fill="rgba(255,255,255,.65)" font-size="14" font-family="system-ui">–≤–æ–¥–∞</text>
    </svg>
  `),

  oak: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#7aa2ff" stop-opacity=".15"/>
          <stop offset="1" stop-color="#49d17d" stop-opacity=".10"/>
        </linearGradient>
      </defs>
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <rect x="18" y="18" width="220" height="220" rx="22" fill="url(#g)" opacity=".9"/>
      <path d="M130 182c0-32 3-44 16-64 8-12 8-24-6-38-18-18-56-8-62 20-4 18 8 34 24 38"
        fill="none" stroke="rgba(0,0,0,.25)" stroke-width="10" stroke-linecap="round"/>
      <path d="M128 186c0-36 4-50 18-72 10-16 10-30-8-46-22-20-66-10-74 24-6 24 10 44 28 50"
        fill="none" stroke="rgba(255,255,255,.35)" stroke-width="8" stroke-linecap="round"/>
      <circle cx="132" cy="84" r="54" fill="rgba(73,209,125,.22)"/>
      <circle cx="96" cy="98" r="34" fill="rgba(255,204,102,.14)"/>
      <circle cx="166" cy="104" r="38" fill="rgba(122,162,255,.16)"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–î—É–±</text>
    </svg>
  `),

  birch: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <circle cx="170" cy="70" r="46" fill="rgba(255,204,102,.16)"/>
      <circle cx="96" cy="98" r="58" fill="rgba(73,209,125,.18)"/>
      <path d="M128 210c-6-56 2-92 22-130" fill="none" stroke="rgba(255,255,255,.45)" stroke-width="10" stroke-linecap="round"/>
      <path d="M126 210c-8-58 0-98 18-134" fill="none" stroke="rgba(0,0,0,.22)" stroke-width="6" stroke-linecap="round"/>
      <path d="M142 120l10-6M138 144l12-6M134 166l10-6" stroke="rgba(0,0,0,.25)" stroke-width="6" stroke-linecap="round"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ë–µ—Ä—ë–∑–∞</text>
    </svg>
  `),

  willow: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <path d="M60 188c18-18 38-30 72-30 34 0 52 10 68 22" fill="none" stroke="rgba(122,162,255,.35)" stroke-width="10" stroke-linecap="round"/>
      <circle cx="132" cy="88" r="58" fill="rgba(122,162,255,.18)"/>
      <path d="M124 210c0-54 2-78 16-110" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="8" stroke-linecap="round"/>
      <path d="M108 110c8 30 6 56-10 90M156 110c-10 30-8 56 6 90" fill="none" stroke="rgba(73,209,125,.18)" stroke-width="8" stroke-linecap="round"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ò–≤–∞</text>
    </svg>
  `),

  spruce: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <circle cx="190" cy="62" r="42" fill="rgba(140,120,255,.16)"/>
      <path d="M128 48l54 74H74l54-74Z" fill="rgba(73,209,125,.16)" stroke="rgba(255,255,255,.25)" stroke-width="6" stroke-linejoin="round"/>
      <path d="M128 94l68 88H60l68-88Z" fill="rgba(73,209,125,.12)" stroke="rgba(255,255,255,.20)" stroke-width="6" stroke-linejoin="round"/>
      <path d="M128 206v-26" stroke="rgba(255,255,255,.35)" stroke-width="10" stroke-linecap="round"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ï–ª—å</text>
    </svg>
  `),

  rowan: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <circle cx="120" cy="90" r="58" fill="rgba(73,209,125,.14)"/>
      <circle cx="170" cy="100" r="40" fill="rgba(255,204,102,.12)"/>
      <path d="M128 210c0-58 6-92 22-130" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="8" stroke-linecap="round"/>
      <g fill="rgba(255,107,107,.55)">
        <circle cx="156" cy="130" r="6"/><circle cx="172" cy="146" r="6"/><circle cx="142" cy="152" r="6"/>
      </g>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–†—è–±–∏–Ω–∞</text>
    </svg>
  `),

  palm: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <circle cx="190" cy="64" r="42" fill="rgba(255,204,102,.18)"/>
      <path d="M132 212c-8-56-4-100 20-146" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="8" stroke-linecap="round"/>
      <path d="M152 70c18 6 34 14 44 26M152 70c-20 6-36 14-48 26M152 70c12-18 22-28 36-34M152 70c-12-18-22-28-36-34"
        fill="none" stroke="rgba(73,209,125,.18)" stroke-width="8" stroke-linecap="round"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ü–∞–ª—å–º–∞</text>
    </svg>
  `),
  rock: svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
    <rect width="128" height="128" rx="18" fill="#23356b"/>
    <circle cx="64" cy="68" r="26" fill="rgba(255,255,255,.18)"/>
  </svg>
`),

adapt: svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
    <rect width="128" height="128" rx="18" fill="#1b2a55"/>
    <path d="M20 80c20-20 40-20 60 0" stroke="rgba(73,209,125,.45)" stroke-width="6" fill="none"/>
  </svg>
`),

wait: svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
    <rect width="128" height="128" rx="18" fill="#121c33"/>
    <circle cx="90" cy="36" r="14" fill="rgba(140,120,255,.45)"/>
  </svg>
`),

seed: svgData(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <rect width="256" height="256" rx="28" fill="#121c33"/>
  <circle cx="128" cy="132" r="44" fill="rgba(255,204,102,.18)"/>
  <path d="M92 156c24 18 48 18 72 0" fill="none" stroke="rgba(255,255,255,.28)" stroke-width="8" stroke-linecap="round"/>
  <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–°–µ–º–µ—á–∫–æ</text>
</svg>`),

sprout: svgData(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <rect width="256" height="256" rx="28" fill="#121c33"/>
  <path d="M128 200v-58" stroke="rgba(255,255,255,.35)" stroke-width="10" stroke-linecap="round"/>
  <path d="M128 144c-26 0-42-14-50-34 24-2 44 6 50 24M128 144c26 0 42-14 50-34-24-2-44 6-50 24"
    fill="rgba(73,209,125,.16)" stroke="rgba(255,255,255,.18)" stroke-width="6" stroke-linejoin="round"/>
  <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–†–æ—Å—Ç–æ–∫</text>
</svg>`),

young: svgData(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <rect width="256" height="256" rx="28" fill="#121c33"/>
  <circle cx="128" cy="104" r="58" fill="rgba(73,209,125,.16)"/>
  <path d="M128 210c0-50 2-78 10-110" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="10" stroke-linecap="round"/>
  <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ú–æ–ª–æ–¥–æ–µ</text>
</svg>`),

wise:  simpleIcon("–º–∏—Ä"),
drive: simpleIcon("—ç–Ω"),
care:  simpleIcon("–¥–æ–±"),
magic: simpleIcon("–º–∞–≥"),
winter: simpleIcon("–∑–∏–º"),
spring: simpleIcon("–≤–µ—Å"),
summer: simpleIcon("–ª–µ—Ç"),
autumn: simpleIcon("–æ—Å"),
  
};
    
    // =========================
// 2.1) –î–µ—Ä–µ–≤—å—è: –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
// =========================
// –ß–µ–º –º–µ–Ω—å—à–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å, —Ç–µ–º —Å–ª–∞–±–µ–µ —ç—Ñ—Ñ–µ–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä pestsMul < 1 = –∂—É–∫–∏ —Ä–∞—Å—Ç—É—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
const TREES = {
  oak: {
    name: "–î—É–±",
    icon: "üå≥",
    img: IMG.oak,
    imgsByLevel: [
    "assets/trees/oak/seed_1.png", // Stage 0.1
      "assets/trees/oak/seed_2.png", // Stage 0.2
      "assets/trees/oak/seed_3.png"  // Stage 0.3
],
    desc: "–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Å—Ç—Ä–∞–∂. –ñ–∏–≤—É—á–∏–π, –Ω–æ —Ä–∞—Å—Ç—ë—Ç —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ.",
    mods: { xpMul: 0.90, waterDecayMul: 0.95, pestsMul: 0.85, nightXpMul: 1.00 }
  },
  birch: {
    name: "–ë–µ—Ä—ë–∑–∞",
    icon: "üåø",
    img: IMG.birch,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–ß–∏—Å—Ç–æ—Ç–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. –ë—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –Ω–æ—Ä–º—É, –Ω–æ –∂—É–∫–∏ –∑–ª–µ–µ.",
    mods: { xpMul: 1.00, waterDecayMul: 1.00, pestsMul: 1.10, nightXpMul: 1.00, healthRecoverMul: 1.35 }
  },
  willow: {
    name: "–ò–≤–∞",
    icon: "üåæ",
    img: IMG.willow,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–í–æ–¥–Ω–∞—è –º–∞–≥–∏—è. –ü–æ–ª–∏–≤ –º–æ—â–Ω–µ–µ, –¥—Ä—É–∂–∏—Ç —Å –¥–æ–∂–¥—ë–º (–ø–æ–∑–∂–µ).",
    mods: { xpMul: 1.00, waterDecayMul: 1.05, pestsMul: 1.00, nightXpMul: 1.00, waterActionMul: 1.20 }
  },
  spruce: {
    name: "–ï–ª—å",
    icon: "üå≤",
    img: IMG.spruce,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–ù–æ—á–Ω–æ–π —Å—Ç—Ä–∞–∂. –õ—É—á—à–µ —Ä–∞—Å—Ç—ë—Ç –Ω–æ—á—å—é, –ª–µ–≥—á–µ —Ç–µ—Ä–ø–∏—Ç –ø–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è.",
    mods: { xpMul: 0.98, waterDecayMul: 0.95, pestsMul: 0.95, nightXpMul: 1.18 }
  },
  rowan: {
    name: "–†—è–±–∏–Ω–∞",
    icon: "üçÇ",
    img: IMG.rowan,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–ó–∞—â–∏—Ç–Ω–∏—Ü–∞. –ß—É—Ç—å —Å–ª–∞–±–µ–µ –∂—É–∫–∏ –∏ –∏–Ω–æ–≥–¥–∞ —Ä–µ–¥–∫–∏–µ –ø–ª–æ–¥—ã.",
    mods: { xpMul: 1.00, waterDecayMul: 1.00, pestsMul: 0.90, nightXpMul: 1.00, rareFruitChance: 0.08 }
  },
  palm: {
    name: "–ü–∞–ª—å–º–∞",
    icon: "üå¥",
    img: IMG.palm,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–°–≤–æ–±–æ–¥–∞ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å. –ë—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç—ë—Ç –∏ –¥–∞—ë—Ç –ø–ª–æ–¥—ã, –Ω–æ —Ö—Ä—É–ø—á–µ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º.",
    mods: { xpMul: 1.12, waterDecayMul: 1.08, pestsMul: 1.05, nightXpMul: 1.00, healthBadDecayMul: 1.15, fruitMul: 1.20 }
  }
};

const DECOR_ITEMS = [
  { id:"lantern", name:"–§–æ–Ω–∞—Ä—å", desc:"–ù–æ—á—å—é –º—è–≥–∫–æ —Å–≤–µ—Ç–∏—Ç—Å—è.", cost: 25 },
  { id:"fence", name:"–ó–∞–±–æ—Ä—á–∏–∫", desc:"–£—é—Ç–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–∞.", cost: 35 },
];

const GROWTH_XP_THRESHOLDS = [
  0,    // L0
  30,   // L1
  80,   // L2
  160,  // L3
  280,  // L4
  450,  // L5
  700,  // L6
  1050, // L7
  1500, // L8
  2100, // L9
  3000, // L10
];

function progressToNextGrowth(xp){
  const t = GROWTH_XP_THRESHOLDS;
  const lvl = calcGrowthLevel(xp);
  const cur = t[lvl] ?? 0;
  const next = t[Math.min(lvl + 1, t.length - 1)] ?? cur;

  const span = Math.max(1, next - cur);
  const into = clamp(xp - cur, 0, span);
  const pct = Math.round((into / span) * 100);

  return { lvl, pct, into, span, next };
}

function prettyStageText(level){
  const info = growthInfo(level);
  const maxMinor = (info.major === 3) ? 2 : 3; // –≤–∑—Ä–æ—Å–ª–æ–µ 2 –ø–æ–¥—Å—Ç—É–ø–µ–Ω–∏, –æ—Å—Ç–∞–ª—å–Ω—ã–µ 3
  return `${info.label} ‚Ä¢ ${info.minor + 1}/${maxMinor}`;
}

// =========================
// 2.2) Quiz: —Å–∏—Å—Ç–µ–º–∞ –æ—á–∫–æ–≤
// =========================
function emptyScores(){
  return { oak:0, birch:0, willow:0, spruce:0, rowan:0, palm:0 };
}

function addScore(scores, keys, n=1){
  keys.forEach(k => scores[k] = (scores[k]||0) + n);
}

function pickTreeFromAnswers(ans){
  // ans = { q1:'forest', q2:'rock', q3:'wise', q4:'winter' }
  const s = emptyScores();

  // Q1: –º–µ—Å—Ç–æ
  if(ans.q1 === "forest") addScore(s, ["oak","spruce"]);
  if(ans.q1 === "meadow") addScore(s, ["birch","rowan"]);
  if(ans.q1 === "water")  addScore(s, ["willow","palm"]);

  // Q2: —Ä–µ–∞–∫—Ü–∏—è
  if(ans.q2 === "rock")  addScore(s, ["oak","spruce"]);
  if(ans.q2 === "adapt") addScore(s, ["willow","birch"]);
  if(ans.q2 === "wait")  addScore(s, ["spruce","rowan"]);

  // Q3: –≤–∞–π–±
  if(ans.q3 === "wise")  addScore(s, ["oak","spruce"]);
  if(ans.q3 === "drive") addScore(s, ["palm","birch"]);
  if(ans.q3 === "care")  addScore(s, ["birch","rowan"]);
  if(ans.q3 === "magic") addScore(s, ["spruce","willow"]);

  // Q4: —Å–µ–∑–æ–Ω
  if(ans.q4 === "winter") addScore(s, ["spruce","oak"]);
  if(ans.q4 === "spring") addScore(s, ["birch","willow"]);
  if(ans.q4 === "summer") addScore(s, ["palm","birch"]);
  if(ans.q4 === "autumn") addScore(s, ["rowan","willow"]);

  // –ø–æ–±–µ–¥–∏—Ç–µ–ª—å / –Ω–∏—á—å—è
  const entries = Object.entries(s).sort((a,b)=>b[1]-a[1]);
  const top = entries[0];
  const second = entries[1];
  const best = top[0];
  const bestScore = top[1];

  const tied = (second && second[1] === bestScore);
  if(tied){
    return { winner: null, options: [best, second[0]], scores: s };
  }
  return { winner: best, options: [best], scores: s };
}

    // =========================
    // 3) State + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    // =========================
    const KEY = "tree_spirit_state_v1";

    function defaultState(){
  return {
    groundLeaves: 0,
    weather: "sun",
    weatherUntil: 0,
    growthBuffUntil: 0,

    treeId: null,
    stage: 0,
    xp: 0,
    water: 70,
    health: 95,
    pests: 0,
    lastTick: nowMs(),
    growthLevel: 0,

    inventory: { leaves: 0, fruits: 0, essence: 0 },
    decor: { lantern: false, fence: false },
    daily: {
  lastMeditateDay: null,  // "YYYY-MM-DD"
  streak: 0,
  total: 0
},
  };
}

    function loadState(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        const s = JSON.parse(raw);
        // –º–∏–Ω–∏-–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å–ª—É—á–∞–π –º—É—Å–æ—Ä–∞
        if(typeof s !== "object" || s == null) return defaultState();
        return {
          ...defaultState(),
          ...s,
          inventory: { ...defaultState().inventory, ...(s.inventory||{}) }
        };
      }catch{
        return defaultState();
      }
    }

    function saveState(s){
  // –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ –æ–±—ä–µ–∫—Ç ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π state
  const target = s || state;
  if(!target) return; // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
  localStorage.setItem(KEY, JSON.stringify(target));
}

    // =========================
    // 4) –°–µ—Ä–¥—Ü–µ –∏–≥—Ä—ã: tick (–æ—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å)
    // =========================
    function tickTree(s, tNow){
      const dtMs = Math.max(0, tNow - (s.lastTick || tNow));
      const dtHours = dtMs / 3600000;
      const tree = s.treeId ? (TREES[s.treeId] || null) : null;
      
const mods = tree?.mods || {};
const w = s.weather || "sun";
const weatherXpMul = (w === "sun") ? 1.10 : 1.0;
const weatherWaterDecayMul = (w === "rain") ? 0.75 : 1.0;
const weatherPestsMul = (w === "fog") ? 0.75 : 1.0;
const xpMul = mods.xpMul ?? 1.0;
const waterDecayMul = mods.waterDecayMul ?? 1.0;
const pestsMul = mods.pestsMul ?? 1.0;
const nightXpMul = mods.nightXpMul ?? 1.0;
const healthRecoverMul = mods.healthRecoverMul ?? 1.0;
const healthBadDecayMul = mods.healthBadDecayMul ?? 1.0;
const fruitMul = mods.fruitMul ?? 1.0;

if(mods.rareFruitChance){
  const chance = mods.rareFruitChance * dtHours; // —à–∞–Ω—Å —Ä–∞—Å—Ç—ë—Ç —Å –≤—Ä–µ–º–µ–Ω–µ–º
  if(Math.random() < chance){
    s.inventory.fruits += 1;
  }
}

const night = isNightByLocalTime();
      if(dtHours <= 0.0001){
        s.lastTick = tNow;
        return { dtHours: 0, msg: "" };
      }

      // ---- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–ª–∞–Ω—Å–∞
      const waterDecayPerHour = 2.0;     // 48/—Å—É—Ç–∫–∏
      const pestsGrowthPerHour = 0.6;    // –∫–æ–≥–¥–∞ –ø–ª–æ—Ö–æ
      const pestsRecoverPerHour = 0.3;   // –∫–æ–≥–¥–∞ —Ö–æ—Ä–æ—à–æ
      const healthDecayPerHour = 0.8;    // —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∂–µ—Å—Ç–∏
      const healthRecoverPerHour = 0.2;  // –º—è–≥–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
      const baseXpPerHour = 10;          // —Ä–æ—Å—Ç –≤ –∏–¥–µ–∞–ª–µ

      // 1) –≤–æ–¥–∞ —É–±—ã–≤–∞–µ—Ç –≤—Å–µ–≥–¥–∞
     s.water = clamp(
  s.water - waterDecayPerHour * waterDecayMul * weatherWaterDecayMul * dtHours,
  0, 100
);

      // 2) –≤—Ä–µ–¥–∏—Ç–µ–ª–∏: —Ä–∞—Å—Ç—É—Ç –ø—Ä–∏ –ø–ª–æ—Ö–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö
      const badWater = (s.water < 25 || s.water > 95);
      if(badWater){
        s.pests = clamp(
  s.pests + pestsGrowthPerHour * pestsMul * weatherPestsMul * dtHours,
  0, 100
);
      }else{
        s.pests = clamp(s.pests - pestsRecoverPerHour * (2 - pestsMul) * dtHours, 0, 100);
      }

      // 3) –∑–¥–æ—Ä–æ–≤—å–µ: –ø–∞–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –ø–ª–æ—Ö–æ
      const veryBad = (s.water < 15 || s.pests > 70);
      if(veryBad){
        s.health = clamp(s.health - healthDecayPerHour * healthBadDecayMul * dtHours, 0, 100);
      }else{
        s.health = clamp(s.health + healthRecoverPerHour * healthRecoverMul * dtHours, 0, 100);
      }

      // 4) —Ñ–∞–∫—Ç–æ—Ä—ã —Ä–æ—Å—Ç–∞
      let waterFactor = 1.0;
      if(s.water >= 40 && s.water <= 80) waterFactor = 1.0;
      else if((s.water >= 20 && s.water < 40) || (s.water > 80 && s.water <= 95)) waterFactor = 0.6;
      else waterFactor = 0.2;

      let pestFactor = 1 - (s.pests / 120);
      pestFactor = clamp(pestFactor, 0.2, 1.0);

      const healthFactor = clamp(s.health / 100, 0, 1);

      // 5) –Ω–∞—á–∏—Å–ª—è–µ–º XP
      const buffActive = (s.growthBuffUntil || 0) > tNow;
const buffMul = buffActive ? 1.25 : 1.0;

const xpGain = baseXpPerHour
  * waterFactor
  * pestFactor
  * healthFactor
  * xpMul
  * (night ? nightXpMul : 1.0)
  * buffMul
  * weatherXpMul
  * dtHours;

s.xp += xpGain;

  const newLevel = calcGrowthLevel(s.xp);
if(newLevel > s.growthLevel){
  s.growthLevel = newLevel;
  // —ç—Ñ—Ñ–µ–∫—Ç –∞–ø–∞, –ª–æ–≥, —á–∞—Å—Ç–∏—Ü—ã
}
     
      // 6) –Ω–∞–≥—Ä–∞–¥—ã (–ø—Ä–æ—Å—Ç–µ–Ω—å–∫–æ)
      s.inventory.leaves += Math.floor(xpGain / 15);

      // 7) –∞–ø —Å—Ç–∞–¥–∏–π (–º–æ–∂–µ—Ç –∞–ø–Ω—É—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑)
      let leveledUp = 0;
      while(s.stage < STAGES.length - 1){
        const need = STAGES[s.stage].xpToNext;
        if(s.xp < need) break;
        s.xp -= need;
        s.stage += 1;
        leveledUp += 1;

        // –±–æ–Ω—É—Å—ã –∑–∞ –∞–ø
        s.inventory.fruits += Math.round((s.stage + 1) * fruitMul);
        s.inventory.essence += 1;
      }

      s.lastTick = tNow;

      let msg = "";
      if(leveledUp > 0) msg = `üåü –î–µ—Ä–µ–≤–æ –≤—ã—Ä–æ—Å–ª–æ –Ω–∞ ${leveledUp} —Å—Ç–∞–¥.!`;
      return { dtHours, msg };
    }

    // =========================
    // 5) UI
    // =========================
    const el = (id) => document.getElementById(id);

    function stageLabel(s){
  const lvl = s.growthLevel || 0;
  const info = growthInfo(lvl); // major/minor/label
  // major: 0..3, minor: 0..2 (–∏–ª–∏ 0..1 –Ω–∞ –≤–∑—Ä–æ—Å–ª–æ–º)
  return `${info.label} ${info.major+1}.${info.minor+1} (lvl ${lvl})`;
}

    function stageIcon(s){
      const st = STAGES[s.stage] || STAGES[0];
      return st.icon;
    }

    function xpProgress(s){
      const need = (STAGES[s.stage] || STAGES[0]).xpToNext;
      return clamp(s.xp / need, 0, 1);
    }

    function setBar(id, value01){
      el(id).style.width = `${Math.round(clamp(value01,0,1)*100)}%`;
    }

    function log(msg){
      el("log").textContent = msg || "";
    }

    
    
    function renderGround(s){
  const layer = document.getElementById("groundLayer");
  const counter = document.getElementById("groundCounter");
  const cntEl = document.getElementById("groundCount");
  const btn = document.getElementById("btnCollect");

  const n = s.groundLeaves || 0;

  // —Å—á—ë—Ç—á–∏–∫
  if(counter && cntEl){
    counter.style.display = n > 0 ? "" : "none";
    cntEl.textContent = String(n);
  }

  // –∫–Ω–æ–ø–∫–∞ —Å–±–æ—Ä–∞
  if(btn){
    btn.style.display = "";
  }

  // "–∫—É—á–∫–∞" –≤–∏–∑—É–∞–ª—å–Ω–æ: –º–∞–∫—Å–∏–º—É–º 14 –ª–∏—Å—Ç–∏–∫–æ–≤, –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–º
  if(layer){
    layer.innerHTML = "";
    const show = Math.min(n, 14);
    for(let i=0;i<show;i++){
      const d = document.createElement("div");
      d.textContent = "üçÉ";
      d.style.position = "absolute";
      d.style.left = (8 + Math.random()*84) + "%";
      d.style.bottom = (2 + Math.random()*18) + "px";
      d.style.opacity = "0.85";
      d.style.transform = `rotate(${Math.random()*120-60}deg)`;
      d.style.filter = "drop-shadow(0 6px 10px rgba(0,0,0,.18))";
      layer.appendChild(d);
    }
  }
}

function collectLeaves(){
  const n = state.groundLeaves || 0;
  if(n <= 0) return;

  state.inventory.leaves = (state.inventory.leaves || 0) + n;
  state.groundLeaves = 0;

  saveState(state);
  render(state);
  renderGround(state);
  log("–õ–∏—Å—Ç—å—è —Å–æ–±—Ä–∞–Ω—ã.");
}

   //—Ñ—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø–æ–≥–æ–¥—ã
   function pickWeather(){
  const r = Math.random();
  if(r < 0.35) return "sun";
  if(r < 0.60) return "rain";
  if(r < 0.80) return "fog";
  return "wind";
}

function ensureWeather(){
  const t = nowMs();
  if((state.weatherUntil || 0) > t) return;

  state.weather = pickWeather();
  const hours = 3 + Math.floor(Math.random()*4); // 3..6 —á–∞—Å–æ–≤
  state.weatherUntil = t + hours * 3600000;

  saveState(state);
  render(state);
}

function render(s){
  const scene = el("scene");
  if(scene){
    const night = isNightByLocalTime();

    // –¥–µ–Ω—å/–Ω–æ—á—å –∫–ª–∞—Å—Å—ã
    scene.classList.toggle("night", night);
    scene.classList.toggle("day", !night);

    // —Ñ–æ–Ω
    const bg = document.getElementById("bgLayer");
    if(bg){
      bg.style.backgroundImage = night
        ? 'url("assets/bg_night.png")'
        : 'url("assets/bg_day.png")';
    }
  }
    // —Ñ–æ–Ω –ø–æ —Å—Ç–∞–¥–∏–∏
    const info = growthInfo(s.growthLevel || 0);
    scene.dataset.stageMajor = String(info.major);

    // –ª—ë–≥–∫–∏–π "–∫–∞–º–µ—Ä–∞" —ç—Ñ—Ñ–µ–∫—Ç
    const lvlCam = s.growthLevel || 0;
    scene.style.paddingTop = (8 + lvlCam * 1.2) + "px";
    const swayEl = document.getElementById("treeSway");
if(swayEl){
  const w = s.weather || "sun";
  swayEl.style.animation = (w === "wind") ? "swayRot 3.2s ease-in-out infinite" : "";
}

  // –¥–µ—Ä–µ–≤–æ
const tree = s.treeId ? (TREES[s.treeId] || null) : null;
const img = document.getElementById("treeImg");

if (img) {
  const lvl = s.growthLevel || 0;

  // 1) –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ —Å—Ç–∞–¥–∏—è–º (—Å–µ–º–µ—á–∫–∞ 0..2, —Ä–æ—Å—Ç–æ–∫ –∏ —Ç.–¥.)
  const byStage = tree?.imgsByStage || null;
  if (tree && byStage && byStage.length) {
    const stage = s.stage || 0;
    const idx = Math.max(0, Math.min(byStage.length - 1, stage));
    img.src = byStage[idx];
  } else {
    // 2) –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º (0..10)
    const byLevel = tree?.imgsByLevel || null;
    if (tree && byLevel && byLevel.length) {
      const idx = Math.max(0, Math.min(byLevel.length - 1, lvl));
      img.src = byLevel[idx];
    } else {
      // 3) –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
      img.src = tree?.img || "";
    }
  }

  // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç
  const scale = 1 + lvl * 0.055;
  const lift  = -lvl * 5;

  img.style.transform = `translateY(${lift}px) scale(${scale})`;
  img.style.transformOrigin = "50% 90%";
  img.style.transition = "transform 900ms ease";
}

  // glow
  const glow = document.querySelector(".glow");
  if(glow){
    const lvl = s.growthLevel || 0;
    glow.style.transform = `translateY(${Math.max(0, lvl * 2)}px) scale(${1 + lvl * 0.02})`;
    glow.style.transition = "transform 900ms ease";
  }

  // —Ç–µ–∫—Å—Ç—ã (—Ç—É—Ç –ª—É—á—à–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–≤–æ—é stageLabel –∫–∞–∫ –µ—Å—Ç—å)
  const st = el("stageText");
  if(st) st.textContent = stageLabel(s);

  const wt = el("waterText");
  if(wt) wt.textContent = `${Math.round(s.water)}/100`;

  const ht = el("healthText");
  if(ht) ht.textContent = `${Math.round(s.health)}`;

  const pt = el("pestsText");
  if(pt) pt.textContent = `${Math.round(s.pests)}`;

  // –±–∞—Ä—ã (–µ—Å–ª–∏ setBar —É —Ç–µ–±—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç 0..1)
  if(typeof setBar === "function"){
    setBar("waterBar",  s.water / 100);
    setBar("healthBar", s.health / 100);
    setBar("pestsBar",  1 - (s.pests / 100));

    // XP –±–∞—Ä: —É–±–µ–¥–∏—Å—å, —á—Ç–æ xpProgress –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ 0..1.
    // –ï—Å–ª–∏ xpProgress –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç/–ø—Ä–æ—Ü–µ–Ω—Ç—ã ‚Äî —ç—Ç–æ –ª–æ–º–∞–µ—Ç.
    // –°–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
    // setBar("xpBar", 0);
    try{
      const xp = xpProgress(s);   // –æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ —É —Ç–µ–±—è
      setBar("xpBar", xp);
    }catch(e){
      // —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ –≤–æ–æ–±—â–µ
      setBar("xpBar", 0);
    }
  }
  
  // –≤–µ—Ä—Ö–Ω–∏–µ –º–∏–Ω–∏-—Å—á–µ—Ç—á–∏–∫–∏ (16-18)
const lf = document.getElementById("invLeaves");
if(lf) lf.textContent = String(s.inventory?.leaves ?? 0);

const fr = document.getElementById("invFruits");
if(fr) fr.textContent = String(s.inventory?.fruits ?? 0);

const es = document.getElementById("invEssence");
if(es) es.textContent = String(s.inventory?.essence ?? 0);

// XP –º–∏–Ω–∏-—Ç–µ–∫—Å—Ç (1)
const xpMini = document.getElementById("xpTextMini");
if(xpMini) xpMini.textContent = `${Math.round(s.xp || 0)}`;

  // subtitle: —Ä–µ—Å—É—Ä—Å—ã + —Ç–∞–π–º–µ—Ä —É–¥–æ–±—Ä–µ–Ω–∏—è (–û–î–ò–ù —Ä–∞–∑)
  const sub = el("subtitle");
  if(sub){
    const left = (s.growthBuffUntil || 0) - nowMs();
    const fertText = left > 0 ? ` ‚Ä¢ üåø ${fmtLeft(left)}` : "";
    sub.textContent =
      `–õ–∏—Å—Ç—å—è: ${s.inventory.leaves} ‚Ä¢ –ü–ª–æ–¥—ã: ${s.inventory.fruits} ‚Ä¢ –≠—Å—Å–µ–Ω—Ü–∏—è: ${s.inventory.essence}${fertText}`;
  }

  // –≤—ã—Å–æ—Ç–∞ —Å–ø—Ä–∞–≤–∞ –≤ —Å—Ü–µ–Ω–µ
  const hb = document.getElementById("heightBig");
  if(hb){
    const h = heightMetersByLevel(s.growthLevel || 0);
    hb.textContent = `${h} –º`;
  }

  const hf = document.getElementById("heightFill");
  if(hf){
    const pct = clamp(((s.growthLevel || 0) / 10) * 100, 0, 100);
    hf.style.height = pct + "%";
  }

  // —Å–ª–æ–∏
  if(typeof renderWeather === "function") renderWeather();
  if(typeof renderDayNight === "function") renderDayNight();
  if(typeof renderDecor === "function") renderDecor();
}

function renderWeather(){
  const layer = document.getElementById("weatherLayer");
  if(!layer) return;

  const w = state.weather || "sun";
  layer.innerHTML = "";

  if(w === "rain"){
    for(let i=0;i<28;i++){
      const d = document.createElement("div");
      d.style.position="absolute";
      d.style.left = (Math.random()*100)+"%";
      d.style.top = (-20 - Math.random()*60)+"px";
      d.style.width="2px";
      d.style.height=(18+Math.random()*26)+"px";
      d.style.background="rgba(255,255,255,.18)";
      d.style.borderRadius="2px";
      d.style.transform=`rotate(${8+Math.random()*10}deg)`;
      d.style.animation = `rainFall ${1.2+Math.random()*1.2}s linear infinite`;
      layer.appendChild(d);
    }
  }

  if(w === "fog"){
    const fog = document.createElement("div");
    fog.style.position="absolute";
    fog.style.inset="0";
    fog.style.background="rgba(255,255,255,.06)";
    fog.style.backdropFilter="blur(2px)";
    fog.style.animation="fogPulse 6s ease-in-out infinite";
    layer.appendChild(fog);
  }

  if(w === "wind"){
    // –ø—Ä–æ—Å—Ç–æ —É—Å–∏–ª–∏–º –ª–∏—Å—Ç—å—è –≤–∏–∑—É–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å–ª–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ (—Å–ø–∞–≤–Ω –ª–∏—Å—Ç—å–µ–≤ —Å–¥–µ–ª–∞–µ–º –≤ startWorld)
    const v = document.createElement("div");
    v.style.position="absolute";
    v.style.inset="0";
    v.style.background="linear-gradient(90deg, transparent, rgba(255,255,255,.05), transparent)";
    v.style.animation="windSweep 4s ease-in-out infinite";
    layer.appendChild(v);
  }

  // sun –º–æ–∂–Ω–æ –Ω–µ —Ä–∏—Å–æ–≤–∞—Ç—å, –æ–Ω –∏ —Ç–∞–∫ —É—é—Ç–Ω—ã–π
}

function renderDayNight(){
  const layer = document.getElementById("dayNightLayer");
  if(!layer) return;

  const night = isNightByLocalTime();
  if(night){
    layer.style.background = "radial-gradient(800px 500px at 30% 20%, rgba(140,120,255,.18), transparent 60%), rgba(0,0,0,.30)";
  }else{
    layer.style.background = "radial-gradient(800px 500px at 30% 20%, rgba(255,255,255,.10), transparent 60%), rgba(0,0,0,.00)";
  }
}

function showDecor(show){
  const d = el("decor");
  if(d) d.style.display = show ? "" : "none";
  setMainUIVisible(!show);
}

function renderDecorShop(){
  const grid = el("decorGrid");
  grid.innerHTML = "";

  DECOR_ITEMS.forEach(it => {
    const owned = !!state.decor?.[it.id];
    const canBuy = (state.inventory.leaves || 0) >= it.cost;

    const card = document.createElement("div");
    card.className = "rCard";
    card.innerHTML = `
      <div class="rImg">${it.id === "lantern" ? "üèÆ" : "ü™µ"}</div>
      <div class="rBody">
        <div class="name">${it.name}</div>
        <div class="desc">${it.desc}</div>
        <div class="mods">
          <span class="badge">üçÉ ${it.cost}</span>
          ${owned ? `<span class="badge">–ö—É–ø–ª–µ–Ω–æ</span>` : ``}
        </div>
        <div class="rActions" style="margin-top:10px;">
          ${owned ? `<button type="button" disabled>–£–∂–µ –µ—Å—Ç—å</button>` :
            `<button type="button" data-buy="${it.id}" ${canBuy ? "" : "disabled"}>–ö—É–ø–∏—Ç—å</button>`}
        </div>
      </div>
    `;
    grid.appendChild(card);
  });

  grid.querySelectorAll("button[data-buy]").forEach(b => {
    b.addEventListener("click", () => buyDecor(b.dataset.buy));
  });
}

function buyDecor(id){
  const it = DECOR_ITEMS.find(x => x.id === id);
  if(!it) return;

  if((state.inventory.leaves || 0) < it.cost) return;

  state.inventory.leaves -= it.cost;
  state.decor = state.decor || { lantern:false, fence:false };
  state.decor[id] = true;

  saveState(state);
  render(state);
  renderGround(state);
  renderDecorShop();
}

function renderDecor(){
  const layer = el("decorLayer");
  if(!layer) return;
  layer.innerHTML = "";

  const night = isNightByLocalTime();

  if(state.decor?.fence){
    const f = document.createElement("div");
    f.textContent = "ü™µü™µü™µü™µü™µ";
    f.style.position="absolute";
    f.style.left="14px";
    f.style.bottom="44px";
    f.style.opacity=".7";
    layer.appendChild(f);
  }

  if(state.decor?.lantern){
    const l = document.createElement("div");
    l.textContent = "üèÆ";
    l.style.position="absolute";
    l.style.right="18px";
    l.style.bottom="72px";
    l.style.fontSize="26px";
    layer.appendChild(l);

    if(night){
      const glow = document.createElement("div");
      glow.style.position="absolute";
      glow.style.right="10px";
      glow.style.bottom="58px";
      glow.style.width="120px";
      glow.style.height="120px";
      glow.style.borderRadius="999px";
      glow.style.background="radial-gradient(circle, rgba(255,204,102,.22), transparent 60%)";
      glow.style.filter="blur(1px)";
      layer.appendChild(glow);
    }
  }
}

function heightMeters(level){
  // 0.03–º -> 0.1 -> 0.3 -> 1 -> 2.5 -> 6 -> 12 -> 18...
  const base = 0.03;
  return +(base * Math.pow(1.65, level)).toFixed(2);
}

    // =========================
    // 6) –ß–∞—Å—Ç–∏—Ü—ã: –ª–∏—Å—Ç—å—è
    // =========================
    function spawnLeaf(){
      const scene = el("scene");
      const leaf = document.createElement("div");
      leaf.className = "leaf";
      leaf.textContent = "üçÉ";

      const x = Math.random() * 100; // %
      const dx = (Math.random()*80 - 40).toFixed(0) + "px";
      const rot = (Math.random()*240 - 120).toFixed(0) + "deg";
      const dur = (6 + Math.random()*6).toFixed(2) + "s";

      leaf.style.left = x + "%";
      leaf.style.setProperty("--dx", dx);
      leaf.style.setProperty("--rot", rot);
      leaf.style.animationDuration = dur;

      scene.appendChild(leaf);
      setTimeout(() => {
  leaf.remove();
  // –ª–∏—Å—Ç "—É–ø–∞–ª –Ω–∞ –∑–µ–º–ª—é"
  state.groundLeaves = (state.groundLeaves || 0) + 1;
  saveState(state);
  render(state);
  renderGround(state);
}, 14000);
    }

    // =========================
    // 7) –ò–≥—Ä–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    // =========================
    let state = loadState();

    function pulseTree(){
      const t = el("tree");
      t.classList.add("pulse");
      setTimeout(() => t.classList.remove("pulse"), 250);
    }

    function doWater(){
  const tree = state.treeId ? (TREES[state.treeId] || null) : null;
  const mods = tree?.mods || {};
  const waterActionMul = mods.waterActionMul ?? 1.0;

  const add = 25 * waterActionMul;
  const wasDry = state.water < 20;
state.water = clamp(state.water + add, 0, 100);
if(wasDry) state.health = clamp(state.health + 2, 0, 100);

  saveState(state);
  pulseTree();
  log(`üíß –ü–æ–ª–∏–ª–∏ (+${Math.round(add)} –≤–æ–¥—ã). –î–µ—Ä–µ–≤–æ –¥–æ–≤–æ–ª—å–Ω–æ.`);
  render(state);
}

    function doClean(){
      state.pests = clamp(state.pests - 35, 0, 100);
      saveState(state);
      pulseTree();
      log("üßπ –ñ—É–∫–∏ –∏–∑–≥–Ω–∞–Ω—ã.");
      render(state);
    }
    
    function doMeditate(){
  const s = state;
  s.daily = s.daily || { lastMeditateDay:null, streak:0, total:0 };

  const t = todayKey();
  if(s.daily.lastMeditateDay === t){
    log("–°–µ–≥–æ–¥–Ω—è –º–µ–¥–∏—Ç–∞—Ü–∏—è —É–∂–µ –±—ã–ª–∞. –î–µ—Ä–µ–≤–æ –¥–æ–≤–æ–ª—å–Ω–æ.");
    return;
  }

  // —Å—Ç—Ä–∏–∫ (–º—è–≥–∫–∏–π)
  const y = yesterdayKey();
  if(s.daily.lastMeditateDay === y) s.daily.streak += 1;
  else s.daily.streak = 1;

  s.daily.lastMeditateDay = t;
  s.daily.total += 1;

  // –Ω–∞–≥—Ä–∞–¥–∞ (–ø—Ä–æ—Å—Ç–∞—è, –ø—Ä–∏—è—Ç–Ω–∞—è)
  const bonusLeaves = 8 + Math.min(12, s.daily.streak); // 9..20
  s.inventory.leaves += bonusLeaves;

  // –º–∞–ª–µ–Ω—å–∫–∞—è —ç—Å—Å–µ–Ω—Ü–∏—è —Ä–µ–¥–∫–æ
  if(Math.random() < 0.25) s.inventory.essence += 1;

  // —á—É—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
  s.health = clamp(s.health + 6, 0, 100);
  s.pests = clamp(s.pests - 8, 0, 100);

  saveState(s);
  render(s);

  log(`üïØ –ú–µ–¥–∏—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. +${bonusLeaves} –ª–∏—Å—Ç—å–µ–≤. –°—Ç—Ä–∏–∫: ${s.daily.streak}`);
}
    
    // =========================
    // 8) –ó–∞–ø—É—Å–∫
    // =========================
    function boot(){
  bindQuiz();
  bindQuizImages();
  const btnCollect = document.getElementById("btnCollect");
if(btnCollect) btnCollect.addEventListener("click", collectLeaves);

(function setupBgParallax(){
  const bg = document.getElementById("bgLayer");
  const scene = document.getElementById("scene");
  if(!bg || !scene) return;

  let targetX = 0, targetY = 0;
  let curX = 0, curY = 0;

  // –º–µ–¥–ª–µ–Ω–Ω—ã–π ‚Äú–¥—Ä–µ–π—Ñ‚Äù
  let driftT = 0;

  function onMove(clientX, clientY){
    const r = scene.getBoundingClientRect();
    const nx = ((clientX - (r.left + r.width/2)) / r.width);   // -0.5..0.5
    const ny = ((clientY - (r.top  + r.height/2)) / r.height); // -0.5..0.5
    targetX = nx * 16;   // —Å–∏–ª–∞ –ø–∞—Ä–∞–ª–ª–∞–∫—Å–∞ –ø–æ X
    targetY = ny * 12;   // —Å–∏–ª–∞ –ø–∞—Ä–∞–ª–ª–∞–∫—Å–∞ –ø–æ Y
  }

  // —Ç–∞—á
  scene.addEventListener("touchmove", (e) => {
    if(!e.touches || !e.touches[0]) return;
    onMove(e.touches[0].clientX, e.touches[0].clientY);
  }, {passive:true});

  // –º—ã—à—å (–¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–∞ –ü–ö)
  scene.addEventListener("mousemove", (e) => {
    onMove(e.clientX, e.clientY);
  }, {passive:true});

  function tick(){
    // —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (—á—Ç–æ–±—ã –Ω–µ –¥—ë—Ä–≥–∞–ª–æ—Å—å)
    curX += (targetX - curX) * 0.08;
    curY += (targetY - curY) * 0.08;

    // –¥—Ä–µ–π—Ñ
    driftT += 0.002;
    const driftX = Math.sin(driftT) * 6;
    const driftY = Math.cos(driftT * 0.8) * 4;

    bg.style.transform = `translate3d(${curX + driftX}px, ${curY + driftY}px, 0) scale(1.06)`;

    requestAnimationFrame(tick);
  }
  tick();
})();

  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ü–µ–Ω—É (–ø–æ—Ç–æ–º showQuiz/showResult –µ—ë —Å–∫—Ä–æ—é—Ç)
  setMainUIVisible(true);
  showResult(false);

  // –µ—Å–ª–∏ –¥–µ—Ä–µ–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç –∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º ‚Äú–º–∏—Ä‚Äù
  if(!state.treeId){
    showQuiz(true);
    render(state); // –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—É—Å—Ç—å UI –Ω–µ –ø—É—Å—Ç–æ–π
    renderGround(state);
    log("–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –î—É—Ö –î–µ—Ä–µ–≤–∞.");
    return;
  }

  // 1) –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å
  const res = tickTree(state, nowMs());
  saveState(state);
render(state);
renderGround(state);
startWorld();
setupParallax();
if(res.msg) log(res.msg);

      // –∫–Ω–æ–ø–∫–∏
      el("btnWater").addEventListener("click", doWater);
      el("btnClean").addEventListener("click", doClean);
      document.getElementById("btnFertilize")?.addEventListener("click", doFertilize);
      document.getElementById("btnMeditate")?.addEventListener("click", doMeditate);
      document.getElementById("btnShop")?.addEventListener("click", () => {
  // –≤—Ä–µ–º–µ–Ω–Ω–æ: –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–≤–æ–π —ç–∫—Ä–∞–Ω —É–∫—Ä–∞—à–µ–Ω–∏–π
  renderDecorShop();
  showDecor(true);
});
      
const back = el("btnDecorBack");
if(back) back.addEventListener("click", () => {
  showDecor(false);
  render(state);
});
      el("btnReset").addEventListener("click", () => {
  state = defaultState();
  saveState(state);
  log("üß® –°–±—Ä–æ—Å–∏–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å. –î–µ—Ä–µ–≤–æ –ø–µ—Ä–µ—Ä–æ–¥–∏–ª–æ—Å—å.");
  showQuiz(true);
  updateQuizProgress();
  render(state);
});
    }
    
  function doFertilize(){
  const cost = 15; // –ª–∏—Å—Ç—å—è
  if((state.inventory.leaves || 0) < cost){
    log("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏—Å—Ç—å–µ–≤ –¥–ª—è —É–¥–æ–±—Ä–µ–Ω–∏—è.");
    return;
  }
  state.inventory.leaves -= cost;
  state.growthBuffUntil = nowMs() + 8 * 3600000; // 8 —á–∞—Å–æ–≤
  saveState(state);
  render(state);
  renderGround(state);
  log("–î–µ—Ä–µ–≤–æ –ø–æ–ª—É—á–∏–ª–æ –ø–∏—Ç–∞–Ω–∏–µ. –†–æ—Å—Ç —É—Å–∫–æ—Ä–µ–Ω –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤.");
}

function spawnFirefly(){
  if(!isNightByLocalTime()) return;

  const scene = document.getElementById("scene");
  if(!scene) return;

  const f = document.createElement("div");
  f.className = "firefly";
  f.style.left = (10 + Math.random()*80) + "%";
  f.style.top = (20 + Math.random()*55) + "%";
  f.style.animationDuration = (3.5 + Math.random()*3.5) + "s";
  scene.appendChild(f);

  setTimeout(() => f.remove(), 7000);
}

function calcGrowthLevel(xp){
  let lvl = 0;
  for(let i=0;i<GROWTH_XP_THRESHOLDS.length;i++){
    if(xp >= GROWTH_XP_THRESHOLDS[i]) lvl = i;
  }
  return lvl;
}

function growthInfo(level){
  if(level <= 2) return { major:0, minor:level, label:"–°–µ–º–µ—á–∫–æ" };
  if(level <= 5) return { major:1, minor:level-3, label:"–†–æ—Å—Ç–æ–∫" };
  if(level <= 8) return { major:2, minor:level-6, label:"–ú–æ–ª–æ–¥–æ–µ" };
  return { major:3, minor:level-9, label:"–í–∑—Ä–æ—Å–ª–æ–µ" }; // minor 0..1
}
    
    // =========================
// 9) Quiz logic
// =========================
const quizAnswers = { q1:null, q2:null, q3:null, q4:null };

function quizAnsweredCount(){
  return Object.values(quizAnswers).filter(Boolean).length;
}

function updateQuizProgress(){
  el("quizProgress").textContent = `${quizAnsweredCount()}/4`;
}

function setMainUIVisible(visible){
  const scene = el("scene");
  if(scene) scene.style.display = visible ? "" : "none";

  const hudTop = el("hudTop");
  if(hudTop) hudTop.style.display = visible ? "" : "none";

  const hudRight = el("hudRight");
  if(hudRight) hudRight.style.display = visible ? "" : "none";
}

function showQuiz(show){
  el("quiz")?.classList.toggle("active", !!show);
  setMainUIVisible(!show);
  // –µ—Å–ª–∏ —Å–∫—Ä—ã–ª–∏ —Ç–µ—Å—Ç, —É–±–µ–¥–∏–º—Å—è —á—Ç–æ —Å—Ü–µ–Ω–∞ —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–∏–º–∞
  if(!show) setMainUIVisible(true);
}

function finalizeTreeChoice(treeId){
  state.treeId = treeId;
  // —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ü–µ–Ω—É
  setMainUIVisible(true);
  try { document.getElementById("scene")?.scrollIntoView({behavior:"smooth", block:"start"}); } catch(e){}
  saveState(state);

  showResult(false);
  showQuiz(false);

  el("scene").style.display = "";
  document.querySelector(".grid").style.display = "";
  document.querySelector(".actions").style.display = "";

  render(state);
  renderGround(state);
  log(`${TREES[treeId].icon} ${TREES[treeId].name}. ${TREES[treeId].desc}`);

  startWorld(); // –≤–æ—Ç —ç—Ç–æ –æ–∫
}

 function startWorld(){
  if(worldStarted) return;
  worldStarted = true;

  setInterval(() => {
  const w = state.weather || "sun";
  const p = (w === "wind") ? 0.55 : 0.35;
  if(Math.random() < p) spawnLeaf();
}, 900);

  setInterval(() => {
    const r = tickTree(state, nowMs());
    saveState(state);
    ensureWeather();
    render(state);
    renderGround(state);
    if(r.msg) log(r.msg);
  }, 10000);
  
  setInterval(() => {
  if(isNightByLocalTime() && Math.random() < 0.35) spawnFirefly();
}, 1200);
}

function handleQuizOptionClick(btn){
  const q = btn.dataset.q;
  const a = btn.dataset.a;
  quizAnswers[q] = a;

  // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞: –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤–æ–ø—Ä–æ—Å–∞ —Å–±—Ä–æ—Å–∏—Ç—å, –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤—ã–¥–µ–ª–∏—Ç—å
  document.querySelectorAll(`button[data-q="${q}"]`).forEach(b => b.classList.remove("selected"));
btn.classList.add("selected");

  updateQuizProgress();

  if(quizAnsweredCount() === 4){
    const res = pickTreeFromAnswers(quizAnswers);

    if(res.winner){
  renderResultOptions([res.winner]);
  showResult(true);
}else{
  renderResultOptions(res.options);
  showResult(true);
}
  }
}

function bindQuiz(){
  document.querySelectorAll(".qOpt").forEach(btn => {
    btn.addEventListener("click", () => handleQuizOptionClick(btn));
  });

  el("btnQuizReset").addEventListener("click", () => {
    quizAnswers.q1 = quizAnswers.q2 = quizAnswers.q3 = quizAnswers.q4 = null;
    document.querySelectorAll(".qOpt").forEach(b => {
      b.classList.remove("selected");
    });
    updateQuizProgress();
    log("–û—Ç–≤–µ—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã.");
  });

  el("btnResultBack").addEventListener("click", () => {
    showResult(false);
  });

  updateQuizProgress();
}
    
    function bindQuizImages(){
  document.querySelectorAll('img[data-img]').forEach(img => {
    const key = img.dataset.img;
    img.src = IMG[key] || "";
  });
}

function showResult(show){
  el("result").classList.toggle("active", !!show);

  if(show){
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
    el("quiz").classList.remove("active");
    el("scene").style.display = "none";
    document.querySelector(".grid").style.display = "none";
    document.querySelector(".actions").style.display = "none";
  }else{
    // —Å–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–æ –ù–ï –≤–∫–ª—é—á–∞–µ–º –∫–≤–∏–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    el("result").classList.remove("active");
  }
}

function modsBadges(treeId){
  const t = TREES[treeId];
  const m = t.mods || {};
  const badges = [];

  const xp = Math.round((m.xpMul ?? 1) * 100);
  badges.push(`–†–æ—Å—Ç: ${xp}%`);

  const wd = Math.round((m.waterDecayMul ?? 1) * 100);
  badges.push(`–†–∞—Å—Ö–æ–¥ –≤–æ–¥—ã: ${wd}%`);

  const pm = Math.round((m.pestsMul ?? 1) * 100);
  badges.push(`–ñ—É–∫–∏: ${pm}%`);

  const nx = Math.round((m.nightXpMul ?? 1) * 100);
  if(nx !== 100) badges.push(`–ù–æ—á—å: ${nx}%`);

  return badges;
}

function renderResultOptions(treeIds){
  const grid = el("resultGrid");
  grid.innerHTML = "";

  treeIds.forEach(treeId => {
    const t = TREES[treeId];
    const card = document.createElement("div");
    card.className = "rCard";

    const badges = modsBadges(treeId)
      .map(x => `<span class="badge">${x}</span>`)
      .join("");

    card.innerHTML = `
      <div class="rImg"><img src="${t.img}" alt=""></div>
      <div class="rBody">
        <div class="name">${t.icon} ${t.name}</div>
        <div class="desc">${t.desc}</div>
        <div class="mods">${badges}</div>
        <div class="rActions" style="margin-top:10px;">
          <button type="button" data-pick="${treeId}">–í—ã–±—Ä–∞—Ç—å</button>
        </div>
      </div>
    `;

    grid.appendChild(card);
  });

  grid.querySelectorAll("button[data-pick]").forEach(b => {
    b.addEventListener("click", () => {
  finalizeTreeChoice(b.dataset.pick);
  showResult(false);
  showQuiz(false);
});
  });
}
    

    boot();
  </script>
</body>
</html>
