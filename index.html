<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tree Spirit MVP</title>
  <style>
    :root{
      --bg1:#0b1222;
      --panel:#121c33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#9fb0d9;
      --line:rgba(255,255,255,.10);
      --ok:#49d17d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#7aa2ff;
    }
    *{box-sizing:border-box}
    body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 20% -10%, rgba(122,162,255,.22), transparent 60%),
    radial-gradient(900px 600px at 90% 10%, rgba(73,209,125,.18), transparent 55%),
    linear-gradient(180deg, var(--bg1), #070b16);
  min-height:100vh;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:16px;
  padding-top:24px;
}
    .app{
      width:min(520px, 100%);
      background: rgba(18,28,51,.78);
      border:1px solid var(--line);
      border-radius:18px;
      max-height: calc(100vh - 32px); /* –≤–∞–∂–Ω–æ */
  overflow:auto;                  /* –≤–∞–∂–Ω–æ */
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    header{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      border-bottom:1px solid var(--line);
    }
    header .title{
      font-weight:800;
      letter-spacing:.2px;
    }
    header .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .wrap{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .scene{
      position:relative;
      height:380px;
      border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow:hidden;
    }
    /* –î–µ–Ω—å/–Ω–æ—á—å —Ñ–æ–Ω–æ–º: –ø–æ–∫–∞ –ø—Ä–∏–º–∏—Ç–∏–≤, –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ */
    .scene.day{
      background:
        radial-gradient(900px 420px at 20% -20%, rgba(255,230,150,.30), transparent 65%),
        radial-gradient(800px 420px at 90% 0%, rgba(122,162,255,.28), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }
    .scene.night{
      background:
        radial-gradient(900px 520px at 30% -10%, rgba(140,120,255,.22), transparent 65%),
        radial-gradient(800px 420px at 90% 0%, rgba(73,209,125,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }


    .tree{
  position:absolute;
  left:50%;
  top:80%;
  transform: translate(-50%, -50%);
  font-size: 110px;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
  transition: transform .35s ease;
  user-select:none;
}
    .tree.pulse{ transform: translate(-50%, -50%) scale(1.05); }

    /* –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
    .glow{
      position:absolute;
      left:50%;
      top:60%;
      width:180px;
      height:180px;
      transform: translate(-50%, -50%);
      border-radius:999px;
      background: radial-gradient(circle, rgba(255,240,180,.18), rgba(140,120,255,.06), transparent 70%);
      filter: blur(1px);
      opacity:.85;
      pointer-events:none;
    }



    /* –ø–∞–Ω–µ–ª—å –º–µ—Ç—Ä–∏–∫ */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .card{
      border:1px solid var(--line);
      background: rgba(15,23,48,.65);
      border-radius:14px;
      padding:10px 12px;
    }
    .k{ font-size:12px; color:var(--muted); }
    .v{ margin-top:4px; font-weight:800; font-size:16px; }
    .bar{
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      margin-top:8px;
    }
    .bar > div{
      height:100%;
      width:50%;
      background: var(--accent);
    }

    /* –∫–Ω–æ–ø–∫–∏ */
    .actions{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    button{
      border:1px solid var(--line);
      background: rgba(122,162,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }
    .btn2{ background: rgba(73,209,125,.12); }
    .btnDanger{ background: rgba(255,107,107,.10); }

    /* –ª–æ–≥–∏ */
    .log{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      min-height: 16px;
    }

    /* –ø–∞–¥–∞—é—â–∏–µ –ª–∏—Å—Ç—å—è (—á–∞—Å—Ç–∏—Ü—ã) */
    .leaf{
      position:absolute;
      top:-20px;
      font-size:18px;
      opacity:.9;
      pointer-events:none;
      animation: fall linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }
    @keyframes fall{
      to{
        transform: translate(var(--dx), 320px) rotate(var(--rot));
        opacity: .1;
      }
    }
    
    /* ===== Quiz screen ===== */
.quiz{
  display:none;
  border:1px solid var(--line);
  background: rgba(15,23,48,.55);
  border-radius:16px;
  padding:12px;
  margin-bottom:12px;
}
.quiz.active{ display:block; }

.qTitle{
  font-weight:900;
  font-size:16px;
  margin-bottom:6px;
}
.qSub{ color:var(--muted); font-size:12px; margin-bottom:10px; }

.qCard{
  border:1px solid var(--line);
  background: rgba(18,28,51,.65);
  border-radius:14px;
  padding:10px 10px;
  margin:10px 0;
}
.qQuestion{ font-weight:800; margin-bottom:8px; }

.qOptions{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.qOpt{
  text-align:left;
  width:100%;
  background: rgba(122,162,255,.10);
}
.qOpt small{ display:block; color:var(--muted); font-weight:600; margin-top:2px; }

.quizFooter{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}
.pill{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  color: var(--muted);
  font-size:12px;
}

/* ===== Quiz option cards (image buttons) ===== */
.qOptions{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
.qOpt{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 10px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(122,162,255,.10);
}
.qOpt:active{ transform: translateY(1px); }
.qOpt.selected{
  outline: 2px solid rgba(255,255,255,.25);
  background: rgba(122,162,255,.18);
}
.qOptImg{
  width:46px;
  height:46px;
  border-radius:12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  flex:0 0 auto;
}
.qOptImg img{ width:100%; height:100%; object-fit:cover; display:block; }
.qOptText{ text-align:left; }
.qOptText b{ display:block; font-weight:900; }
.qOptText small{ display:block; color:var(--muted); font-weight:600; margin-top:2px; }

/* ===== Result screen ===== */
.result{
  display:none;
  border:1px solid var(--line);
  background: rgba(15,23,48,.55);
  border-radius:16px;
  padding:12px;
  margin-bottom:12px;
}
.result.active{ display:block; }

.rTitle{
  font-weight:900;
  font-size:16px;
  margin-bottom:6px;
}
.rSub{ color:var(--muted); font-size:12px; margin-bottom:10px; }

.rGrid{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
.rCard{
  display:flex;
  gap:12px;
  border:1px solid var(--line);
  background: rgba(18,28,51,.65);
  border-radius:14px;
  padding:10px;
}
.rImg{
  width:112px;
  height:112px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  overflow:hidden;
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
}
.rImg img{ width:100%; height:100%; object-fit:cover; display:block; }
.rBody{ flex:1 1 auto; }
.rBody .name{ font-weight:950; font-size:16px; }
.rBody .desc{ color:var(--muted); font-size:12px; line-height:1.35; margin-top:4px; }
.rBody .mods{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  color: var(--text);
  font-size:12px;
  font-weight:800;
}

.rActions{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}

@keyframes rainFall{
  from{ transform: translateY(-40px) rotate(10deg); opacity:.0; }
  10%{ opacity:1; }
  to{ transform: translateY(380px) rotate(10deg); opacity:0; }
}
@keyframes fogPulse{
  0%,100%{ opacity:.45; }
  50%{ opacity:.8; }
}
@keyframes windSweep{
  0%,100%{ opacity:.0; transform: translateX(-30%); }
  40%{ opacity:.35; }
  60%{ opacity:.35; }
  100%{ opacity:.0; transform: translateX(30%); }
}

#dayNightLayer{
  border-radius:16px;
  transition: background 1200ms ease, opacity 1200ms ease;
  opacity: 1;
}

.firefly{
  position:absolute;
  width:6px; height:6px;
  border-radius:999px;
  background: rgba(255,255,255,.28);
  box-shadow: 0 0 14px rgba(255,255,255,.35);
  animation: fly 4.5s ease-in-out infinite;
  opacity:.0;
}
@keyframes fly{
  0%{ transform: translate(0,0); opacity:0; }
  20%{ opacity:.8; }
  60%{ opacity:.65; }
  100%{ transform: translate(40px,-30px); opacity:0; }
}

/* ===== DECOR IMAGES (fence + lantern) ===== */

#decorLayer{ pointer-events:none; }

/* –ó–∞–±–æ—Ä (–ø–æ–∑–∏—Ü–∏—è –∫–∞–∫ —É —Ç–µ–±—è –Ω–∞ –∫—Ä–∞—Å–Ω–æ–π "1") */
.decorFenceImg{
  position:absolute;
  left:6%;
  bottom:8%;

  width:220px;        /* ‚Üê —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
  max-width:55vw;     /* ‚Üê –ù–ò–ö–û–ì–î–ê –Ω–µ –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞ */
  height:auto;

  opacity:.95;
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.25));
}

/* –§–æ–Ω–∞—Ä—å (–ø–æ–∑–∏—Ü–∏—è –∫–∞–∫ —É —Ç–µ–±—è –Ω–∞ –∫—Ä–∞—Å–Ω–æ–π "2") */
.decorLanternImg{
  position:absolute;
  right:60px;              /* –º–µ–∂–¥—É –¥–µ—Ä–µ–≤–æ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏ —Å–ø—Ä–∞–≤–∞ */
  bottom:6%;
  height:clamp(150px, 30vh, 280px);
  width:auto;
  opacity:.98;
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.28));
}

/* –ª—ë–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ —Ñ–æ–Ω–∞—Ä—è –Ω–æ—á—å—é */
.decorLanternGlow{
  position:absolute;
  right:72px;
  bottom:4%;
  width:180px;
  height:180px;
  border-radius:999px;
  background: radial-gradient(circle, rgba(255,214,120,.22), transparent 60%);
  filter: blur(1px);
  opacity: 0;
}

/* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º glow —Ç–æ–ª—å–∫–æ –Ω–æ—á—å—é —á–µ—Ä–µ–∑ inline style –≤ JS (—Å–º. –Ω–∏–∂–µ) */

/* ===== Height gauge: –ª–∏–Ω–µ–π–∫–∞-–∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–µ–≤–∞ (—Ç—è–Ω–µ—Ç—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ) ===== */

/* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ª–∏–Ω–µ–π–∫–∏ */
#heightGauge{
  position:absolute;
  left:-2px;          /* —á—É—Ç—å –ª–µ–≤–µ–µ, —á—Ç–æ–±—ã –ø—Ä—è–º –ø–æ –∫—Ä–∞—é */
  top:18px;           /* –æ–ø—É—Å—Ç–∏ –≤–µ—Ä—Ö (–ø–æ–¥–±–µ—Ä—ë—à—å) */
  bottom:18px;        /* –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
  width:44px;         /* –æ–±—â–∞—è ‚Äú–ø–æ–ª–æ—Å–∞‚Äù –ø–æ–¥ –ª–∏–Ω–µ–π–∫—É + —Ü–∏—Ñ—Ä—É */
  pointer-events:none;
  z-index:20;
}

/* —Å–∞–º–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ª–∏–Ω–µ–π–∫–∏ —Ç—è–Ω–µ—Ç—Å—è –æ—Ç top –¥–æ bottom */
#heightGauge::before{
  content:"";
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:34px; /* —à–∏—Ä–∏–Ω–∞ —Å–∞–º–æ–π –ª–∏–Ω–µ–π–∫–∏ */
  background: url("icons/height_ruler.png") center center / 100% 100% no-repeat;
  opacity:.95;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
}

/* —Å—Ç–∞—Ä—É—é ‚Äú–∑–∞–ª–∏–≤–∫—É‚Äù –≤—ã–∫–ª—é—á–∞–µ–º, –ø–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∞—Å —Ç–µ–ø–µ—Ä—å –∫–∞—Ä—Ç–∏–Ω–∫–∞-–ª–∏–Ω–µ–π–∫–∞ */
#heightGauge .hgBar,
#heightFill{
  display:none !important;
}

/* —Ü–∏—Ñ—Ä–∞ –≤—ã—Å–æ—Ç—ã: —Å—Ç–∞–≤–∏–º –°–í–ï–†–•–£ —Ä—è–¥–æ–º —Å –ª–∏–Ω–µ–π–∫–æ–π */
#heightBig{
  position:absolute;
  left:36px;          /* —Å–ø—Ä–∞–≤–∞ –æ—Ç –ª–∏–Ω–µ–π–∫–∏ */
  top:6px;            /* –ø–æ—á—Ç–∏ —Å–≤–µ—Ä—Ö—É */
  font-weight:900;
  font-size:14px;
  color: var(--text);
  text-shadow: 0 2px 8px rgba(0,0,0,.55);
  white-space:nowrap;
  z-index:21;
}


.scene{ transition: background 1200ms ease; }

.scene[data-stage-major="0"]{
  background:
    radial-gradient(500px 280px at 50% 25%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(900px 500px at 30% 0%, rgba(91,124,255,.16), transparent 65%),
    rgba(10,15,32,.75);
}
.scene[data-stage-major="1"]{
  background:
    radial-gradient(520px 320px at 55% 22%, rgba(255,255,255,.12), transparent 60%),
    radial-gradient(900px 520px at 35% 0%, rgba(79,209,125,.12), transparent 65%),
    rgba(10,15,32,.75);
}
.scene[data-stage-major="2"]{
  background:
    radial-gradient(520px 360px at 55% 18%, rgba(255,255,255,.14), transparent 60%),
    radial-gradient(900px 520px at 35% 0%, rgba(255,204,102,.12), transparent 65%),
    rgba(10,15,32,.75);
}
.scene[data-stage-major="3"]{
  background:
    radial-gradient(540px 380px at 55% 14%, rgba(255,255,255,.16), transparent 60%),
    radial-gradient(900px 520px at 35% 0%, rgba(186,85,255,.12), transparent 65%),
    rgba(10,15,32,.75);
}

@keyframes sway{
  0%{ transform: translateX(0px) rotate(-1deg); }
  50%{ transform: translateX(2px) rotate(1deg); }
  100%{ transform: translateX(0px) rotate(-1deg); }
}

.scene{
  position: relative;
  overflow: hidden;
}

.glow, #weatherLayer, #dayNightLayer, #groundLayer, #decorLayer, #tree{
  will-change: transform;
  transition: transform 180ms ease;
}

/* ===== Soft Glow Animation ===== */
@keyframes glowPulse {
  0%   { opacity: .35; filter: blur(2px); transform: translate(-50%, -50%) scale(0.98); }
  50%  { opacity: .70; filter: blur(4px); transform: translate(-50%, -50%) scale(1.03); }
  100% { opacity: .35; filter: blur(2px); transform: translate(-50%, -50%) scale(0.98); }
}

.glow{
  /* —á—É—Ç—å –Ω–µ–∂–Ω–µ–µ –∏ ‚Äú—à–∏—Ä–µ‚Äù —Å–≤–µ—Ç */
  mix-blend-mode: screen;
  animation: glowPulse 4.5s ease-in-out infinite;
}

/* –Ω–æ—á—å—é –¥–µ–ª–∞–µ–º —Å–≤–µ—Ç —Å–∏–ª—å–Ω–µ–µ, –¥–Ω—ë–º –ø–æ—á—Ç–∏ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ */
.scene.day .glow{ opacity: .22; }
.scene.night .glow{ opacity: .62; }

/* –ª—ë–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –Ω–∞ —Å–∞–º–æ–º –¥–µ—Ä–µ–≤–µ (–∫–∞—Ä—Ç–∏–Ω–∫–∞) */
#treeImg{
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
  transition: filter 600ms ease;
}
.scene.night #treeImg{
  filter:
    drop-shadow(0 10px 18px rgba(0,0,0,.35))
    drop-shadow(0 0 10px rgba(180,255,210,.18));
}

#treeSway{
  width: 100%;
  height: 100%;
  transform-origin: 50% 95%;
}

@keyframes swayRot{
  0%{ transform: rotate(-1deg); }
  50%{ transform: rotate(1deg); }
  100%{ transform: rotate(-1deg); }
}

/* ===== HUD TOP ===== */
.hudTop{
  margin-bottom: 10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.hudRow{
  display:flex;
  gap:10px;
}

.pill{
  flex:1;
  border:1px solid var(--line);
  background: rgba(15,23,48,.55);
  border-radius:16px;
  padding:10px;
  backdrop-filter: blur(8px);
}

.pillK{
  font-size:12px;
  color: var(--muted);
  opacity:.85;
  font-weight:800;
}

.pillV{
  font-weight:900;
  font-size:16px;
  margin-top:2px;
}

.pillBar{
  height:10px;
  border-radius:999px;
  background: rgba(255,255,255,.10);
  overflow:hidden;
  margin-top:8px;
}

/* –í–ê–ñ–ù–û: —ç—Ç–æ —Å–∞–º–∏ ‚Äú–∑–∞–ª–∏–≤–∫–∏‚Äù –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª–æ—Å–æ–∫ */
.pillBar > div{
  height:100%;
  width:0%;
  border-radius:999px;
  background: rgba(255,255,255,.75);
  transition: width .35s ease;
}

/* –º–∞–ª–µ–Ω—å–∫–∏–µ (16-18) */
.pillSmall{
  flex:1;
  border:1px solid var(--line);
  background: rgba(15,23,48,.45);
  border-radius:999px;
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  font-weight:900;
}

/* ===== RIGHT ACTIONS ===== */
.hudRight{
  position:absolute;
  right:12px;
  bottom:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:5;
}

.iconBtn{
  width:52px;
  height:52px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(15,23,48,.55);
  display:grid;
  place-items:center;
}

/* ===== MEDITATION ORB (10) ===== */
.meditateOrb{
  position:absolute;
  left:50%;
  top:44%;
  transform: translate(-50%,-50%);
  width:56px;
  height:56px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.10);
  color: var(--text);
  font-size:22px;
  display:grid;
  place-items:center;
  backdrop-filter: blur(8px);
  z-index:4;
}

#bgLayer{
  position:absolute;
  inset:0;
  background-position:center;
  background-repeat:no-repeat;
  background-size:cover;

  /* –í–û–¢ –≠–¢–û –ì–õ–ê–í–ù–û–ï */
   transform: translate3d(0,0,0) scale(1.14);
  transform-origin:center;
  will-change: transform;
  backface-visibility: hidden;
}

/* —á—Ç–æ–±—ã –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –±—ã–ª–æ –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ */
.scene > *:not(#bgLayer){
  z-index: 1;
}

button{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

/* –¥–µ–ª–∞–µ–º –∏–∫–æ–Ω–∫—É ‚Äú–ø–æ—á—Ç–∏ –≤–æ –≤–µ—Å—å –∫–≤–∞–¥—Ä–∞—Ç‚Äù */
.iconBtn{ padding:2px; }           /* –æ—Å—Ç–∞–≤–∏–º –∫—Ä–∞—Å–∏–≤—É—é —Ä–∞–º–∫—É/–≤–æ–∑–¥—É—Ö */
.btnIcon{
  width:100%;
  height:100%;
  object-fit:contain;
  pointer-events:none;
  display:block;
}

#btnShop{ background: transparent; }

/* Quote modal */
.quoteModal{
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  background: rgba(0,0,0,.45);
  z-index: 9999;
  padding: 16px;
}
.quoteModal.hidden{ display:none; }

.quoteBox{
  width: min(520px, 100%);
  border-radius: 18px;
  padding: 16px 16px 14px;
  background: rgba(15,20,40,.92);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 14px 45px rgba(0,0,0,.40);
}

.quoteTitle{
  font-weight: 800;
  font-size: 16px;
  margin-bottom: 8px;
}

.quoteText{
  font-size: 14px;
  line-height: 1.45;
  opacity: .95;
  white-space: pre-wrap;
}

.quoteBtn{
  margin-top: 12px;
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(122,162,255,.16);
  color: #fff;
  font-weight: 700;
}

.weatherBar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(15,20,40,.55);
  margin: 10px 0;
}

.weatherBtn{
  padding:6px 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(122,162,255,.16);
  color:#fff;
  font-weight:700;
}

/* ============================
   Weather FX overlay
   ============================ */

.weatherFX{
  position:absolute;
  inset:0;
  pointer-events:none;
  overflow:hidden;
  border-radius: inherit;
  z-index: 20; /* –µ—Å–ª–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç UI, —É–º–µ–Ω—å—à–∏; –µ—Å–ª–∏ –Ω–µ –≤–∏–¥–Ω–æ - —É–≤–µ–ª–∏—á—å */
}

.weatherFX .fx{
  position:absolute;
  inset:0;
  opacity:0;
  transition: opacity 400ms ease;
}

/* –≤–∫–ª—é—á–∞—Ç–µ–ª–∏ */
.weatherFX.weather-rain .fx-rain{ opacity:1; }
.weatherFX.weather-snow .fx-snow{ opacity:1; }
.weatherFX.weather-sun  .fx-sun { opacity:1; }

/* ---------- RAIN ---------- */
.fx-rain::before,
.fx-rain::after{
  content:"";
  position:absolute;
  inset:-40% -20%;
  background-image: repeating-linear-gradient(
    115deg,
    rgba(255,255,255,.22) 0px,
    rgba(255,255,255,.22) 1px,
    rgba(255,255,255,0) 2px,
    rgba(255,255,255,0) 12px
  );
  filter: blur(.2px);
  transform: translateY(-30%);
  animation: rainFall 900ms linear infinite;
}

.fx-rain::after{
  opacity:.6;
  filter: blur(.6px);
  animation-duration: 1200ms;
  transform: translateY(-40%);
}

@keyframes rainFall{
  to{ transform: translateY(30%); }
}

/* ---------- SNOW ---------- */
.fx-snow::before{
  content:"";
  position:absolute;
  inset:-10% 0;
  background:
    radial-gradient(circle, rgba(255,255,255,.9) 0 2px, rgba(255,255,255,0) 3px) 0 0 / 120px 120px,
    radial-gradient(circle, rgba(255,255,255,.8) 0 1.5px, rgba(255,255,255,0) 3px) 30px 40px / 160px 160px,
    radial-gradient(circle, rgba(255,255,255,.7) 0 1.2px, rgba(255,255,255,0) 3px) 60px 20px / 200px 200px;
  animation: snowFall 6s linear infinite;
  opacity:.9;
}

@keyframes snowFall{
  from{ transform: translateY(-15%); }
  to  { transform: translateY(15%); }
}

/* ---------- SUN ---------- */
.fx-sun::before{
  content:"";
  position:absolute;
  width: 260px;
  height: 260px;
  right: -80px;
  top: -90px;
  background: radial-gradient(circle at 40% 40%,
    rgba(255,245,200,.75),
    rgba(255,210,120,.25) 45%,
    rgba(255,210,120,0) 70%
  );
  filter: blur(.2px);
}

.fx-sun::after{
  content:"";
  position:absolute;
  inset:-20%;
  background: radial-gradient(circle at 80% 10%,
    rgba(255,220,140,.14),
    rgba(255,220,140,0) 55%
  );
  animation: sunPulse 2.8s ease-in-out infinite;
}

@keyframes sunPulse{
  0%,100%{ transform: scale(1); opacity:.9; }
  50%    { transform: scale(1.03); opacity:1; }
}

.layerFull{
  position:absolute;
  inset:0;
  pointer-events:none;
}

.todayList{ display:flex; flex-direction:column; gap:8px; }
.todayItem{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:14px;
  background: rgba(0,0,0,.18);
}
.todayLeft{ display:flex; align-items:center; gap:10px; }
.todayCheck{
  width:22px; height:22px; border-radius:8px;
  display:grid; place-items:center;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  flex:0 0 22px;
}
.todayDone .todayCheck{ background: rgba(73,209,125,.22); border-color: rgba(73,209,125,.45); }
.todayText b{ display:block; font-size:14px; }
.todayText small{ display:block; opacity:.7; font-size:12px; margin-top:2px; }
.todayReward{ opacity:.8; font-size:12px; }

.weatherLine{
  margin-top: 6px;
  margin-bottom: 6px;
  padding: 6px 10px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: rgba(0,0,0,.18);
  font-size: 13px;
  opacity: 0.85;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}

#dropsLayer{
  position:absolute;
  inset:0;
  pointer-events:none;
  overflow:hidden;
  z-index: 3; /* –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å, —É–≤–µ–ª–∏—á—å */
}

.drop{
  position:absolute;
  width:22px;
  height:22px;
  border-radius:999px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.06));
  border: 1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(2px);
  pointer-events:auto;
  cursor:pointer;
  animation: dropFall linear forwards;
}

@keyframes dropFall{
  from{ transform: translateY(-30px); opacity:0; }
  to{ transform: translateY(110vh); opacity:1; }
}

#frostOverlay{
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:0;
  transition: opacity 600ms ease;
  background:
    radial-gradient(closest-side at 0% 50%, rgba(200,230,255,.18), transparent 70%),
    radial-gradient(closest-side at 100% 50%, rgba(200,230,255,.18), transparent 70%),
    radial-gradient(closest-side at 50% 0%, rgba(200,230,255,.12), transparent 70%),
    radial-gradient(closest-side at 50% 100%, rgba(200,230,255,.12), transparent 70%);
  backdrop-filter: blur(1.5px);
}
.scene.snow #frostOverlay{ opacity:1; }

.shopTabs{ display:flex; gap:8px; margin:10px 0; flex-wrap:wrap; }
.tabBtn{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:inherit; }
.tabBtn.active{ background:rgba(255,255,255,.14); }
.shopWallet{ display:flex; gap:8px; margin:0 0 10px 0; flex-wrap:wrap; }

.buffLine{
  margin-top:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(73,209,125,.10);
  color: rgba(233,238,252,.95);
  font-size: 13px;
}

/* ===== Falling Leaf Sprite ===== */

.leaf{
  position:absolute;
  width:28px;
  height:28px;
  pointer-events:none;
  user-select:none;
  will-change: transform, opacity;
}

.leaf img{
  width:100%;
  height:100%;
  object-fit:contain;
  animation: leafSway 3.2s ease-in-out infinite;
}

@keyframes leafSway{
  0%   { transform: rotate(-8deg) translateX(0px); }
  50%  { transform: rotate(8deg)  translateX(6px); }
  100% { transform: rotate(-8deg) translateX(0px); }
}

/* ===== Leaf pile on ground (FIX) ===== */
.leafPile{
  position:absolute;
  left:50%;
  bottom:6px;                 /* —á—É—Ç—å –Ω–∞–¥ –Ω–∏–∂–Ω–∏–º –∫—Ä–∞–µ–º –∑–µ–º–ª–∏ */
  transform: translateX(-50%);
  width:min(320px, 80vw);     /* —á—Ç–æ–± –Ω–∞ –º–æ–±–∏–ª–µ –Ω–µ –±—ã–ª–∞ –æ–≥—Ä–æ–º–Ω–æ–π */
  height:auto;
  pointer-events:none;
  filter: drop-shadow(0 10px 16px rgba(0,0,0,.25));
  opacity: .98;

  animation: pileBreath 4.8s ease-in-out infinite;
  transform-origin: center bottom;
}

/* ===== Leaf pile breathing ===== */

@keyframes pileBreath {
  0%   { transform: translateX(-50%) scale(1); }
  50%  { transform: translateX(-50%) scale(1.035); }
  100% { transform: translateX(-50%) scale(1); }
}

.leafPile{
  animation: pileBreath 4.8s ease-in-out infinite;
  transform-origin: center bottom;
}

/* ===== Bottom Soil Strip (FIX) ===== */
#soilLayer{
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  height:90px;
  pointer-events:none;

  background: url("assets/bg/soil_strip.png") center bottom / 100% 100% no-repeat;
  /* –ö–õ–Æ–ß: 100% 100% —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤ */

  opacity:.95;
  z-index:2;

  mask-image: linear-gradient(to top,
    rgba(0,0,0,1) 0%,
    rgba(0,0,0,1) 65%,
    rgba(0,0,0,0) 100%);
  -webkit-mask-image: linear-gradient(to top,
    rgba(0,0,0,1) 0%,
    rgba(0,0,0,1) 65%,
    rgba(0,0,0,0) 100%);
}

/* ===== Height gauge: ruler –≤–º–µ—Å—Ç–æ –∑–∞–ª–∏–≤–∫–∏ ===== */
#heightFill{ display:none !important; }

#heightBig{
  white-space: nowrap;
}

.hgBar{
  position: relative;
  width: 10px;
  height: 260px;           /* –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å */
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background:
    repeating-linear-gradient(
      to bottom,
      rgba(255,255,255,.55) 0px,
      rgba(255,255,255,.55) 2px,
      rgba(255,255,255,0)   2px,
      rgba(255,255,255,0)   14px
    );
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
}

.currencyLine{
  display:flex;
  align-items:center;
  gap:8px;
}
.currencyIcon{
  width:18px;
  height:18px;
  object-fit:contain;
  display:block;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,.25));
}

/* ===== Cozy Frame Panels ===== */
:root{
  --frame-bg: rgba(0,0,0,.20);
  --frame-line: rgba(255,255,255,.14);
  --frame-line2: rgba(255,255,255,.06);
  --frame-glow: rgba(180,255,210,.10);
  --frame-radius: 20px;
}

.panelFrame{
  border-radius: var(--frame-radius);
  background:
    radial-gradient(900px 360px at 20% 0%, rgba(255,255,255,.06), transparent 60%),
    radial-gradient(700px 280px at 80% 100%, rgba(255,255,255,.04), transparent 55%),
    var(--frame-bg);

  border: 1px solid var(--frame-line);
  box-shadow:
    inset 0 0 0 1px var(--frame-line2),
    0 12px 30px rgba(0,0,0,.28);

  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.panelPad{
  padding: 12px;
}

/* ‚Äú—Ä–∞–º–∫–∞‚Äù –≤–æ–∫—Ä—É–≥ —Å—Ü–µ–Ω—ã (–¥–µ—Ä–µ–≤–æ/–ø–æ–≥–æ–¥–∞) */
.sceneFrame{
  position: relative;
  border-radius: 26px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 14px 40px rgba(0,0,0,.35);
}

/* —Ç–æ–Ω–∫–æ–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º —Å—Ü–µ–Ω—ã */
.sceneFrame::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  border-radius: 26px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06),
              inset 0 0 24px var(--frame-glow);
}

/* ===== Ground Layer (FIX) ===== */
#groundLayer{
  position:absolute;
  left:0;
  right:0;
  bottom:0;

  height:90px;        /* –î–û–õ–ñ–ù–û —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å soilLayer */
  pointer-events:none;

  z-index:3;
}

/* ===== Grow Button ===== */
.btnGrow{
  position:absolute;
  left:50%;
  bottom:110px;              /* –ø–æ–¥–Ω–∏–º–∏/–æ–ø—É—Å—Ç–∏ –µ—Å–ª–∏ –Ω–∞–¥–æ */
  transform: translateX(-50%);
  padding:10px 16px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.28);
  color: var(--text);
  font-weight: 800;
  letter-spacing: .2px;
  box-shadow: 0 10px 24px rgba(0,0,0,.30);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  cursor:pointer;
  z-index: 20;
}
.btnGrow.hidden{ display:none; }

.btnGrow:not(.hidden){
  animation: growPulse 1.6s ease-in-out infinite;
}
@keyframes growPulse{
  0%,100%{ transform: translateX(-50%) scale(1); }
  50%{ transform: translateX(-50%) scale(1.04); }
}

/* ===== Tree fade transition ===== */
#treeImg{
  transition: opacity 420ms ease, transform 900ms ease;
  opacity: 1;
}
#treeImg.fadeOut{ opacity: 0; }

.rewardLine{
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.rewardLine .amount{
  font-weight:800;
}
/* ===== BG FX layer ===== */
#bgFxLayer{
  position:absolute;
  inset:0;
  pointer-events:none;
  overflow:hidden;
  border-radius:16px; /* –µ—Å–ª–∏ bgLayer/scene —Å–æ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º */
}

/* –æ–¥–∏–Ω —à–∞—Ä */
.bgBalloon{
  position:absolute;
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;

  /* "–≤–¥–∞–ª–µ–∫–µ": –º—è–≥—á–µ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ */
  opacity:1;
  filter: drop-shadow(0 6px 8px rgba(0,0,0,.12));

  animation: balloonFloat 10s ease-in-out infinite;
}

@keyframes balloonFloat{
  0%   { transform: translateY(0px); }
  50%  { transform: translateY(-14px); }
  100% { transform: translateY(0px); }
}

/* –∑–≤–µ–∑–¥–∞ */
.nightStar{
  position:absolute;
  width:3px;
  height:3px;
  border-radius:999px;
  background: rgba(255,255,255,.9);
  box-shadow: 0 0 10px rgba(255,255,255,.45);
  opacity:.0;
  animation: starTwinkle 2.8s ease-in-out infinite;
}

@keyframes starTwinkle{
  0%   { opacity: 0.05; transform: scale(0.9); }
  45%  { opacity: 0.85; transform: scale(1.15); }
  100% { opacity: 0.08; transform: scale(0.95); }
}

#heightRuler{
  position:absolute;
  left:10px;
  top:110px;
  bottom:18px;

  width:34px;
  height: calc(100% - 110px - 18px); /* –í–û–¢ –≠–¢–û —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç */

  object-fit: fill;      /* –Ω–∞–º –Ω–µ –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, –º—ã —Ç—è–Ω–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ */
  pointer-events:none;
  z-index:6;
  opacity:.95;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
}

/* ===== Meditation Overlay ===== */
#medOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}
#medOverlay.hidden{ display:none; }

#medOverlay .medBox{
  width: min(420px, 88vw);
  border-radius: 18px;
  background: rgba(20,25,45,.75);
  border: 1px solid rgba(255,255,255,.10);
  padding: 18px 16px;
  text-align: center;
  backdrop-filter: blur(10px);
}

#medBig{
  font-size: 72px;
  font-weight: 900;
  line-height: 1;
  margin: 6px 0 10px;
  color: #fff;
  text-shadow: 0 10px 30px rgba(0,0,0,.35);
}

#medSmall{
  font-size: 16px;
  opacity: .9;
  color: rgba(255,255,255,.92);
}

    
  </style>
</head>

<body>



  <div class="app">
    <header>
      <div>
        <div class="title">üå≥ –î—É—Ö –î–µ—Ä–µ–≤–∞ (MVP)</div>
      </div>
      <button class="btnDanger" id="btnReset" type="button">–°–±—Ä–æ—Å</button>
    </header>

    <div class="wrap">

        <div id="langModal" class="quoteModal hidden">
  <div class="quoteBox">
    <div class="quoteTitle" id="langTitle"></div>
    <div style="margin-top:10px;">
      <button id="btnLangEn" class="quoteBtn"></button>
      <button id="btnLangRu" class="quoteBtn"></button>
    </div>
  </div>
</div>

  <!-- QUIZ -->
  <div class="quiz" id="quiz">
    <div class="qTitle">üå≥ –í—ã–±–æ—Ä –î—É—Ö–∞ –î–µ—Ä–µ–≤–∞</div>
    <div class="qSub">–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 4 –≤–æ–ø—Ä–æ—Å–∞, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –¥–µ—Ä–µ–≤–æ.</div>

    <div class="qCard">
      <div class="qQuestion">1) –ì–¥–µ –≤–∞—à–µ–º—É –î—É—Ö—É —Å–ø–æ–∫–æ–π–Ω–µ–µ?</div>
      <div class="qOptions">
        <button class="qOpt" type="button" data-q="q1" data-a="forest">
          <span class="qOptImg"><img data-img="forest" alt=""></span>
          <span class="qOptText"><b>–í –≥—É—Å—Ç–æ–º –ª–µ—Å—É</b><small>—Ç–µ–Ω—å, —Ç–∏—à–∏–Ω–∞</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q1" data-a="meadow">
          <span class="qOptImg"><img data-img="meadow" alt=""></span>
          <span class="qOptText"><b>–ù–∞ –ø–æ–ª—è–Ω–µ</b><small>–ø—Ä–æ—Å—Ç–æ—Ä, —Å–≤–µ—Ç</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q1" data-a="water">
          <span class="qOptImg"><img data-img="water" alt=""></span>
          <span class="qOptText"><b>–£ –≤–æ–¥—ã</b><small>–¥–≤–∏–∂–µ–Ω–∏–µ, –≥–ª—É–±–∏–Ω–∞</small></span>
        </button>
      </div>
    </div>

    <div class="qCard">
      <div class="qQuestion">2) –ö–æ–≥–¥–∞ –≤—Å—ë –ø–æ—à–ª–æ –Ω–µ –ø–æ –ø–ª–∞–Ω—É, –≤—ã‚Ä¶</div>
      <div class="qOptions">
        <button class="qOpt" type="button" data-q="q2" data-a="rock">
          <span class="qOptImg"><img data-img="rock" alt=""></span>
          <span class="qOptText"><b>–°—Ç–æ–∏—Ç–µ –∫–∞–∫ —Å–∫–∞–ª–∞</b><small>—É–ø—Ä—è–º—Å—Ç–≤–æ</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q2" data-a="adapt">
          <span class="qOptImg"><img data-img="adapt" alt=""></span>
          <span class="qOptText"><b>–ì–Ω—ë—Ç–µ—Å—å, –º–µ–Ω—è–µ—Ç–µ—Å—å, –Ω–æ –≤—ã–∂–∏–≤–∞–µ—Ç–µ</b><small>–∞–¥–∞–ø—Ç–∞—Ü–∏—è</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q2" data-a="wait">
          <span class="qOptImg"><img data-img="wait" alt=""></span>
          <span class="qOptText"><b>–ü–µ—Ä–µ–∂–∏–¥–∞–µ—Ç–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ—Å—å</b><small>–≤—ã–¥–µ—Ä–∂–∫–∞</small></span>
        </button>
      </div>
    </div>

    <div class="qCard">
      <div class="qQuestion">3) –í–∞—à –≥–ª–∞–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π</div>
      <div class="qOptions">
        <button class="qOpt" type="button" data-q="q3" data-a="wise">
          <span class="qOptImg"><img data-img="wise" alt=""></span>
          <span class="qOptText"><b>–ú—É–¥—Ä–æ—Å—Ç—å –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ</b></span>
        </button>

        <button class="qOpt" type="button" data-q="q3" data-a="drive">
          <span class="qOptImg"><img data-img="drive" alt=""></span>
          <span class="qOptText"><b>–≠–Ω–µ—Ä–≥–∏—è –∏ –¥–≤–∏–∂–µ–Ω–∏–µ</b></span>
        </button>

        <button class="qOpt" type="button" data-q="q3" data-a="care">
          <span class="qOptImg"><img data-img="care" alt=""></span>
          <span class="qOptText"><b>–ù–µ–∂–Ω–æ—Å—Ç—å –∏ –∑–∞–±–æ—Ç–∞</b></span>
        </button>

        <button class="qOpt" type="button" data-q="q3" data-a="magic">
          <span class="qOptImg"><img data-img="magic" alt=""></span>
          <span class="qOptText"><b>–¢–∞–π–Ω–∞ –∏ –º–∞–≥–∏—è</b></span>
        </button>
      </div>
    </div>

    <div class="qCard">
      <div class="qQuestion">4) –õ—é–±–∏–º–æ–µ –≤—Ä–µ–º—è –≥–æ–¥–∞</div>
      <div class="qOptions">
        <button class="qOpt" type="button" data-q="q4" data-a="winter">
          <span class="qOptImg"><img data-img="winter" alt=""></span>
          <span class="qOptText"><b>–ó–∏–º–∞</b><small>—è—Å–Ω–æ—Å—Ç—å –∏ —Ç–∏—à–∏–Ω–∞</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q4" data-a="spring">
          <span class="qOptImg"><img data-img="spring" alt=""></span>
          <span class="qOptText"><b>–í–µ—Å–Ω–∞</b><small>–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q4" data-a="summer">
          <span class="qOptImg"><img data-img="summer" alt=""></span>
          <span class="qOptText"><b>–õ–µ—Ç–æ</b><small>—è—Ä–∫–æ—Å—Ç—å</small></span>
        </button>

        <button class="qOpt" type="button" data-q="q4" data-a="autumn">
          <span class="qOptImg"><img data-img="autumn" alt=""></span>
          <span class="qOptText"><b>–û—Å–µ–Ω—å</b><small>–º—è–≥–∫–∞—è –≥–ª—É–±–∏–Ω–∞</small></span>
        </button>
      </div>
    </div>
    
      <div class="quizFooter">
    <span class="pill" id="quizProgress">0/4</span>
    <button id="btnQuizReset" type="button" class="btnDanger">–°–±—Ä–æ—Å–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
  </div>
   </div>

  <!-- RESULT -->
  <div class="result" id="result">
    <div class="rTitle">üåø –í–∞—à –î—É—Ö –î–µ—Ä–µ–≤–∞</div>
    <div class="rSub">–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ä–µ–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—á–µ—Ç—Å—è –≤—ã—Ä–∞—â–∏–≤–∞—Ç—å.</div>

    <div class="rGrid" id="resultGrid"></div>

    <div class="rActions">
      <button id="btnResultBack" type="button">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–µ—Å—Ç—É</button>
    </div>
  </div>
  
   <!--shop-->
   <div class="decor" id="decor" style="display:none; border:1px solid var(--line); background: rgba(15,23,48,.55); border-radius:16px; padding:12px; margin-bottom:12px;">
  <div class="rTitle">ü™µ –£–∫—Ä–∞—à–µ–Ω–∏—è</div>
  <div class="rSub">–°–¥–µ–ª–∞–π—Ç–µ –º–µ—Å—Ç–æ —É—é—Ç–Ω–µ–µ. –ü–æ–∫—É–ø–∫–∞ –∑–∞ –ª–∏—Å—Ç—å—è.</div>

  <div id="shopTabs" class="shopTabs"></div>
<div id="shopWallet" class="shopWallet"></div>

  <div class="rGrid" id="decorGrid"></div>

  <div class="rActions">
    <button id="btnDecorBack" type="button">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
</div>

 <!-- TOP HUD (1-4 + 16-18) -->
<div class="hudTop" id="hudTop">
  <div class="hudRow">
    <!-- 1 XP -->
    <div class="pill">
      <div class="pillK">XP</div>
      <div class="pillV" id="xpTextMini">‚Äî</div>
      <div class="pillBar"><div id="xpBar"></div></div>
    </div>

    <!-- 2 HP -->
    <div class="pill">
      <div class="pillK">HP</div>
      <div class="pillV" id="healthText">‚Äî</div>
      <div class="pillBar"><div id="healthBar"></div></div>
    </div>

    <!-- 3 Bugs -->
    <div class="pill">
      <div class="pillK">Bugs</div>
      <div class="pillV" id="pestsText">‚Äî</div>
      <div class="pillBar"><div id="pestsBar"></div></div>
    </div>

    <!-- 4 Water -->
    <div class="pill">
      <div class="pillK">Water</div>
      <div class="pillV" id="waterText">‚Äî</div>
      <div class="pillBar"><div id="waterBar"></div></div>
    </div>
  </div>
  
  <div id="weatherBar" class="weatherBar">
  <span id="weatherText">–ü–æ–≥–æ–¥–∞: ‚Ä¶</span>
  <button id="weatherRefresh" class="weatherBtn" type="button">‚Üª</button>
</div>

  <div class="hudRow">
    <!-- 16 Fruits -->
    <div class="pillSmall">
  <img src="icons/fruit.png" class="currencyIcon">
  <span class="pillV" id="invFruits">0</span>
</div>

    <!-- 17 Essence -->
    <div class="pillSmall">
  <img src="icons/essence.png" class="currencyIcon">
  <span class="pillV" id="invEssence">0</span>
</div>

    <!-- 18 Leaves -->
    <div class="pillSmall">
  <img src="icons/leaves.png" class="currencyIcon">
  <span class="pillV" id="invLeaves">0</span>
</div>

  </div>
</div>

<div id="buffLine" class="buffLine" style="display:none;"></div>

<!-- TODAY / DAILY TASKS -->
<div class="card todayCard" id="todayCard" style="display:none;">
  <div class="row" style="align-items:flex-start;">
    <div>
      <div class="listTitle">üìå –°–µ–≥–æ–¥–Ω—è</div>
      <div class="listSub" id="todaySub">–°–¥–µ–ª–∞–π 3 –º–∞–ª–µ–Ω—å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è –∏ –∑–∞–±–µ—Ä–∏ –º–µ—à–æ—á–µ–∫.</div>
    </div>
    <button class="btn small" id="btnDailyClaim" type="button" style="display:none;">üéÅ –ó–∞–±—Ä–∞—Ç—å</button>
  </div>

  <div class="sep"></div>

  <div class="todayList" id="todayList">
    <!-- —Ç—É—Ç JS –Ω–∞—Ä–∏—Å—É–µ—Ç –∑–∞–¥–∞—á–∏ -->
  </div>
</div>
 
 <!-- MAIN SCENE -->
    <div class="scene" id="scene">
  <div id="bgLayer"></div>
  <div class="glow"></div>
  <div id="bgFxLayer"></div>
  <div id="nightStarsLayer" class="layerFull"></div>

  <div id="soilLayer"></div>
  <div id="weatherLayer" class="layerFull"></div>
  <div id="dropsLayer"></div>
  <div id="frostOverlay"></div>
  <div id="heightGauge">
  <div id="heightBig" class="hgValue">‚Äî</div>
  <div class="hgBar">
    <div id="heightFill"></div>
  </div>
</div>
  <div id="weatherFX" class="weatherFX weather-none">
  <div class="fx fx-rain"></div>
  <div class="fx fx-snow"></div>
  <div class="fx fx-sun"></div>
</div>
  <div class="tree" id="tree">
  <div id="treeSway">
    <img id="treeImg" alt="" style="width:120px;height:120px;object-fit:contain;">
  </div>
</div>

<button id="btnGrow" class="btnGrow hidden" type="button"></button>

<div id="dayNightLayer" class="layerFull"></div>

<!-- groundLayer –¥–µ–ª–∞–µ–º –≤—ã—à–µ, —á—Ç–æ–±—ã –∫—É—á–∫–∞ –ª–∏—Å—Ç—å–µ–≤ –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∞—Å—å -->
<div id="groundLayer" style="position:absolute; left:0; right:0; bottom:0; height:120px; pointer-events:none;"></div>

  <div id="groundCounter" style="position:absolute; left:44px; bottom:10px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(0,0,0,.22); color: var(--text); font-size:12px; font-weight:800; display:none;">
    üçÉ <span id="groundCount">0</span>
  </div>
 <div id="decorLayer" class="layerFull"></div>
  
  <!-- RIGHT ACTIONS (7-9 + 20) -->
<div class="hudRight" id="hudRight">
<button class="iconBtn" id="btnMeditate" type="button" title="Meditate">
    <img src="icons/meditate.png" class="btnIcon" alt="">
  </button>

  <button class="iconBtn" id="btnClean" type="button" title="Bugs">
    <img src="icons/bugs.png" class="btnIcon" alt="">
  </button>

  <button class="iconBtn" id="btnWater" type="button" title="Water">
    <img src="icons/water.png" class="btnIcon" alt="">
  </button>

  <button class="iconBtn" id="btnCollect" type="button" title="Collect">
    <img src="icons/leaves.png" class="btnIcon" alt="">
  </button>

  <button class="iconBtn" id="btnShop" type="button" title="Shop">
    <img src="icons/shop.png" class="btnIcon" alt="">
  </button>
</div>
</div>
      
      <div class="log" id="log"></div>
    </div>
  </div>

  <!-- Motivational Quote Popup -->
<div id="quoteModal" class="quoteModal hidden" role="dialog" aria-modal="true">
  <div class="quoteBox">
    <div class="quoteTitle" id="quoteTitle">–¶–∏—Ç–∞—Ç–∞</div>
    <div class="quoteText" id="quoteText"></div>
    <button class="quoteBtn" id="quoteBtn" type="button">–û–∫</button>
  </div>
</div>

<!-- Reward Popup -->
<div id="rewardModal" class="quoteModal hidden" role="dialog" aria-modal="true">
  <div class="quoteBox">
    <div class="quoteTitle" id="rewardTitle">üéÅ –ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞</div>
    <div class="quoteText" id="rewardText"></div>
    <button class="quoteBtn" id="rewardBtn" type="button">–û–∫</button>
  </div>
</div>

<!-- Photo popup -->
<div id="photoModal" class="quoteModal hidden" role="dialog" aria-modal="true">
  <div class="quoteBox">
    <div class="quoteTitle">üì∏ –§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ</div>
    <div class="quoteText" id="photoInfo"></div>

    <div style="margin-top:10px; border:1px solid rgba(255,255,255,.10); border-radius:14px; overflow:hidden;">
      <img id="photoPreview" alt="" style="width:100%; display:block;">
    </div>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="quoteBtn" id="btnPhotoSave" type="button">–°–∫–∞—á–∞—Ç—å PNG</button>
      <button class="quoteBtn" id="btnPhotoClose" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- ===== Meditation Overlay (countdown + breathing) ===== -->
<div id="medOverlay" class="hidden">
  <div class="medBox">
    <div id="medBig">5</div>
    <div id="medSmall"></div>
  </div>
</div>

  <script>
      
    // ============================
// MULTI-LANG (EN / RU)
// ============================

const LANGS = ["en","ru"];

// –≤—Å–µ —Ç–µ–∫—Å—Ç—ã
const TEXTS = {
  en: {
    morningTitle: "Good morning ‚òÄÔ∏è",
    nightTitle:   "Good night üåô",
    morningQuotes: [
      "A new day is like a blank page. You can start fresh.",
      "Small steps forward are still steps.",
      "The quiet breath of the world is a kind of magic.",
      "You don't need to be perfect. Just present.",
      "Even slow progress is still progress.",
      "Let the sun warm your mind today.",
      "Start your day with calm intention.",
      "Light grows from the smallest spark.",
      "Today is another chance to be gentle with yourself.",
      "You are enough simply by being."
    ],
    nightQuotes: [
      "The day is done. That is enough.",
      "Rest is part of the path, not a pause from it.",
      "Night restores what busyness wears down.",
      "Let go of what didn‚Äôt go as planned.",
      "Even small efforts mattered today.",
      "You lived this day. That counts.",
      "Allow yourself to slow down.",
      "Tomorrow you continue. Tonight you rest.",
      "The quiet dark is healing.",
      "Peaceful night. You did well."
    ],
    growBtn: "Grow",
    chooseLang: "Select your language:",
    langEn: "English",
    langRu: "–†—É—Å—Å–∫–∏–π",
    ok: "Ok",

    med_title: "Meditation",
med_text: "Close your eyes and listen. With every sound cue, inhale and exhale. Relax.",
med_used_day: "You already meditated today (day).",
med_used_night: "You already meditated today (night).",
med_ready: "Get ready‚Ä¶",
med_inhale: "Inhale",
med_exhale: "Exhale",
med_done: "Done."

  },
  ru: {
    morningTitle: "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ ‚òÄÔ∏è",
    nightTitle:   "–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏ üåô",
    morningQuotes: [
      "–ù–æ–≤—ã–π –¥–µ–Ω—å ‚Äî —ç—Ç–æ —á–∏—Å—Ç—ã–π –ª–∏—Å—Ç. –ù–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ.",
      "–ú–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ ‚Äî —Ç–æ–∂–µ –¥–≤–∏–∂–µ–Ω–∏–µ.",
      "–¢–∏—Ö–∏–π –≤–¥–æ—Ö –º–∏—Ä–∞ ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –º–∞–≥–∏—è.",
      "–ù–µ –Ω—É–∂–Ω–æ –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–º, –±—É–¥—å –Ω–∞—Å—Ç–æ—è—â–∏–º.",
      "–î–∞–∂–µ –º–µ–¥–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å.",
      "–ü—É—Å—Ç—å —Å–æ–ª–Ω—Ü–µ —Å–æ–≥—Ä–µ–µ—Ç —Ç–≤–æ–∏ –º—ã—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è.",
      "–ù–∞—á–Ω–∏ –¥–µ–Ω—å —Å —Ç–∏—à–∏–Ω—ã –Ω–∞–º–µ—Ä–µ–Ω–∏—è.",
      "–°–≤–µ—Ç —Ä–∞—Å—Ç—ë—Ç –∏–∑ –º–∞–ª–µ–Ω—å–∫–æ–π –∏—Å–∫—Ä—ã.",
      "–°–µ–≥–æ–¥–Ω—è ‚Äî —à–∞–Ω—Å –±—ã—Ç—å –¥–æ–±—Ä–µ–µ –∫ —Å–µ–±–µ.",
      "–¢—ã —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã –µ—Å—Ç—å."
    ],
    nightQuotes: [
      "–î–µ–Ω—å –æ–∫–æ–Ω—á–µ–Ω. –≠—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.",
      "–û—Ç–¥—ã—Ö ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –ø—É—Ç–∏.",
      "–ù–æ—á—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–æ, —á—Ç–æ –∏–∑–Ω–∞—à–∏–≤–∞–µ—Ç —Å–ø–µ—à–∫–∞.",
      "–û—Ç–ø—É—Å—Ç–∏ —Ç–æ, —á—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å.",
      "–î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–µ —É—Å–∏–ª–∏—è –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.",
      "–¢—ã –ø—Ä–æ–∂–∏–ª —ç—Ç–æ—Ç –¥–µ–Ω—å. –≠—Ç–æ —É–∂–µ –≤–∞–∂–Ω–æ.",
      "–ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è.",
      "–ó–∞–≤—Ç—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—à—å. –°–µ–≥–æ–¥–Ω—è –æ—Ç–¥—ã—Ö–∞–π.",
      "–¢–∏—Ö–∞—è —Ç–µ–º–Ω–æ—Ç–∞ –ª–µ—á–∏—Ç.",
      "–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏. –¢—ã –º–æ–ª–æ–¥–µ—Ü."
    ],

    
    growBtn: "–í—ã—Ä–∞—Å—Ç–∏",
    chooseLang: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
    langEn: "English",
    langRu: "–†—É—Å—Å–∫–∏–π",
    ok: "–û–∫",

    med_title: "–ú–µ–¥–∏—Ç–∞—Ü–∏—è",
med_text: "–ó–∞–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞ –∏ —Å–ª—É—à–∞–π—Ç–µ. –ü–æ–¥ –∫–∞–∂–¥—ã–π –∑–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª –¥–µ–ª–∞–π—Ç–µ –≤–¥–æ—Ö –∏ –≤—ã–¥–æ—Ö. –†–∞—Å—Å–ª–∞–±—å—Ç–µ—Å—å.",
med_used_day: "–°–µ–≥–æ–¥–Ω—è –¥–Ω—ë–º –º–µ–¥–∏—Ç–∞—Ü–∏—è —É–∂–µ –±—ã–ª–∞.",
med_used_night: "–°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é –º–µ–¥–∏—Ç–∞—Ü–∏—è —É–∂–µ –±—ã–ª–∞.",
med_ready: "–ì–æ—Ç–æ–≤—å—Å—è‚Ä¶",
med_inhale: "–í–¥–æ—Ö",
med_exhale: "–í—ã–¥–æ—Ö",
med_done: "–ì–æ—Ç–æ–≤–æ."

  }
};

function showLangChoice(){
  const modal = document.getElementById("langModal");
  const btnEn = document.getElementById("btnLangEn");
  const btnRu = document.getElementById("btnLangRu");

  if(!modal || !btnEn || !btnRu) return;

  document.getElementById("langTitle").textContent = t("chooseLang");
  btnEn.textContent = t("langEn");
  btnRu.textContent = t("langRu");

  modal.classList.remove("hidden");

  const close = () => {
    modal.classList.add("hidden");
    render(state); 
    maybeShowDailyQuote(); 
  };

  btnEn.onclick = () => { setLang("en"); close(); };
  btnRu.onclick = () => { setLang("ru"); close(); };
}

function getLang(){
  return localStorage.getItem("gameLang") || null;
}

function setLang(l){
  if(!LANGS.includes(l)) return;
  localStorage.setItem("gameLang", l);
}

function t(key){
  const lang = getLang() || "en";
  return TEXTS[lang][key] ?? "";
}

function tRandom(key){
  const arr = TEXTS[getLang()||"en"][key] || [];
  return arr[Math.floor(Math.random()*arr.length)] || "";
}
      
    // =========================
    // 1) –£—Ç–∏–ª–∏—Ç—ã
    // =========================

    let mainButtonsBound = false;

function bindMainButtons(){
  if(mainButtonsBound) return;
  mainButtonsBound = true;

  // –∫–Ω–æ–ø–∫–∏ —Å—Ü–µ–Ω—ã
  el("btnWater")?.addEventListener("click", doWater);
  el("btnClean")?.addEventListener("click", doClean);
  document.getElementById("btnFertilize")?.addEventListener("click", doFertilize);
  document.getElementById("btnMeditate")?.addEventListener("click", doMeditate);

  document.getElementById("btnShop")?.addEventListener("click", () => {
  showDecor(true); // showDecor —Å–∞–º –≤—ã–∑–æ–≤–µ—Ç ensureShop() –∏ renderShop()
});

  const back = el("btnDecorBack");
  if(back) back.addEventListener("click", () => {
    showDecor(false);
    render(state);
  });

  el("btnReset")?.addEventListener("click", () => {
    state = defaultState();
    saveState(state);
    log("üß® –°–±—Ä–æ—Å–∏–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å. –î–µ—Ä–µ–≤–æ –ø–µ—Ä–µ—Ä–æ–¥–∏–ª–æ—Å—å.");
    showResult(false);
    showQuiz(true);
    updateQuizProgress();
    setMainUIVisible(false);
    render(state);
  });
}

    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    let worldStarted = false;
    const nowMs = () => Date.now();

    function isNightByLocalTime(){
  const h = new Date().getHours();
  // –¥–µ–ª–∞–µ–º "–Ω–æ—á—å" —Å 18:00 –¥–æ 04:00, —á—Ç–æ–±—ã —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å –≤–µ—á–µ—Ä–Ω–∏–º –ø–µ—Ä–∏–æ–¥–æ–º
  return (h >= 18 || h < 4);
}
    
    function heightMetersByLevel(level){
  const base = 0.03; // 3 —Å–º –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
  return +(base * Math.pow(1.65, level)).toFixed(2);
}

function canGrowNow(s){
  if(!s) return false;
  if(s.stage == null) s.stage = 0;
  if(!STAGES || !STAGES.length) return false;
  if(s.stage >= STAGES.length - 1) return false;

  const need = STAGES[s.stage].xpToNext || 0;
  return (s.xp || 0) >= need;
}

function updateGrowButton(s){
  const btn = document.getElementById("btnGrow");
  if(!btn) return;

  btn.textContent = t("growBtn");

  if(canGrowNow(s)){
    btn.classList.remove("hidden");
  }else{
    btn.classList.add("hidden");
  }
}

function doGrowStage(){
  // 1) –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –µ—â—ë –Ω–µ –ø–æ—Ä–∞ - –≤—ã—Ö–æ–¥–∏–º
  if(!canGrowNow(state)) return;

  const img = document.getElementById("treeImg");
  if(!img) return;

  // 2) –≥–∞—Å–∏–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
  img.classList.add("fadeOut");

  // 3) –ø–æ—Å–ª–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –¥–µ–ª–∞–µ–º –∞–ø —Å—Ç–∞–¥–∏–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
  setTimeout(() => {
    let grew = 0;

    while(canGrowNow(state)){
      const need = STAGES[state.stage].xpToNext || 0;
      state.xp -= need;
      state.stage += 1;
      grew += 1;

      // –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ —Ä–æ—Å—Ç —Å—Ç–∞–¥–∏–∏ (—Ç–æ, —á—Ç–æ —Ä–∞–Ω—å—à–µ –¥–µ–ª–∞–ª–æ—Å—å –∞–≤—Ç–æ)
      state.inventory.fruits = (state.inventory.fruits || 0) + Math.round((state.stage + 1) * 1);
      state.inventory.essence = (state.inventory.essence || 0) + 1;
    }

    saveState(state);

    // 4) –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã img.src –æ–±–Ω–æ–≤–∏–ª—Å—è –Ω–∞ –Ω–æ–≤—É—é —Å—Ç–∞–¥–∏—é/—É—Ä–æ–≤–µ–Ω—å
    render(state);

    // 5) –≤–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤–∏–¥–∏–º–æ—Å—Ç—å (–Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è)
    requestAnimationFrame(() => {
      img.classList.remove("fadeOut");
    });

    // 6) –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
    updateGrowButton(state);

  }, 430);
}

function fmtLeft(ms){
  if(ms <= 0) return "–Ω–µ—Ç";
  const m = Math.ceil(ms / 60000);
  const h = Math.floor(m / 60);
  const mm = m % 60;
  if(h <= 0) return `${mm}–º`;
  return `${h}—á ${mm}–º`;
}

function setupParallax(){
  const scene = document.getElementById("scene");
  if(!scene) return;

  const glow = scene.querySelector(".glow");
  const weather = document.getElementById("weatherLayer");
  const night = document.getElementById("dayNightLayer");
  const ground = document.getElementById("groundLayer");
  const decor = document.getElementById("decorLayer");
  const tree = document.getElementById("tree");

  let tx = 0, ty = 0; // target (-1..1)
  let x = 0, y = 0;   // current
  let raf = 0;
  let sx = 0, sy = 0; // —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

function apply(){
  raf = 0;

  // –∏–Ω–µ—Ä—Ü–∏—è: —á–µ–º –º–µ–Ω—å—à–µ —á–∏—Å–ª–æ, —Ç–µ–º –ø–ª–∞–≤–Ω–µ–µ (0.08‚Äì0.18)
  const k = 0.10;

  // –¥–æ–≥–æ–Ω—è–µ–º —Ü–µ–ª—å
  sx += (tx - sx) * k;
  sy += (ty - sy) * k;

  const x = (sx * 7).toFixed(2);
  const y = (sy * 4).toFixed(2);

  const bg = document.getElementById("bgLayer");
  if(bg){
    bg.style.transform = `translate3d(${x}px, ${y}px, 0) scale(1.08)`;
  }

  const bgFx = document.getElementById("bgFxLayer");
  if(bgFx){
    bgFx.style.transform = `translate3d(${(sx * 12).toFixed(2)}px, ${(sy * 7.2).toFixed(2)}px, 0)`;
  }

  // –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–∫–∞ –Ω–µ –ø–æ—á—Ç–∏ –Ω–∞ –º–µ—Å—Ç–µ
  if(Math.abs(tx - sx) > 0.001 || Math.abs(ty - sy) > 0.001){
    raf = requestAnimationFrame(apply);
  }
}

  function setTargetFromEvent(e){
    const r = scene.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;

    const px = (e.clientX - cx) / (r.width/2);
    const py = (e.clientY - cy) / (r.height/2);

    tx = Math.max(-1, Math.min(1, px));
    ty = Math.max(-1, Math.min(1, py));

    if(!raf) raf = requestAnimationFrame(apply);
  }

  function resetTarget(){
    tx = 0; ty = 0;
    if(!raf) raf = requestAnimationFrame(apply);
  }

  scene.addEventListener("pointermove", setTargetFromEvent);

  // –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö ‚Äú–∑–∞–ª–∏–ø–∞–µ—Ç‚Äù, –µ—Å–ª–∏ –ø–∞–ª–µ—Ü –æ—Ç–ø—É—Å—Ç–∏–ª–∏ –≤ —É–≥–ª—É
  scene.addEventListener("pointerup", resetTarget);
  scene.addEventListener("pointercancel", resetTarget);
  scene.addEventListener("pointerleave", resetTarget);

  // —á—Ç–æ–±—ã —Å–æ–±—ã—Ç–∏—è —à–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ
  try { scene.style.touchAction = "none"; } catch(e){}
}

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function yesterdayKey(){
  const d = new Date(Date.now() - 86400000);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function ensureDailyToday(s){
  s.daily = s.daily || { lastMeditateDay:null, streak:0, total:0, today:{date:null, tasks:{water:0, clean:0, meditate:0}, claimed:false} };
  s.daily.today = s.daily.today || { date:null, tasks:{water:0, clean:0, meditate:0}, claimed:false };

  const t = todayKey();
  if(s.daily.today.date !== t){
    s.daily.today.date = t;
    s.daily.today.tasks = { water:0, clean:0, meditate:0 };
    s.daily.today.claimed = false;
  }
}

function dailyProgress(s){
  ensureDailyToday(s);
  const tt = s.daily.today.tasks;
  const done = (tt.water?1:0) + (tt.clean?1:0) + (tt.meditate?1:0);
  return { done, total: 3 };
}

function markDailyTask(s, key){
  ensureDailyToday(s);
  if(!s.daily.today.tasks[key]){
    s.daily.today.tasks[key] = 1;
    saveState(s);
  }
}

function claimDailyBag(){
  const s = state;
  ensureDailyToday(s);
  const prog = dailyProgress(s);

  if(prog.done < prog.total){
    log("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –¥–Ω—è üôÇ");
    return;
  }
  if(s.daily.today.claimed){
    log("–ú–µ—à–æ—á–µ–∫ —É–∂–µ –∑–∞–±—Ä–∞–Ω —Å–µ–≥–æ–¥–Ω—è.");
    return;
  }

  s.daily.today.claimed = true;

  // --- 1) –≤—ã–¥–∞—ë–º –Ω–∞–≥—Ä–∞–¥—ã –∏ —Å–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞–≥—Ä–∞–¥ ---
  const lines = [];

  const baseLeaves = 25;
  s.inventory.leaves += baseLeaves;
  lines.push(`
  <span class="rewardLine">
    <span class="amount">+${baseLeaves}</span>
    <img class="currencyIcon" src="icons/leaves.png">
    <span>–õ–∏—Å—Ç—å—è</span>
  </span>
`);

  const r = Math.random();
  if(r < 0.35){
    // —É–¥–æ–±—Ä–µ–Ω–∏–µ –Ω–∞ 2 —á–∞—Å–∞
    const addMs = 2 * 60 * 60 * 1000;
    const now = nowMs();
    s.growthBuffUntil = Math.max(s.growthBuffUntil || 0, now) + addMs;
    lines.push(`
  <span class="rewardLine">
    <img class="currencyIcon" src="icons/essence.png">
    <span>–£–¥–æ–±—Ä–µ–Ω–∏–µ: 2 —á–∞—Å–∞</span>
  </span>
`);
  } else if(r < 0.55){
    s.inventory.fruits += 1;
    lines.push(`
  <span class="rewardLine">
    <span class="amount">+1</span>
    <img class="currencyIcon" src="icons/fruit.png">
    <span>–ü–ª–æ–¥</span>
  </span>
`);
  } else if(r < 0.70){
    s.inventory.essence += 1;
    lines.push(`
  <span class="rewardLine">
    <span class="amount">+1</span>
    <img class="currencyIcon" src="icons/essence.png">
    <span>–≠—Å—Å–µ–Ω—Ü–∏—è</span>
  </span>
`);
  } else {
    // —Ç–æ–ª—å–∫–æ –ª–∏—Å—Ç—å—è, —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏
  }

  // --- 2) —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –æ–±–Ω–æ–≤–ª—è–µ–º UI ---
  saveState(s);
  render(s);

  // --- 3) —Å–∫—Ä—ã–≤–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –Ω–∞–≥—Ä–∞–¥—ã ---
  const card = el("todayCard");
  if(card) card.style.display = "none";

  showRewardModal(lines.join(""));
}

function renderToday(s){
  const card = el("todayCard");
  if(!card) return;

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–µ—Ä–µ–≤–æ –≤—ã–±—Ä–∞–Ω–æ
  if(!s.treeId){
    card.style.display = "none";
    return;
  }

  ensureDailyToday(s);
const prog = dailyProgress(s);

// ‚úÖ –ï—Å–ª–∏ –º–µ—à–æ—á–µ–∫ —É–∂–µ –∑–∞–±—Ä–∞–Ω —Å–µ–≥–æ–¥–Ω—è ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –µ–∂–µ–¥–Ω–µ–≤–æ–∫
if(s.daily.today.claimed){
  card.style.display = "none";
  return;
}

card.style.display = "";

  const sub = el("todaySub");
  if(sub) sub.textContent = `–°–¥–µ–ª–∞–π 3 –ø—Ä–æ—Å—Ç—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è: ${prog.done}/3`;

  const list = el("todayList");
  if(list){
    const t = s.daily.today.tasks;
    
  const scene = el("scene");
if(scene){
  scene.classList.toggle("snow", (s.weather || "sun") === "snow");
}

    list.innerHTML = `
      <div class="todayItem ${t.water ? "todayDone" : ""}">
        <div class="todayLeft">
          <div class="todayCheck">${t.water ? "‚úì" : ""}</div>
          <div class="todayText"><b>–ü–æ–ª–µ–π 1 —Ä–∞–∑</b><small>–¥–∞–π –≤–æ–¥—ã –¥–µ—Ä–µ–≤—É</small></div>
        </div>
        <div class="todayReward">+ –ª–∏—Å—Ç—å—è</div>
      </div>

      <div class="todayItem ${t.clean ? "todayDone" : ""}">
        <div class="todayLeft">
          <div class="todayCheck">${t.clean ? "‚úì" : ""}</div>
          <div class="todayText"><b>–£–±–µ—Ä–∏ –∂—É–∫–æ–≤</b><small>–∑–∞—â–∏—Ç–∞ –∏ –∑–∞–±–æ—Ç–∞</small></div>
        </div>
        <div class="todayReward">+ –ª–∏—Å—Ç—å—è</div>
      </div>

      <div class="todayItem ${t.meditate ? "todayDone" : ""}">
        <div class="todayLeft">
          <div class="todayCheck">${t.meditate ? "‚úì" : ""}</div>
          <div class="todayText"><b>–ú–µ–¥–∏—Ç–∏—Ä—É–π 1 —Ä–∞–∑</b><small>—Ç–∏—Ö–∏–π –±–æ–Ω—É—Å</small></div>
        </div>
        <div class="todayReward">+ –ª–∏—Å—Ç—å—è</div>
      </div>
    `;
  }

  const btn = el("btnDailyClaim");
  if(btn){
    const canClaim = (prog.done === prog.total) && !s.daily.today.claimed;
    btn.style.display = canClaim ? "" : "none";
  }
}

    // =========================
    // 2) –î–∞–Ω–Ω—ã–µ (—Å—Ç–∞–¥–∏–∏)
    // =========================
    const STAGES = [
       
      { name:"–°–µ–º–µ—á–∫–æ", icon:"üå∞", xpToNext:120 },
      { name:"–†–æ—Å—Ç–æ–∫",  icon:"üå±", xpToNext:220 },
      { name:"–ú–æ–ª–æ–¥–æ–µ", icon:"üåø", xpToNext:420 },
      { name:"–î–µ—Ä–µ–≤–æ",  icon:"üå≥", xpToNext:700 },
    ];
    
    function svgData(svg){
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg.trim());
}

const simpleIcon = (label) => svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
    <rect width="128" height="128" rx="18" fill="#1b2a55"/>
    <circle cx="64" cy="64" r="34" fill="rgba(255,255,255,.18)"/>
    <text x="64" y="72" text-anchor="middle" fill="rgba(255,255,255,.65)"
      font-size="16" font-family="system-ui">${label}</text>
  </svg>
`);

// –ü—Ä–æ—Å—Ç–æ–π hand-drawn —Å—Ç–∏–ª—å: –º—è–≥–∫–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã + ‚Äú—á–µ—Ä–Ω–∏–ª—å–Ω–∞—è‚Äù –ª–∏–Ω–∏—è
const IMG = {
  forest: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
      <rect width="128" height="128" rx="18" fill="#1b2a55"/>
      <circle cx="42" cy="44" r="26" fill="#49d17d" opacity=".22"/>
      <circle cx="80" cy="52" r="30" fill="#7aa2ff" opacity=".18"/>
      <path d="M20 96c22-22 36-18 56-8 18 9 26 6 32-2" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="4" stroke-linecap="round"/>
      <path d="M18 98c24-24 40-20 60-10 18 9 28 6 34-2" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="2" stroke-linecap="round"/>
      <text x="18" y="32" fill="rgba(255,255,255,.65)" font-size="14" font-family="system-ui">–ª–µ—Å</text>
    </svg>
  `),
  meadow: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
      <rect width="128" height="128" rx="18" fill="#23356b"/>
      <circle cx="88" cy="34" r="22" fill="#ffcc66" opacity=".35"/>
      <path d="M10 88c26-10 48-10 68 0 18 9 28 10 40 4" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="4" stroke-linecap="round"/>
      <path d="M10 92c28-12 52-12 72 0 18 10 28 10 38 4" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="2" stroke-linecap="round"/>
      <text x="14" y="32" fill="rgba(255,255,255,.65)" font-size="14" font-family="system-ui">–ø–æ–ª—è–Ω–∞</text>
    </svg>
  `),
  water: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
      <rect width="128" height="128" rx="18" fill="#1b2a55"/>
      <path d="M14 78c16-10 30-10 46 0 16 10 32 10 54 0" fill="none" stroke="rgba(122,162,255,.55)" stroke-width="6" stroke-linecap="round"/>
      <path d="M14 88c16-10 30-10 46 0 16 10 32 10 54 0" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="4" stroke-linecap="round"/>
      <text x="14" y="32" fill="rgba(255,255,255,.65)" font-size="14" font-family="system-ui">–≤–æ–¥–∞</text>
    </svg>
  `),

  oak: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#7aa2ff" stop-opacity=".15"/>
          <stop offset="1" stop-color="#49d17d" stop-opacity=".10"/>
        </linearGradient>
      </defs>
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <rect x="18" y="18" width="220" height="220" rx="22" fill="url(#g)" opacity=".9"/>
      <path d="M130 182c0-32 3-44 16-64 8-12 8-24-6-38-18-18-56-8-62 20-4 18 8 34 24 38"
        fill="none" stroke="rgba(0,0,0,.25)" stroke-width="10" stroke-linecap="round"/>
      <path d="M128 186c0-36 4-50 18-72 10-16 10-30-8-46-22-20-66-10-74 24-6 24 10 44 28 50"
        fill="none" stroke="rgba(255,255,255,.35)" stroke-width="8" stroke-linecap="round"/>
      <circle cx="132" cy="84" r="54" fill="rgba(73,209,125,.22)"/>
      <circle cx="96" cy="98" r="34" fill="rgba(255,204,102,.14)"/>
      <circle cx="166" cy="104" r="38" fill="rgba(122,162,255,.16)"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–î—É–±</text>
    </svg>
  `),

  birch: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <circle cx="170" cy="70" r="46" fill="rgba(255,204,102,.16)"/>
      <circle cx="96" cy="98" r="58" fill="rgba(73,209,125,.18)"/>
      <path d="M128 210c-6-56 2-92 22-130" fill="none" stroke="rgba(255,255,255,.45)" stroke-width="10" stroke-linecap="round"/>
      <path d="M126 210c-8-58 0-98 18-134" fill="none" stroke="rgba(0,0,0,.22)" stroke-width="6" stroke-linecap="round"/>
      <path d="M142 120l10-6M138 144l12-6M134 166l10-6" stroke="rgba(0,0,0,.25)" stroke-width="6" stroke-linecap="round"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ë–µ—Ä—ë–∑–∞</text>
    </svg>
  `),

  willow: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <path d="M60 188c18-18 38-30 72-30 34 0 52 10 68 22" fill="none" stroke="rgba(122,162,255,.35)" stroke-width="10" stroke-linecap="round"/>
      <circle cx="132" cy="88" r="58" fill="rgba(122,162,255,.18)"/>
      <path d="M124 210c0-54 2-78 16-110" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="8" stroke-linecap="round"/>
      <path d="M108 110c8 30 6 56-10 90M156 110c-10 30-8 56 6 90" fill="none" stroke="rgba(73,209,125,.18)" stroke-width="8" stroke-linecap="round"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ò–≤–∞</text>
    </svg>
  `),

  spruce: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <circle cx="190" cy="62" r="42" fill="rgba(140,120,255,.16)"/>
      <path d="M128 48l54 74H74l54-74Z" fill="rgba(73,209,125,.16)" stroke="rgba(255,255,255,.25)" stroke-width="6" stroke-linejoin="round"/>
      <path d="M128 94l68 88H60l68-88Z" fill="rgba(73,209,125,.12)" stroke="rgba(255,255,255,.20)" stroke-width="6" stroke-linejoin="round"/>
      <path d="M128 206v-26" stroke="rgba(255,255,255,.35)" stroke-width="10" stroke-linecap="round"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ï–ª—å</text>
    </svg>
  `),

  rowan: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <circle cx="120" cy="90" r="58" fill="rgba(73,209,125,.14)"/>
      <circle cx="170" cy="100" r="40" fill="rgba(255,204,102,.12)"/>
      <path d="M128 210c0-58 6-92 22-130" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="8" stroke-linecap="round"/>
      <g fill="rgba(255,107,107,.55)">
        <circle cx="156" cy="130" r="6"/><circle cx="172" cy="146" r="6"/><circle cx="142" cy="152" r="6"/>
      </g>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–†—è–±–∏–Ω–∞</text>
    </svg>
  `),

  palm: svgData(`
    <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect width="256" height="256" rx="28" fill="#121c33"/>
      <circle cx="190" cy="64" r="42" fill="rgba(255,204,102,.18)"/>
      <path d="M132 212c-8-56-4-100 20-146" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="8" stroke-linecap="round"/>
      <path d="M152 70c18 6 34 14 44 26M152 70c-20 6-36 14-48 26M152 70c12-18 22-28 36-34M152 70c-12-18-22-28-36-34"
        fill="none" stroke="rgba(73,209,125,.18)" stroke-width="8" stroke-linecap="round"/>
      <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ü–∞–ª—å–º–∞</text>
    </svg>
  `),
  rock: svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
    <rect width="128" height="128" rx="18" fill="#23356b"/>
    <circle cx="64" cy="68" r="26" fill="rgba(255,255,255,.18)"/>
  </svg>
`),

adapt: svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
    <rect width="128" height="128" rx="18" fill="#1b2a55"/>
    <path d="M20 80c20-20 40-20 60 0" stroke="rgba(73,209,125,.45)" stroke-width="6" fill="none"/>
  </svg>
`),

wait: svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
    <rect width="128" height="128" rx="18" fill="#121c33"/>
    <circle cx="90" cy="36" r="14" fill="rgba(140,120,255,.45)"/>
  </svg>
`),

seed: svgData(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <rect width="256" height="256" rx="28" fill="#121c33"/>
  <circle cx="128" cy="132" r="44" fill="rgba(255,204,102,.18)"/>
  <path d="M92 156c24 18 48 18 72 0" fill="none" stroke="rgba(255,255,255,.28)" stroke-width="8" stroke-linecap="round"/>
  <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–°–µ–º–µ—á–∫–æ</text>
</svg>`),

sprout: svgData(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <rect width="256" height="256" rx="28" fill="#121c33"/>
  <path d="M128 200v-58" stroke="rgba(255,255,255,.35)" stroke-width="10" stroke-linecap="round"/>
  <path d="M128 144c-26 0-42-14-50-34 24-2 44 6 50 24M128 144c26 0 42-14 50-34-24-2-44 6-50 24"
    fill="rgba(73,209,125,.16)" stroke="rgba(255,255,255,.18)" stroke-width="6" stroke-linejoin="round"/>
  <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–†–æ—Å—Ç–æ–∫</text>
</svg>`),

young: svgData(`
<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
  <rect width="256" height="256" rx="28" fill="#121c33"/>
  <circle cx="128" cy="104" r="58" fill="rgba(73,209,125,.16)"/>
  <path d="M128 210c0-50 2-78 10-110" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="10" stroke-linecap="round"/>
  <text x="22" y="44" fill="rgba(255,255,255,.55)" font-size="18" font-family="system-ui">–ú–æ–ª–æ–¥–æ–µ</text>
</svg>`),

adult: svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
    <defs>
      <radialGradient id="g" cx="50%" cy="40%" r="60%">
        <stop offset="0%" stop-color="#8af0b3" stop-opacity=".35"/>
        <stop offset="100%" stop-color="#0b1020" stop-opacity="0"/>
      </radialGradient>
    </defs>

    <rect width="256" height="256" rx="28" fill="rgba(0,0,0,0)"/>
    <circle cx="128" cy="120" r="92" fill="url(#g)"/>

    <!-- –∫—Ä–æ–Ω–∞ -->
    <circle cx="128" cy="110" r="70" fill="rgba(73,209,125,.28)"/>
    <circle cx="92"  cy="120" r="48" fill="rgba(122,162,255,.18)"/>
    <circle cx="170" cy="125" r="52" fill="rgba(91,124,255,.14)"/>

    <!-- —Å—Ç–≤–æ–ª -->
    <path d="M128 205c-10-22-10-48-4-70 6-22 6-34 0-52"
          fill="none" stroke="rgba(255,255,255,.35)" stroke-width="10" stroke-linecap="round"/>
    <path d="M128 205c10-22 10-48 4-70-6-22-6-34 0-52"
          fill="none" stroke="rgba(0,0,0,.25)" stroke-width="6" stroke-linecap="round"/>

    <!-- –∑–µ–º–ª—è -->
    <path d="M42 214c28-18 56-18 86-8 32 10 58 9 86-6"
          fill="none" stroke="rgba(255,255,255,.20)" stroke-width="6" stroke-linecap="round"/>
  </svg>
`),

wise:  simpleIcon("–º–∏—Ä"),
drive: simpleIcon("—ç–Ω"),
care:  simpleIcon("–¥–æ–±"),
magic: simpleIcon("–º–∞–≥"),
winter: simpleIcon("–∑–∏–º"),
spring: simpleIcon("–≤–µ—Å"),
summer: simpleIcon("–ª–µ—Ç"),
autumn: simpleIcon("–æ—Å"),
  
};
    
    // =========================
// 2.1) –î–µ—Ä–µ–≤—å—è: –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
// =========================
// –ß–µ–º –º–µ–Ω—å—à–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å, —Ç–µ–º —Å–ª–∞–±–µ–µ —ç—Ñ—Ñ–µ–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä pestsMul < 1 = –∂—É–∫–∏ —Ä–∞—Å—Ç—É—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
const TREES = {
  oak: {
    name: "–î—É–±",
    icon: "üå≥",
    img: IMG.oak,
    imgsByLevel: [
    "assets/trees/oak/seed_1.png", // Stage 0.1
      "assets/trees/oak/seed_2.png", // Stage 0.2
      "assets/trees/oak/seed_3.png"  // Stage 0.3
],
    desc: "–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Å—Ç—Ä–∞–∂. –ñ–∏–≤—É—á–∏–π, –Ω–æ —Ä–∞—Å—Ç—ë—Ç —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ.",
    mods: { xpMul: 0.90, waterDecayMul: 0.95, pestsMul: 0.85, nightXpMul: 1.00 }
  },
  birch: {
    name: "–ë–µ—Ä—ë–∑–∞",
    icon: "üåø",
    img: IMG.birch,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–ß–∏—Å—Ç–æ—Ç–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. –ë—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –Ω–æ—Ä–º—É, –Ω–æ –∂—É–∫–∏ –∑–ª–µ–µ.",
    mods: { xpMul: 1.00, waterDecayMul: 1.00, pestsMul: 1.10, nightXpMul: 1.00, healthRecoverMul: 1.35 }
  },
  willow: {
    name: "–ò–≤–∞",
    icon: "üåæ",
    img: IMG.willow,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–í–æ–¥–Ω–∞—è –º–∞–≥–∏—è. –ü–æ–ª–∏–≤ –º–æ—â–Ω–µ–µ, –¥—Ä—É–∂–∏—Ç —Å –¥–æ–∂–¥—ë–º (–ø–æ–∑–∂–µ).",
    mods: { xpMul: 1.00, waterDecayMul: 1.05, pestsMul: 1.00, nightXpMul: 1.00, waterActionMul: 1.20 }
  },
  spruce: {
    id: "spruce",
    name: "–ï–ª—å",
    desc: "–•–≤–æ–π–Ω–∞—è, —Å–ø–æ–∫–æ–π–Ω–∞—è, –∑–∏–º–Ω—è—è –≤–∞–π–±–∏–Ω–∞.",

    // –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—é —Ä–æ—Å—Ç–∞
    imgsByLevel: [
      "assets/trees/spruce/seed_1.png", // lvl 0
      "assets/trees/spruce/seed_2.png", // lvl 1
      "assets/trees/spruce/seed_3.png", // lvl 2

      // –¥–∞–ª—å—à–µ –ø–æ–∫–∞ –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å seed-3
      "assets/trees/spruce/seed_3.png", // lvl 3
      "assets/trees/spruce/seed_3.png", // lvl 4
      "assets/trees/spruce/seed_3.png", // lvl 5
      "assets/trees/spruce/seed_3.png", // lvl 6
      "assets/trees/spruce/seed_3.png", // lvl 7
      "assets/trees/spruce/seed_3.png", // lvl 8
      "assets/trees/spruce/seed_3.png", // lvl 9
      "assets/trees/spruce/seed_3.png"  // lvl 10
    ],

    mods: { xpMul: 1.00, waterDecayMul: 1.00, pestsMul: 1.00, nightXpMul: 1.00 }
  },
  rowan: {
    name: "–†—è–±–∏–Ω–∞",
    icon: "üçÇ",
    img: IMG.rowan,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–ó–∞—â–∏—Ç–Ω–∏—Ü–∞. –ß—É—Ç—å —Å–ª–∞–±–µ–µ –∂—É–∫–∏ –∏ –∏–Ω–æ–≥–¥–∞ —Ä–µ–¥–∫–∏–µ –ø–ª–æ–¥—ã.",
    mods: { xpMul: 1.00, waterDecayMul: 1.00, pestsMul: 0.90, nightXpMul: 1.00, rareFruitChance: 0.08 }
  },
  palm: {
    name: "–ü–∞–ª—å–º–∞",
    icon: "üå¥",
    img: IMG.palm,
    imgsByLevel: [
  IMG.seed,  IMG.seed,  IMG.seed,      // 0..2
  IMG.sprout,IMG.sprout,IMG.sprout,    // 3..5
  IMG.young, IMG.young, IMG.young,     // 6..8
  IMG.adult, IMG.adult                 // 9..10
],
    desc: "–°–≤–æ–±–æ–¥–∞ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å. –ë—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç—ë—Ç –∏ –¥–∞—ë—Ç –ø–ª–æ–¥—ã, –Ω–æ —Ö—Ä—É–ø—á–µ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º.",
    mods: { xpMul: 1.12, waterDecayMul: 1.08, pestsMul: 1.05, nightXpMul: 1.00, healthBadDecayMul: 1.15, fruitMul: 1.20 }
  }
};

const DECOR_ITEMS = [
  { id:"lantern", name:"–§–æ–Ω–∞—Ä—å", desc:"–ù–æ—á—å—é –º—è–≥–∫–æ —Å–≤–µ—Ç–∏—Ç—Å—è.", cost: 25 },
  { id:"fence", name:"–ó–∞–±–æ—Ä—á–∏–∫", desc:"–£—é—Ç–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–∞.", cost: 35 },
];

// =========================
// –ú–∞–≥–∞–∑–∏–Ω: –≤–∫–ª–∞–¥–∫–∏ + –æ–±—â–∏–π –∫–∞—Ç–∞–ª–æ–≥
// =========================
const SHOP_TABS = [
  { id:"bg",    name:"üñº –§–æ–Ω—ã" },
  { id:"decor", name:"ü™µ –î–µ–∫–æ—Ä" },
  { id:"fx",    name:"‚ú® –≠—Ñ—Ñ–µ–∫—Ç—ã" },
  { id:"upg",   name:"üß™ –£–ª—É—á—à–µ–Ω–∏—è" }
];

// –ü—Ä–∏–º–µ—Ä—ã. –ü–æ–º–µ–Ω—è–µ—à—å —Ü–µ–Ω—ã/–æ–ø–∏—Å–∞–Ω–∏—è –∫–∞–∫ –∑–∞—Ö–æ—á–µ—à—å.
const SHOP_ITEMS = [
  // --- –§–û–ù–´ ---
  { id:"bg_mystic", tab:"bg", name:"–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ª–µ—Å", desc:"–ß—É—Ç—å –º–∞–≥–∏–∏.", cost:{ fruits:2 }, type:"bg",
    data:{ day:'assets/bg_day.png', night:'assets/bg_night.png' } },

  {
  id: "bg_japan_temple",
  tab: "bg",
  name: "Japanese Temple",
  desc: "Calm Japanese landscape with a distant temple.",
  cost: { leaves: 10 },
  type: "bg",
  data: {
    day: "assets/bgsets/japan_temple_day.png",
    night: "assets/bgsets/japan_temple_night.png"
  }
},

{ id:"bg_meadow", tab:"bg", name:"–õ—É–≥", desc:"–î–Ω—ë–º –ª–µ—Ç–∞—é—Ç —à–∞—Ä—ã, –Ω–æ—á—å—é –º–µ—Ä—Ü–∞—é—Ç –∑–≤—ë–∑–¥—ã.", cost:{ leaves:10 }, type:"bg",
  data:{ day:'assets/bgsets/meadow_day.png', night:'assets/bgsets/meadow_night.png', fx:"meadow" } },

  // --- –î–ï–ö–û–† (—Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π) ---
  { id:"fence", tab:"decor", name:"–ó–∞–±–æ—Ä—á–∏–∫", desc:"–£—é—Ç +10, —Å–º—ã—Å–ª–∞ 0.", cost:{ leaves:80 }, type:"decor" },
  { id:"lantern", tab:"decor", name:"–§–æ–Ω–∞—Ä—å", desc:"–ù–æ—á—å—é —Å–≤–µ—Ç–∏—Ç—Å—è. –ö—Ä–∞—Å–∏–≤–æ.", cost:{ leaves:40 }, type:"decor" },

  // --- –≠–§–§–ï–ö–¢–´ ---
  { id:"fireflies", tab:"fx", name:"–°–≤–µ—Ç–ª—è—á–∫–∏", desc:"–ü–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ—á—å—é –Ω–∞ —Ñ–æ–Ω–µ.", cost:{ fruits:3 }, type:"fx" },
  { id:"soft_rain", tab:"fx", name:"–ú—è–≥–∫–∏–π –¥–æ–∂–¥–∏–∫", desc:"–î–æ–∂–¥—å –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏—è—Ç–Ω–µ–µ.", cost:{ fruits:2 }, type:"fx" },

  // --- –£–õ–£–ß–®–ï–ù–ò–Ø (–∑–∞ —ç—Å—Å–µ–Ω—Ü–∏—é) ---
  { id:"upgrade_compost", tab:"upg", name:"–ö–æ–º–ø–æ—Å—Ç", desc:"–ß—É—Ç—å –º–µ–Ω—å—à–µ —Ä–∞—Å—Ö–æ–¥ –≤–æ–¥—ã (–ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ).", cost:{ essence:5 }, type:"upg" },

  
];

function ensureShop(){
  state.shop = state.shop || {
    tab: "bg",
    owned: {},        // { itemId:true }
    equipped: { bg:null }, // bg itemId
    fx: {}            // { fxId:true } –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
  };
  state.inventory = state.inventory || { leaves:0, essence:0, fruits:0 };
}

const GROWTH_XP_THRESHOLDS = [
  0,    // L0
  30,   // L1
  80,   // L2
  160,  // L3
  280,  // L4
  450,  // L5
  700,  // L6
  1050, // L7
  1500, // L8
  2100, // L9
  3000, // L10
];

function progressToNextGrowth(xp){
  const t = GROWTH_XP_THRESHOLDS;
  const lvl = calcGrowthLevel(xp);
  const cur = t[lvl] ?? 0;
  const next = t[Math.min(lvl + 1, t.length - 1)] ?? cur;

  const span = Math.max(1, next - cur);
  const into = clamp(xp - cur, 0, span);
  const pct = Math.round((into / span) * 100);

  return { lvl, pct, into, span, next };
}

function prettyStageText(level){
  const info = growthInfo(level);
  const maxMinor = (info.major === 3) ? 2 : 3; // –≤–∑—Ä–æ—Å–ª–æ–µ 2 –ø–æ–¥—Å—Ç—É–ø–µ–Ω–∏, –æ—Å—Ç–∞–ª—å–Ω—ã–µ 3
  return `${info.label} ‚Ä¢ ${info.minor + 1}/${maxMinor}`;
}

// =========================
// 2.2) Quiz: —Å–∏—Å—Ç–µ–º–∞ –æ—á–∫–æ–≤
// =========================
function emptyScores(){
  return { oak:0, birch:0, willow:0, spruce:0, rowan:0, palm:0 };
}

function addScore(scores, keys, n=1){
  keys.forEach(k => scores[k] = (scores[k]||0) + n);
}

function pickTreeFromAnswers(ans){
  // ans = { q1:'forest', q2:'rock', q3:'wise', q4:'winter' }
  const s = emptyScores();

  // Q1: –º–µ—Å—Ç–æ
  if(ans.q1 === "forest") addScore(s, ["oak","spruce"]);
  if(ans.q1 === "meadow") addScore(s, ["birch","rowan"]);
  if(ans.q1 === "water")  addScore(s, ["willow","palm"]);

  // Q2: —Ä–µ–∞–∫—Ü–∏—è
  if(ans.q2 === "rock")  addScore(s, ["oak","spruce"]);
  if(ans.q2 === "adapt") addScore(s, ["willow","birch"]);
  if(ans.q2 === "wait")  addScore(s, ["spruce","rowan"]);

  // Q3: –≤–∞–π–±
  if(ans.q3 === "wise")  addScore(s, ["oak","spruce"]);
  if(ans.q3 === "drive") addScore(s, ["palm","birch"]);
  if(ans.q3 === "care")  addScore(s, ["birch","rowan"]);
  if(ans.q3 === "magic") addScore(s, ["spruce","willow"]);

  // Q4: —Å–µ–∑–æ–Ω
  if(ans.q4 === "winter") addScore(s, ["spruce","oak"]);
  if(ans.q4 === "spring") addScore(s, ["birch","willow"]);
  if(ans.q4 === "summer") addScore(s, ["palm","birch"]);
  if(ans.q4 === "autumn") addScore(s, ["rowan","willow"]);

  // –ø–æ–±–µ–¥–∏—Ç–µ–ª—å / –Ω–∏—á—å—è
  const entries = Object.entries(s).sort((a,b)=>b[1]-a[1]);
  const top = entries[0];
  const second = entries[1];
  const best = top[0];
  const bestScore = top[1];

  const tied = (second && second[1] === bestScore);
  if(tied){
    return { winner: null, options: [best, second[0]], scores: s };
  }
  return { winner: best, options: [best], scores: s };
}

    // =========================
    // 3) State + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    // =========================
    const KEY = "tree_spirit_state_v1";

    function defaultState(){
  return {
    groundLeaves: 0,
    weather: "sun",
    weatherUntil: 0,
    growthBuffUntil: 0,

    treeId: null,
    stage: 0,
    xp: 0,
    water: 70,
    health: 95,
    pests: 0,
    lastTick: nowMs(),
    growthLevel: 0,

    inventory: { leaves: 0, fruits: 0, essence: 0 },
    decor: { lantern: false, fence: false },
    daily: {
  sunPhotoUsed: null, // "YYYY-MM-DD"
  // –º–µ–¥–∏—Ç–∞—Ü–∏—è 
  lastMeditateDay: null,  // "YYYY-MM-DD"
  streak: 0,
  total: 0,

  // "–°–µ–≥–æ–¥–Ω—è" (–Ω–æ–≤–æ–µ)
  today: {
    date: null, // "YYYY-MM-DD"
    tasks: { water:0, clean:0, meditate:0 }, // 0/1
    claimed: false
  }
},
  };
}

    function loadState(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        const s = JSON.parse(raw);
        // –º–∏–Ω–∏-–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å–ª—É—á–∞–π –º—É—Å–æ—Ä–∞
        if(typeof s !== "object" || s == null) return defaultState();
        return {
          ...defaultState(),
          ...s,
          inventory: { ...defaultState().inventory, ...(s.inventory||{}) }
        };
      }catch{
        return defaultState();
      }
    }

    function saveState(s){
  // –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ –æ–±—ä–µ–∫—Ç ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π state
  const target = s || state;
  if(!target) return; // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
  localStorage.setItem(KEY, JSON.stringify(target));
}



// ============================
// Weather (Open-Meteo) - no API key
// ============================

const WEATHER_REFRESH_MS = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç
const DEFAULT_CITY = { name: "Amsterdam", lat: 52.3676, lon: 4.9041 };

function wEl(id){ return document.getElementById(id); }

function weatherCodeToEmoji(code){
  // –£ Open-Meteo –µ—Å—Ç—å ‚Äúweathercode‚Äù (WMO). –ì—Ä—É–±–æ –º–∞–ø–ø–∏–º –≤ —ç–º–æ–¥–∑–∏.
  // –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ –≤ –∏—Ö –¥–æ–∫–∞—Ö, –Ω–æ –Ω–∞–º —Ö–≤–∞—Ç–∏—Ç –±–∞–∑–æ–≤–æ–≥–æ. Ó®Å2Ó®Ç
  if(code === 0) return "‚òÄÔ∏è";
  if([1,2,3].includes(code)) return "üå§Ô∏è";
  if([45,48].includes(code)) return "üå´Ô∏è";
  if([51,53,55,56,57].includes(code)) return "üå¶Ô∏è";
  if([61,63,65,66,67,80,81,82].includes(code)) return "üåßÔ∏è";
  if([71,73,75,77,85,86].includes(code)) return "üå®Ô∏è";
  if([95,96,99].includes(code)) return "‚õàÔ∏è";
  return "üå°Ô∏è";
}

async function fetchWeather(lat, lon){
  const url =
    `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${encodeURIComponent(lat)}` +
    `&longitude=${encodeURIComponent(lon)}` +
    `&current=temperature_2m,weather_code,wind_speed_10m` +
    `&timezone=auto`;

  const res = await fetch(url);
  if(!res.ok) throw new Error("weather http " + res.status);
  return await res.json();
}

function setWeatherText(text){
  const t = wEl("weatherText");
  if(t) t.textContent = text;
}

function getBrowserLocation(){
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation) return reject(new Error("no geolocation"));
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
      err => reject(err),
      { enableHighAccuracy: false, timeout: 8000, maximumAge: 10 * 60 * 1000 }
    );
  });
}

async function updateWeather(){
  try{
    setWeatherText("–ü–æ–≥–æ–¥–∞: –∑–∞–≥—Ä—É–∂–∞—é‚Ä¶");

    // 1) –ø—Ä–æ–±—É–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
    let loc;
    try{
      loc = await getBrowserLocation();
    } catch(e){
      // 2) –µ—Å–ª–∏ –æ—Ç–∫–∞–∑–∞–ª–∏ –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –±–µ—Ä—ë–º –¥–µ—Ñ–æ–ª—Ç
      loc = { lat: DEFAULT_CITY.lat, lon: DEFAULT_CITY.lon };
    }

    const data = await fetchWeather(loc.lat, loc.lon);

    const cur = data.current;
    const temp = Math.round(cur.temperature_2m);
    const wind = Math.round(cur.wind_speed_10m);
    const emoji = weatherCodeToEmoji(cur.weather_code);
    const fx = weatherCodeToFx(cur.weather_code);
setWeatherFx(fx);

// —Å–æ—Ö—Ä–∞–Ω—è–µ–º ‚Äú–ø–æ–≥–æ–¥—É‚Äù –≤ state, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ä–æ—Å—Ç–µ
state.weather = fx;                 // ‚Üê —Å—Ç—Ä–æ–∫–∞: "rain"/"snow"/"sun"/"none"
state.weatherMod = weatherGrowthModifier(fx);  // ‚Üê –æ—Ç–¥–µ–ª—å–Ω–æ –º–Ω–æ–∂–∏—Ç–µ–ª—å (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å)
state.weatherUpdatedAt = Date.now();
saveState(state);

    setWeatherText(`–ü–æ–≥–æ–¥–∞ —Å–µ–π—á–∞—Å: ${emoji} ${temp}¬∞C, –≤–µ—Ç–µ—Ä ${wind} –º/—Å`);
  } catch(e){
    setWeatherText("–ü–æ–≥–æ–¥–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å");
    console.warn("Weather error:", e);
  }
}

function bindWeatherUI(){
  wEl("weatherRefresh")?.addEventListener("click", updateWeather);
}

function startWeatherLoop(){
  updateWeather();
  setInterval(updateWeather, WEATHER_REFRESH_MS);
}

function formatHHMMSS(ms){
  const s = Math.max(0, Math.floor(ms / 1000));
  const hh = String(Math.floor(s / 3600)).padStart(2,"0");
  const mm = String(Math.floor((s % 3600) / 60)).padStart(2,"0");
  const ss = String(s % 60).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}

// ============================
// Weather -> FX + Growth modifier
// ============================

// 0 = clear, 1-3 clouds, 45-48 fog
// 51..67 drizzle/rain, 80..82 rain showers
// 71..77 snow, 85..86 snow showers
// 95..99 thunderstorm
function weatherCodeToFx(code){
  if([71,73,75,77,85,86].includes(code)) return "snow";
  if([51,53,55,56,57,61,63,65,66,67,80,81,82,95,96,99].includes(code)) return "rain";
  if([0,1].includes(code)) return "sun";
  return "none";
}

function setWeatherFx(fx){
  const el = document.getElementById("weatherFX");
  if(!el) return;

  el.classList.remove("weather-none","weather-rain","weather-snow","weather-sun");
  el.classList.add("weather-" + fx);
}

// –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä: –≤–ª–∏—è–µ—Ç –Ω–∞ ‚Äú—Å–∫–æ—Ä–æ—Å—Ç—å —Ä–æ—Å—Ç–∞‚Äù (—Ç—ã —Å–∞–º —Ä–µ—à–∏—à—å –Ω–∞—Å–∫–æ–ª—å–∫–æ –∂–µ—Å—Ç–∫–æ)
function weatherGrowthModifier(fx){
  if(fx === "rain") return 1.15; // +15% –∫ —Ä–æ—Å—Ç—É
  if(fx === "sun")  return 1.10; // +10%
  if(fx === "snow") return 0.85; // -15%
  return 1.00;
}

    // =========================
    // 4) –°–µ—Ä–¥—Ü–µ –∏–≥—Ä—ã: tick (–æ—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å)
    // =========================
    function tickTree(s, tNow){
      const dtMs = Math.max(0, tNow - (s.lastTick || tNow));
      const dtHours = dtMs / 3600000;
      const tree = s.treeId ? (TREES[s.treeId] || null) : null;
      
const mods = tree?.mods || {};
const w = s.weather || "sun";

// XP –º–Ω–æ–∂–∏—Ç–µ–ª—å (–≤–ª–∏—è–Ω–∏–µ –ø–æ–≥–æ–¥—ã –Ω–∞ —Ä–æ—Å—Ç)
const weatherXpMul =
  (w === "sun")  ? 1.10 :
  (w === "rain") ? 1.15 :
  (w === "snow") ? 0.85 :
  1.0;

// —Ä–∞—Å—Ö–æ–¥ –≤–æ–¥—ã (–¥–æ–∂–¥—å –ø–æ–º–æ–≥–∞–µ—Ç)
const weatherWaterDecayMul =
  (w === "rain") ? 0.75 :
  (w === "snow") ? 1.10 :   // –≤ —Å–Ω–µ–≥ –≤–æ–¥–∞ —Ö—É–∂–µ ‚Äú—Ä–∞–±–æ—Ç–∞–µ—Ç‚Äù (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  1.0;

// –∂—É–∫–∏ (—Ç—É–º–∞–Ω –º–µ—à–∞–µ—Ç –∂—É–∫–∞–º, –≤ –º–æ—Ä–æ–∑ —Ç–æ–∂–µ –º–æ–∂–Ω–æ –æ—Å–ª–∞–±–∏—Ç—å)
const weatherPestsMul =
  (w === "fog")  ? 0.75 :
  (w === "snow") ? 0.85 :
  1.0;
const xpMul = mods.xpMul ?? 1.0;
const waterDecayMul = mods.waterDecayMul ?? 1.0;
const pestsMul = mods.pestsMul ?? 1.0;
const nightXpMul = mods.nightXpMul ?? 1.0;
const healthRecoverMul = mods.healthRecoverMul ?? 1.0;
const healthBadDecayMul = mods.healthBadDecayMul ?? 1.0;
const fruitMul = mods.fruitMul ?? 1.0;

if(mods.rareFruitChance){
  const chance = mods.rareFruitChance * dtHours; // —à–∞–Ω—Å —Ä–∞—Å—Ç—ë—Ç —Å –≤—Ä–µ–º–µ–Ω–µ–º
  if(Math.random() < chance){
    s.inventory.fruits += 1;
  }
}

const night = isNightByLocalTime();
      if(dtHours <= 0.0001){
        s.lastTick = tNow;
        return { dtHours: 0, msg: "" };
      }

      // ---- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–ª–∞–Ω—Å–∞
      const waterDecayPerHour = 2.0;     // 48/—Å—É—Ç–∫–∏
      const pestsGrowthPerHour = 0.6;    // –∫–æ–≥–¥–∞ –ø–ª–æ—Ö–æ
      const pestsRecoverPerHour = 0.3;   // –∫–æ–≥–¥–∞ —Ö–æ—Ä–æ—à–æ
      const healthDecayPerHour = 0.8;    // —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∂–µ—Å—Ç–∏
      const healthRecoverPerHour = 0.2;  // –º—è–≥–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
      const baseXpPerHour = 10;          // —Ä–æ—Å—Ç –≤ –∏–¥–µ–∞–ª–µ

      // 1) –≤–æ–¥–∞ —É–±—ã–≤–∞–µ—Ç –≤—Å–µ–≥–¥–∞
     s.water = clamp(
  s.water - waterDecayPerHour * waterDecayMul * weatherWaterDecayMul * dtHours,
  0, 100
);

      // 2) –≤—Ä–µ–¥–∏—Ç–µ–ª–∏: —Ä–∞—Å—Ç—É—Ç –ø—Ä–∏ –ø–ª–æ—Ö–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö
     // 2) –≤—Ä–µ–¥–∏—Ç–µ–ª–∏: —Ä–∞—Å—Ç—É—Ç –ø—Ä–∏ –ø–ª–æ—Ö–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö
    const badWater = (s.water < 25 || s.water > 95);

// w –£–ñ–ï –æ–±—ä—è–≤–ª–µ–Ω –≤—ã—à–µ –≤ tickTree, –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –µ–≥–æ –ù–ï –æ–±—ä—è–≤–ª—è–µ–º
    const fogPestsMul = (w === "fog") ? 1.25 : 1.0;

    if(badWater){
      s.pests = clamp(
      s.pests + pestsGrowthPerHour * fogPestsMul * weatherPestsMul * dtHours,
       0, 100
  );
   }else{
     s.pests = clamp(
     s.pests - pestsRecoverPerHour * (2 - fogPestsMul) * dtHours,
       0, 100
  );
}

      // 3) –∑–¥–æ—Ä–æ–≤—å–µ: –ø–∞–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –ø–ª–æ—Ö–æ
      const veryBad = (s.water < 15 || s.pests > 70);
      if(veryBad){
        s.health = clamp(s.health - healthDecayPerHour * healthBadDecayMul * dtHours, 0, 100);
      }else{
        s.health = clamp(s.health + healthRecoverPerHour * healthRecoverMul * dtHours, 0, 100);
      }

      // 4) —Ñ–∞–∫—Ç–æ—Ä—ã —Ä–æ—Å—Ç–∞
      let waterFactor = 1.0;
      if(s.water >= 40 && s.water <= 80) waterFactor = 1.0;
      else if((s.water >= 20 && s.water < 40) || (s.water > 80 && s.water <= 95)) waterFactor = 0.6;
      else waterFactor = 0.2;

      let pestFactor = 1 - (s.pests / 120);
      pestFactor = clamp(pestFactor, 0.2, 1.0);

      const healthFactor = clamp(s.health / 100, 0, 1);

      // 5) –Ω–∞—á–∏—Å–ª—è–µ–º XP
      const buffActive = (s.growthBuffUntil || 0) > tNow;
const buffMul = buffActive ? 1.25 : 1.0;

const xpGain = baseXpPerHour
  * waterFactor
  * pestFactor
  * healthFactor
  * xpMul
  * (night ? nightXpMul : 1.0)
  * buffMul
  * weatherXpMul
  * dtHours;

s.xp += xpGain;

  const newLevel = calcGrowthLevel(s.xp);
if(newLevel > s.growthLevel){
  s.growthLevel = newLevel;
  // —ç—Ñ—Ñ–µ–∫—Ç –∞–ø–∞, –ª–æ–≥, —á–∞—Å—Ç–∏—Ü—ã
}
     
      // 6) –Ω–∞–≥—Ä–∞–¥—ã (–ø—Ä–æ—Å—Ç–µ–Ω—å–∫–æ)
      s.inventory.leaves += Math.floor(xpGain / 15);

      // 7) –∞–ø —Å—Ç–∞–¥–∏–π (–º–æ–∂–µ—Ç –∞–ø–Ω—É—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
s.lastTick = tNow;
return { dtHours, msg: "" };
}

    // =========================
    // 5) UI
    // =========================
    const el = (id) => document.getElementById(id);

    function stageLabel(s){
  const lvl = s.growthLevel || 0;
  const info = growthInfo(lvl); // major/minor/label
  // major: 0..3, minor: 0..2 (–∏–ª–∏ 0..1 –Ω–∞ –≤–∑—Ä–æ—Å–ª–æ–º)
  return `${info.label} ${info.major+1}.${info.minor+1} (lvl ${lvl})`;
}

async function makeScenePhoto(){
  const scene = document.getElementById("scene");
  const bg = document.getElementById("bgLayer");
  const treeImg = document.getElementById("treeImg");

  if(!scene || !treeImg){
    log("–§–æ—Ç–æ: –Ω–µ –Ω–∞—à—ë–ª —Å—Ü–µ–Ω—É/–¥–µ—Ä–µ–≤–æ üòÖ");
    return;
  }

  // —Ä–∞–∑–º–µ—Ä—ã —Ñ–æ—Ç–æ = —Ä–∞–∑–º–µ—Ä —Å—Ü–µ–Ω—ã
  const r = scene.getBoundingClientRect();
  const w = Math.round(r.width);
  const h = Math.round(r.height);

  const canvas = document.createElement("canvas");
  canvas.width = w * 2;      // 2x –¥–ª—è —á—ë—Ç–∫–æ—Å—Ç–∏
  canvas.height = h * 2;
  const ctx = canvas.getContext("2d");
  ctx.scale(2,2);

  // 1) —Ñ–æ–Ω: –µ—Å–ª–∏ bgLayer —Å background-image
  const bgStyle = bg ? getComputedStyle(bg).backgroundImage : "none";
  if(bgStyle && bgStyle !== "none"){
    // backgroundImage: url("...") -> –¥–æ—Å—Ç–∞—ë–º —Å—Å—ã–ª–∫—É
    const m = bgStyle.match(/url\(["']?(.*?)["']?\)/);
    const url = m ? m[1] : null;
    if(url){
      await drawImageUrl(ctx, url, 0, 0, w, h);
    } else {
      // fallback: –ø—Ä–æ—Å—Ç–æ –∑–∞–ª–∏–≤–∫–∞
      ctx.fillStyle = "rgba(10,15,32,1)";
      ctx.fillRect(0,0,w,h);
    }
  } else {
    // fallback: —Ñ–æ–Ω —Å—Ü–µ–Ω—ã (–≥—Ä–∞–¥–∏–µ–Ω—Ç –Ω–µ –≤—ã—Ç–∞—â–∏–º –ø—Ä–æ—Å—Ç–æ, –Ω–æ –∑–∞–ª–∏–≤–∫–∞ –±—É–¥–µ—Ç)
    ctx.fillStyle = "rgba(10,15,32,1)";
    ctx.fillRect(0,0,w,h);
  }

  // 2) –¥–µ—Ä–µ–≤–æ (–∫–∞—Ä—Ç–∏–Ω–∫–∞)
  const treeRect = treeImg.getBoundingClientRect();
  const x = treeRect.left - r.left;
  const y = treeRect.top - r.top;

  await drawImageElement(ctx, treeImg, x, y, treeRect.width, treeRect.height);

  // 3) –ø–æ–¥–ø–∏—Å—å –¥–∞—Ç—ã (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
  const stamp = new Date().toLocaleString();
  ctx.font = "12px system-ui, Arial";
  ctx.fillStyle = "rgba(255,255,255,.75)";
  ctx.fillText(stamp, 12, h - 14);

  const dataUrl = canvas.toDataURL("image/png");

  showPhotoModal(dataUrl);
}

function drawImageUrl(ctx, url, x, y, w, h){
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => { ctx.drawImage(img, x, y, w, h); resolve(); };
    img.onerror = () => resolve(); // –Ω–µ –ª–æ–º–∞–µ–º —Ñ–æ—Ç–æ –µ—Å–ª–∏ —Ñ–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
    img.src = url;
  });
}

function drawImageElement(ctx, imgEl, x, y, w, h){
  return new Promise((resolve) => {
    if(imgEl.complete){
      ctx.drawImage(imgEl, x, y, w, h);
      resolve();
      return;
    }
    imgEl.onload = () => { ctx.drawImage(imgEl, x, y, w, h); resolve(); };
    imgEl.onerror = () => resolve();
  });
}

let lastPhotoDataUrl = null;

function showPhotoModal(dataUrl){
  lastPhotoDataUrl = dataUrl;

  const modal = document.getElementById("photoModal");
  const prev = document.getElementById("photoPreview");
  const info = document.getElementById("photoInfo");
  const btnSave = document.getElementById("btnPhotoSave");
  const btnClose = document.getElementById("btnPhotoClose");

  if(!modal || !prev || !btnSave || !btnClose) return;

  prev.src = dataUrl;
  if(info) info.textContent = "–ú–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∫–∞–∫ PNG –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç—å.";

  modal.classList.remove("hidden");

  const close = () => {
    modal.classList.add("hidden");
    btnSave.onclick = null;
    btnClose.onclick = null;
    modal.onclick = null;
  };

  btnClose.onclick = close;
  modal.onclick = (e) => { if(e.target === modal) close(); };

  btnSave.onclick = () => {
    downloadDataUrl(dataUrl, `tree_photo_${Date.now()}.png`);
  };
}

function downloadDataUrl(dataUrl, filename){
  const a = document.createElement("a");
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

    function stageIcon(s){
      const st = STAGES[s.stage] || STAGES[0];
      return st.icon;
    }

    function xpProgress(s){
      const need = (STAGES[s.stage] || STAGES[0]).xpToNext;
      return clamp(s.xp / need, 0, 1);
    }

    function setBar(id, v01){
  const node = document.getElementById(id);
  if(!node) return;
  const pct = Math.max(0, Math.min(1, Number(v01) || 0)) * 100;
  node.style.width = pct.toFixed(0) + "%";
}

    function log(msg){
      el("log").textContent = msg || "";
    }

    
    
    function renderGround(s){
  const layer = document.getElementById("groundLayer");
  if(!layer) return;

  layer.innerHTML = "";

  const count = Number(s.groundLeaves || 0);

  // –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∏—Å—É–µ–º
  if(count <= 0) return;

  let src = "";
  if(count <= 5){
    src = "assets/fx/ground_leaves_small.png";
  } else if(count <= 10){
    src = "assets/fx/ground_leaves_medium.png";
  } else {
    src = "assets/fx/ground_leaves_large.png";
  }

  const img = document.createElement("img");
  img.className = "leafPile";
  img.src = src;
  img.alt = "";

  layer.appendChild(img);
}

function currencyIcon(type){
  // type: "leaves" | "fruits" | "essence"
  if(type === "leaves")  return "icons/leaves.png";
  if(type === "fruits")  return "icons/fruit.png";
  if(type === "essence") return "icons/essence.png";
  return "";
}

function fmtReward(type, amount){
  const src = currencyIcon(type);
  const safe = Number(amount || 0);
  return `
    <span class="rewardLine">
      <span class="amount">${safe}</span>
      <img class="currencyIcon" src="${src}" alt="">
    </span>
  `;
}

function collectLeaves(){
  const n = state.groundLeaves || 0;
  if(n <= 0) return;

  state.inventory.leaves = (state.inventory.leaves || 0) + n;
  state.groundLeaves = 0;

  saveState(state);
  render(state);
  renderGround(state);
  log("–õ–∏—Å—Ç—å—è —Å–æ–±—Ä–∞–Ω—ã.");
}

   //—Ñ—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø–æ–≥–æ–¥—ã
   function pickWeather(){
  const r = Math.random();
  if(r < 0.35) return "sun";
  if(r < 0.60) return "rain";
  if(r < 0.80) return "fog";
  return "wind";
}

function ensureWeather(){
  const t = nowMs();
  if((state.weatherUntil || 0) > t) return;

  state.weather = pickWeather();
  const hours = 3 + Math.floor(Math.random()*4); // 3..6 —á–∞—Å–æ–≤
  state.weatherUntil = t + hours * 3600000;

  saveState(state);
  render(state);
}

function render(s){
  const scene = el("scene");
  if(scene){
    const night = isNightByLocalTime();

    // –¥–µ–Ω—å/–Ω–æ—á—å –∫–ª–∞—Å—Å—ã
    scene.classList.toggle("night", night);
    scene.classList.toggle("day", !night);

    // —Ñ–æ–Ω
    const bg = document.getElementById("bgLayer");
    if(bg){
      ensureShop();

let dayBg = 'assets/bg_day.png';
let nightBg = 'assets/bg_night.png';

const eq = state.shop?.equipped?.bg;
if(eq){
  const it = SHOP_ITEMS.find(x => x.id === eq && x.type === "bg");
  if(it?.data?.day) dayBg = it.data.day;
  if(it?.data?.night) nightBg = it.data.night;
}

bg.style.backgroundImage = night
  ? `url("${nightBg}")`
  : `url("${dayBg}")`;

  // ===== BACKGROUND FX: balloons –¥–Ω–µ–º, stars –Ω–æ—á—å—é =====
updateBgFx(night);
    }
  }
    // —Ñ–æ–Ω –ø–æ —Å—Ç–∞–¥–∏–∏
    const info = growthInfo(s.growthLevel || 0);
    scene.dataset.stageMajor = String(info.major);

    // –ª—ë–≥–∫–∏–π "–∫–∞–º–µ—Ä–∞" —ç—Ñ—Ñ–µ–∫—Ç
    const lvlCam = s.growthLevel || 0;
    scene.style.paddingTop = (8 + lvlCam * 1.2) + "px";
    const swayEl = document.getElementById("treeSway");
if(swayEl){
  const w = s.weather || "sun";
  swayEl.style.animation = (w === "wind") ? "swayRot 3.2s ease-in-out infinite" : "";
}

  // –¥–µ—Ä–µ–≤–æ
const tree = s.treeId ? (TREES[s.treeId] || null) : null;
const img = document.getElementById("treeImg");

if (img) {
  const lvl = s.growthLevel || 0;

  // 1) –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ —Å—Ç–∞–¥–∏—è–º (—Å–µ–º–µ—á–∫–∞ 0..2, —Ä–æ—Å—Ç–æ–∫ –∏ —Ç.–¥.)
  const byStage = tree?.imgsByStage || null;
  if (tree && byStage && byStage.length) {
    const stage = s.stage || 0;
    const idx = Math.max(0, Math.min(byStage.length - 1, stage));
    img.src = byStage[idx];
  } else {
    // 2) –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º (0..10)
    const byLevel = tree?.imgsByLevel || null;
    if (tree && byLevel && byLevel.length) {
      const idx = Math.max(0, Math.min(byLevel.length - 1, lvl));
      img.src = byLevel[idx];
    } else {
      // 3) –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
      img.src = tree?.img || "";
    }
  }

  // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç
  const scale = 1 + lvl * 0.055;
  const lift  = -lvl * 5;

  img.style.transform = `translateY(${lift}px) scale(${scale})`;
  img.style.transformOrigin = "50% 90%";
  img.style.transition = "transform 900ms ease";
}

// glow (—Å–∏–ª–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–æ—á–∏ –∏ —É—Ä–æ–≤–Ω—è)
const glow = document.querySelector(".glow");
if(glow){
  const lvl = s.growthLevel || 0;
  const night = isNightByLocalTime();

  // –ø–æ–∑–∏—Ü–∏—è/—Ä–∞–∑–º–µ—Ä 
  glow.style.transform = `translateY(${Math.max(0, lvl * 2)}px) scale(${1 + lvl * 0.02})`;
  glow.style.transition = "transform 900ms ease";

  // —Å–∏–ª–∞ —Å–≤–µ—á–µ–Ω–∏—è: –¥–Ω—ë–º –ø–æ—á—Ç–∏ –Ω–µ—Ç, –Ω–æ—á—å—é —Å–∏–ª—å–Ω–µ–µ; —Ä–∞—Å—Ç—ë—Ç —Å —É—Ä–æ–≤–Ω–µ–º
  const base = night ? 0.45 : 0.18;
  const add  = Math.min(0.35, lvl * 0.03);
  glow.style.opacity = String(base + add);
}
  // —Ç–µ–∫—Å—Ç—ã (—Ç—É—Ç –ª—É—á—à–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–≤–æ—é stageLabel –∫–∞–∫ –µ—Å—Ç—å)
  const st = el("stageText");
  if(st) st.textContent = stageLabel(s);

  const wt = el("waterText");
  if(wt) wt.textContent = `${Math.round(s.water)}/100`;

  const ht = el("healthText");
  if(ht) ht.textContent = `${Math.round(s.health)}`;

  const pt = el("pestsText");
  if(pt) pt.textContent = `${Math.round(s.pests)}`;

  // –±–∞—Ä—ã (–µ—Å–ª–∏ setBar —É —Ç–µ–±—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç 0..1)
  if(typeof setBar === "function"){
    setBar("waterBar",  s.water / 100);
    setBar("healthBar", s.health / 100);
    setBar("pestsBar",  1 - (s.pests / 100));

    // XP –±–∞—Ä: —É–±–µ–¥–∏—Å—å, —á—Ç–æ xpProgress –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ 0..1.
    // –ï—Å–ª–∏ xpProgress –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç/–ø—Ä–æ—Ü–µ–Ω—Ç—ã ‚Äî —ç—Ç–æ –ª–æ–º–∞–µ—Ç.
    // –°–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
    // setBar("xpBar", 0);
    try{
      const xp = xpProgress(s);   // –æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ —É —Ç–µ–±—è
      setBar("xpBar", xp);
    }catch(e){
      // —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ –≤–æ–æ–±—â–µ
      setBar("xpBar", 0);
    }
  }
  
  // –≤–µ—Ä—Ö–Ω–∏–µ –º–∏–Ω–∏-—Å—á–µ—Ç—á–∏–∫–∏ (16-18)
const lf = document.getElementById("invLeaves");
if(lf) lf.textContent = String(s.inventory?.leaves ?? 0);

const fr = document.getElementById("invFruits");
if(fr) fr.textContent = String(s.inventory?.fruits ?? 0);

const es = document.getElementById("invEssence");
if(es) es.textContent = String(s.inventory?.essence ?? 0);

// XP –º–∏–Ω–∏-—Ç–µ–∫—Å—Ç (1)
const xpMini = document.getElementById("xpTextMini");
if(xpMini) xpMini.textContent = `${Math.round(s.xp || 0)}`;

  // subtitle: —Ä–µ—Å—É—Ä—Å—ã + —Ç–∞–π–º–µ—Ä —É–¥–æ–±—Ä–µ–Ω–∏—è (–û–î–ò–ù —Ä–∞–∑)
  const sub = el("subtitle");
  if(sub){
    const left = (s.growthBuffUntil || 0) - nowMs();
    const fertText = left > 0 ? ` ‚Ä¢ üåø ${fmtLeft(left)}` : "";
    sub.textContent =
      `–õ–∏—Å—Ç—å—è: ${s.inventory.leaves} ‚Ä¢ –ü–ª–æ–¥—ã: ${s.inventory.fruits} ‚Ä¢ –≠—Å—Å–µ–Ω—Ü–∏—è: ${s.inventory.essence}${fertText}`;
  }

  // –≤—ã—Å–æ—Ç–∞ —Å–ø—Ä–∞–≤–∞ –≤ —Å—Ü–µ–Ω–µ
  const hb = document.getElementById("heightBig");
  if(hb){
    const h = heightMetersByLevel(s.growthLevel || 0);
    hb.textContent = `${h} –º`;
  }

  const hf = document.getElementById("heightFill");
  if(hf){
    const pct = clamp(((s.growthLevel || 0) / 10) * 100, 0, 100);
    hf.style.height = pct + "%";
  }

  // —Å–ª–æ–∏
  if(typeof renderWeather === "function") renderWeather();
  if(typeof renderDayNight === "function") renderDayNight();
  if(typeof renderDecor === "function") renderDecor();
      renderToday(s);
      
      
      const btnPhoto = el("btnPhoto");
if(btnPhoto){
  btnPhoto.style.display = ((s.weather || "sun") === "sun") ? "" : "none";
}
}

// —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã 100 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
let lastNightState = null;

// ===== BACKGROUND FX: balloons –¥–Ω–µ–º, stars –Ω–æ—á—å—é (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–æ–Ω–∞ "–õ—É–≥") =====
function updateBgFx(isNight){
  ensureShop();

  const eq = state.shop?.equipped?.bg;

  if(!isMeadow){
    // –µ—Å–ª–∏ —Ñ–æ–Ω –Ω–µ –ª—É–≥ ‚Äî –≤—Å—ë –≤—ã–∫–ª—é—á–∞–µ–º
    clearBalloons();
    setNightStars(false);
    return;
  }

  // –µ—Å–ª–∏ –ª—É–≥ ‚Äî –¥–Ω—ë–º —à–∞—Ä—ã, –Ω–æ—á—å—é –∑–≤—ë–∑–¥—ã
  if(isNight){
    clearBalloons();
    setNightStars(true);
  }else{
    setNightStars(false);
    startBalloons();
  }
}


// ===== BACKGROUND FX: balloons –¥–Ω–µ–º, stars –Ω–æ—á—å—é (–¢–û–õ–¨–ö–û –Ω–∞ —Ñ–æ–Ω–µ "–õ—É–≥") =====
let balloonTimer = null;
let starsBuilt = false;

function clearBalloons(){
  // balloonTimer —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ —Ñ–ª–∞–≥, –∞ –Ω–µ setInterval
  balloonTimer = null;

  const layer = document.getElementById("bgFxLayer");
  if(!layer) return;
  layer.querySelectorAll(".bgBalloon").forEach(n => n.remove());
}

function startBalloons(){
  const layer = document.getElementById("bgFxLayer");
  if(!layer) return;

  // –µ—Å–ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ, –Ω–µ –¥—É–±–ª–∏–º
  if(balloonTimer) return;

  const imgs = [
    "assets/fx/balloon_1.png",
    "assets/fx/balloon_2.png",
    "assets/fx/balloon_3.png"
  ];

  layer.querySelectorAll(".bgBalloon").forEach(n => n.remove());

  function spawnOne(){
    const b = document.createElement("div");
    b.className = "bgBalloon";

    // –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç—É: –ø–æ—á—Ç–∏ –≤–Ω–∏–∑—É —Ñ–æ–Ω–∞ (–ø–æ–¥—Å—Ç—Ä–æ–π, –µ—Å–ª–∏ –Ω–∞–¥–æ)
    b.style.left = (8 + Math.random()*84) + "%";
    b.style.top  = (8 + Math.random()*12) + "%"; // 58..68%

    // –º–∞–ª–µ–Ω—å–∫–∏–µ, "–≤–¥–∞–ª–µ–∫–µ"
    const size = (24 + Math.random()*22); // 24..46px
    b.style.width  = size + "px";
    b.style.height = size + "px";

    // –≥–ª—É–±–∏–Ω–∞: –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑–Ω—ã–µ
    b.style.opacity = (0.22 + Math.random()*0.28).toFixed(2); // 0.22..0.50
    b.style.animationDuration = (8 + Math.random()*8) + "s";
    b.style.animationDelay = (-Math.random()*6) + "s";

    const img = imgs[Math.floor(Math.random()*imgs.length)];
    b.style.backgroundImage = `url("${img}")`;

    layer.appendChild(b);
  }

  // —Å–æ–∑–¥–∞—ë–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –±–µ–∑ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Å–ø–∞–≤–Ω–∞
  const count = 4; // —Ö–æ—á–µ—à—å 3-5, –ø–æ–º–µ–Ω—è–π —Ç—É—Ç
  for(let i=0;i<count;i++) spawnOne();

  // —Å—Ç–∞–≤–∏–º "—Ñ–ª–∞–∂–æ–∫", —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ–º balloonTimer –∫–∞–∫ –º–∞—Ä–∫–µ—Ä)
  balloonTimer = 1;
}

function setNightStars(on){
  const layer = document.getElementById("bgFxLayer");
  if(!layer) return;

  // —É–¥–∞–ª—è–µ–º –∑–≤–µ–∑–¥—ã, –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–∞–µ–º
  if(!on){
    layer.querySelectorAll(".nightStar").forEach(n => n.remove());
    starsBuilt = false;
    return;
  }

  // –µ—Å–ª–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã, –Ω–µ —Å–æ–∑–¥–∞—ë–º –∑–∞–Ω–æ–≤–æ
  if(starsBuilt) return;
  starsBuilt = true;

  const count = 42;
  for(let i=0;i<count;i++){
    const s = document.createElement("div");
    s.className = "nightStar";
    s.style.left = (Math.random()*100) + "%";
    s.style.top  = (Math.random()*55) + "%";
    const size = (2 + Math.random()*3);
    s.style.width = size + "px";
    s.style.height = size + "px";
    s.style.animationDuration = (2 + Math.random()*4) + "s";
    s.style.animationDelay = (-Math.random()*4) + "s";
    layer.appendChild(s);
  }
}

function updateBgFx(isNight){
  ensureShop();

  const eq = state.shop?.equipped?.bg; // —á—Ç–æ –≤—ã–±—Ä–∞–Ω–æ
  const it = eq ? SHOP_ITEMS.find(x => x.id === eq && x.type === "bg") : null;

  // –≠–§–§–ï–ö–¢–´ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–õ—É–≥" (fx:"meadow")
  const isMeadow = (it?.data?.fx === "meadow");

  // –µ—Å–ª–∏ –ù–ï –ª—É–≥, –≤—Å—ë —á–∏—Å—Ç–∏–º –∏ –≤—ã—Ö–æ–¥–∏–º
  if(!isMeadow){
    clearBalloons();
    setNightStars(false);
    return;
  }

  // –µ—Å–ª–∏ –ª—É–≥: –¥–Ω—ë–º —à–∞—Ä—ã, –Ω–æ—á—å—é –∑–≤—ë–∑–¥—ã
  if(isNight){
    clearBalloons();
    setNightStars(true);
  }else{
    setNightStars(false);
    startBalloons();
  }
}

function renderWeather(){
  const layer = document.getElementById("weatherLayer");
  if(!layer) return;

  const w = state.weather || "sun";
  layer.innerHTML = "";

  if(w === "rain"){
    for(let i=0;i<28;i++){
      const d = document.createElement("div");
      d.style.position="absolute";
      d.style.left = (Math.random()*100)+"%";
      d.style.top = (-20 - Math.random()*60)+"px";
      d.style.width="2px";
      d.style.height=(18+Math.random()*26)+"px";
      d.style.background="rgba(255,255,255,.18)";
      d.style.borderRadius="2px";
      d.style.transform=`rotate(${8+Math.random()*10}deg)`;
      d.style.animation = `rainFall ${1.2+Math.random()*1.2}s linear infinite`;
      layer.appendChild(d);
    }
  }

  if(w === "fog"){
    const fog = document.createElement("div");
    fog.style.position="absolute";
    fog.style.inset="0";
    fog.style.background="rgba(255,255,255,.06)";
    fog.style.backdropFilter="blur(2px)";
    fog.style.animation="fogPulse 6s ease-in-out infinite";
    layer.appendChild(fog);
  }

  if(w === "wind"){
    // –ø—Ä–æ—Å—Ç–æ —É—Å–∏–ª–∏–º –ª–∏—Å—Ç—å—è –≤–∏–∑—É–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å–ª–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ (—Å–ø–∞–≤–Ω –ª–∏—Å—Ç—å–µ–≤ —Å–¥–µ–ª–∞–µ–º –≤ startWorld)
    const v = document.createElement("div");
    v.style.position="absolute";
    v.style.inset="0";
    v.style.background="linear-gradient(90deg, transparent, rgba(255,255,255,.05), transparent)";
    v.style.animation="windSweep 4s ease-in-out infinite";
    layer.appendChild(v);
  }

  // sun –º–æ–∂–Ω–æ –Ω–µ —Ä–∏—Å–æ–≤–∞—Ç—å, –æ–Ω –∏ —Ç–∞–∫ —É—é—Ç–Ω—ã–π
}

function renderDayNight(){
  const layer = document.getElementById("dayNightLayer");
  if(!layer) return;

  const night = isNightByLocalTime();
  if(night){
    layer.style.background = "radial-gradient(800px 500px at 30% 20%, rgba(140,120,255,.18), transparent 60%), rgba(0,0,0,.30)";
  }else{
    layer.style.background = "radial-gradient(800px 500px at 30% 20%, rgba(255,255,255,.10), transparent 60%), rgba(0,0,0,.00)";
  }
}

function showDecor(show){
  const d = el("decor");
  if(d) d.style.display = show ? "" : "none";
  setMainUIVisible(!show);

  if(show){
    ensureShop();
    renderShop();
  }
}

function setShopTab(tabId){
  ensureShop();
  state.shop.tab = tabId;
  saveState(state);
  renderShop();
}

function canAfford(cost){
  ensureShop();
  const inv = state.inventory;
  if(cost.leaves && (inv.leaves||0) < cost.leaves) return false;
  if(cost.fruits && (inv.fruits||0) < cost.fruits) return false;
  if(cost.essence && (inv.essence||0) < cost.essence) return false;
  return true;
}

function pay(cost){
  ensureShop();
  if(cost.leaves) state.inventory.leaves -= cost.leaves;
  if(cost.fruits) state.inventory.fruits -= cost.fruits;
  if(cost.essence) state.inventory.essence -= cost.essence;
}

function buyOrEquip(itemId){
  ensureShop();
  const it = SHOP_ITEMS.find(x => x.id === itemId);
  if(!it) return;

  const owned = !!state.shop.owned[itemId];

  // –µ—Å–ª–∏ –Ω–µ –∫—É–ø–ª–µ–Ω–æ: –ø—Ä–æ–±—É–µ–º –∫—É–ø–∏—Ç—å
  if(!owned){
    if(!canAfford(it.cost)) return;
    pay(it.cost);
    state.shop.owned[itemId] = true;
  }

  // –µ—Å–ª–∏ —Ñ–æ–Ω: —ç–∫–∏–ø–∏—Ä—É–µ–º
  if(it.type === "bg"){
    state.shop.equipped.bg = itemId;
  }

  // –µ—Å–ª–∏ –¥–µ–∫–æ—Ä: –≤–∫–ª—é—á–∞–µ–º (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —Ç–≤–æ–µ–π renderDecor)
  if(it.type === "decor"){
    state.decor = state.decor || {};
    state.decor[itemId] = true;
  }

  // –µ—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç: –≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º
  if(it.type === "fx"){
    state.shop.fx = state.shop.fx || {};
    state.shop.fx[itemId] = !state.shop.fx[itemId];
  }

  saveState(state);
  render(state);
  renderGround(state);
  renderShop();
}

function renderShop(){
  ensureShop();

  const grid = el("decorGrid");
  if(!grid) return;

  // (1) –†–∏—Å—É–µ–º —Ç–∞–±—ã (–µ—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ–¥ —Ç–∞–±—ã, –¥–æ–±–∞–≤–∏–º –≤ HTML –Ω–∏–∂–µ)
  const tabs = el("shopTabs");
  if(tabs){
    tabs.innerHTML = SHOP_TABS.map(t => {
      const active = (state.shop.tab === t.id);
      return `<button type="button" class="tabBtn ${active ? "active":""}" data-tab="${t.id}">${t.name}</button>`;
    }).join("");
    tabs.querySelectorAll("button[data-tab]").forEach(b=>{
      b.onclick = () => setShopTab(b.dataset.tab);
    });
  }

  // (2) –ö–æ—à–µ–ª—ë–∫
  const wallet = el("shopWallet");
  if(wallet){
   wallet.innerHTML = `
  <span class="badge">${priceLine(state.inventory.leaves||0,  "icons/leaves.png",  "leaves")}</span>
  <span class="badge">${priceLine(state.inventory.fruits||0,  "icons/fruit.png",   "fruit")}</span>
  <span class="badge">${priceLine(state.inventory.essence||0, "icons/essence.png", "essence")}</span>
`;
  }

  // (3) –ö–∞—Ä—Ç–æ—á–∫–∏
  grid.innerHTML = "";
  const items = SHOP_ITEMS.filter(x => x.tab === state.shop.tab);

  items.forEach(it=>{
    const owned = !!state.shop.owned[it.id];
    const affordable = canAfford(it.cost);

    let price = [];
if(it.cost?.leaves)  price.push(priceLine(it.cost.leaves,  "icons/leaves.png",  "leaves"));
if(it.cost?.fruits)  price.push(priceLine(it.cost.fruits,  "icons/fruit.png",   "fruit"));
if(it.cost?.essence) price.push(priceLine(it.cost.essence, "icons/essence.png", "essence"));

    let status = "";
    if(it.type === "bg" && state.shop.equipped.bg === it.id) status = `<span class="badge">–í—ã–±—Ä–∞–Ω</span>`;
    if(it.type === "fx" && state.shop.fx?.[it.id]) status = `<span class="badge">–í–∫–ª—é—á–µ–Ω</span>`;
    if(owned && !status) status = `<span class="badge">–ö—É–ø–ª–µ–Ω–æ</span>`;

    const btnText =
      !owned ? "–ö—É–ø–∏—Ç—å" :
      (it.type === "bg") ? "–í—ã–±—Ä–∞—Ç—å" :
      (it.type === "fx") ? (state.shop.fx?.[it.id] ? "–í—ã–∫–ª—é—á–∏—Ç—å" : "–í–∫–ª—é—á–∏—Ç—å") :
      "–û–∫";

    const card = document.createElement("div");
    card.className = "rCard";
    card.innerHTML = `
      <div class="rImg">${it.tab === "bg" ? "üñº" : it.tab === "decor" ? "ü™µ" : it.tab === "fx" ? "‚ú®" : "üß™"}</div>
      <div class="rBody">
        <div class="name">${it.name}</div>
        <div class="desc">${it.desc}</div>
        <div class="mods">
          ${price.length ?` <span class="badge">${price.join(" ‚Ä¢ ")}</span>` : ``}
          ${status}
        </div>
        <div class="rActions" style="margin-top:10px;">
          <button type="button" data-buy="${it.id}" ${(!owned && !affordable) ? "disabled" : ""}>${btnText}</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
  grid.querySelectorAll("button[data-buy]").forEach(b=>{
    b.onclick = () => buyOrEquip(b.dataset.buy);
  });
}

function priceLine(amount, iconSrc, alt){
  return `
    <span class="currencyLine">
      <span class="amount">${amount}</span>
      <img class="currencyIcon" src="${iconSrc}" alt="${alt}">
    </span>
  `;
}

function renderDecor(){
  const layer = el("decorLayer");
  if(!layer) return;

  // —á–∏—Å—Ç–∏–º —Å–ª–æ–π (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–µ–∫–æ—Ä)
  layer.innerHTML = "";

  const night = isNightByLocalTime();

  // ===== –ó–ê–ë–û–†-–ö–ê–†–¢–ò–ù–ö–ê (–ø–æ–∑–∏—Ü–∏—è "1" –∫–∞–∫ –Ω–∞ —Ç–≤–æ—ë–º —Å–∫—Ä–∏–Ω–µ) =====
  if(state.decor?.fence){
    const f = document.createElement("img");
    f.className = "decorFenceImg";
    f.src = "assets/decor/fence.png";
    f.alt = "fence";

    // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Ç–æ—á–Ω–µ–µ –ø–æ–¥–æ–≥–Ω–∞—Ç—å "—Å—Ç–æ–ª–± –Ω–∞ —Å—Ç–≤–æ–ª":
    // f.style.left = "6%";            // –¥–≤–∏–≥–∞–π –ª–µ–≤–µ–µ/–ø—Ä–∞–≤–µ–µ
    // f.style.width = "420px";        // –¥–µ–ª–∞–π –±–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ
    // f.style.bottom = "11%";         // –≤—ã—à–µ/–Ω–∏–∂–µ

    layer.appendChild(f);
  }

  // ===== –§–û–ù–ê–†–¨-–ö–ê–†–¢–ò–ù–ö–ê (–ø–æ–∑–∏—Ü–∏—è "2" –º–µ–∂–¥—É –¥–µ—Ä–µ–≤–æ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏) =====
  if(state.decor?.lantern){
    const l = document.createElement("img");
    l.className = "decorLanternImg";
    l.src = "assets/decor/lantern.png";
    l.alt = "lantern";

    // –µ—Å–ª–∏ –Ω–∞–¥–æ –¥–≤–∏–≥–∞—Ç—å:
    // l.style.right = "92px";         // –±–ª–∏–∂–µ/–¥–∞–ª—å—à–µ –æ—Ç –∫–Ω–æ–ø–æ–∫
    // l.style.bottom = "6%";          // –≤—ã—à–µ/–Ω–∏–∂–µ
    // l.style.height = "240px";       // –±–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ

    layer.appendChild(l);

    // glow –Ω–æ—á—å—é
    if(night){
      const glow = document.createElement("div");
      glow.className = "decorLanternGlow";
      glow.style.opacity = "1";
      layer.appendChild(glow);
    }
  }
}

function heightMeters(level){
  // 0.03–º -> 0.1 -> 0.3 -> 1 -> 2.5 -> 6 -> 12 -> 18...
  const base = 0.03;
  return +(base * Math.pow(1.65, level)).toFixed(2);
}

    // =========================
    // 6) –ß–∞—Å—Ç–∏—Ü—ã: –ª–∏—Å—Ç—å—è
    // =========================
    function spawnLeaf(){
  const scene = document.getElementById("scene");
  if(!scene) return;

  const leaf = document.createElement("div");
  leaf.className = "leaf";
  leaf.style.animation = "none";

  const img = document.createElement("img");
  img.src = "assets/fx/leaf.png";   // ‚Üê –ø—É—Ç—å –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
  img.alt = "";

  leaf.appendChild(img);

  const startX = Math.random() * scene.clientWidth;
  const drift  = (Math.random() * 60) - 30; // –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ

  leaf.style.left = startX + "px";
  leaf.style.top  = "-40px";

  scene.appendChild(leaf);

  const fallDuration = 4500 + Math.random() * 2500;

  leaf.animate([
  { transform:`translate(0px, 0px) rotate(0deg)`, opacity:1.0 },
  { transform:`translate(${drift}px, ${scene.clientHeight + 80}px) rotate(140deg)`, opacity:1.0 }
], {
  duration: fallDuration,
  easing: "linear"
});

  // –∫–æ–≥–¥–∞ –¥–æ–ª–µ—Ç–µ–ª ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –ª–∏—Å—Ç –Ω–∞ –∑–µ–º–ª—é
  setTimeout(() => {
    leaf.remove();

    const w = state.weather || "sun";
    const dropChance =
      (w === "wind") ? 0.50 :
      (w === "rain") ? 0.45 :
      (w === "fog")  ? 0.30 :
      0.35;

    if(Math.random() < dropChance){
      state.groundLeaves = (state.groundLeaves || 0) + 1;
      saveState(state);
      renderGround(state);
    }
  }, fallDuration);
}

    // =========================
// –ö–æ–Ω—Ç—Ä–æ–ª—å –ª–∏—Å—Ç–æ–ø–∞–¥–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∞–¥–∞)
// =========================
const LEAF_FALL = {
  intervalMs: 2500,     // –∫–∞–∫ —á–∞—Å—Ç–æ "–ø—Ä–æ–≤–µ—Ä—è–µ–º" —Å–ø–∞–≤–Ω
  maxOnScreen: 4,     // –º–∞–∫—Å–∏–º—É–º –ª–∏—Å—Ç—å–µ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  minGapMs: 4500,
  chance: {            // —à–∞–Ω—Å –Ω–∞ –æ–¥–Ω—É "–ø—Ä–æ–≤–µ—Ä–∫—É"
    sun:  0.03,
    rain: 0.04,
    fog:  0.02,
    wind: 0.05
  }
};

let leafTimer = null;
let lastLeafAt = 0;

function startLeafFall(){
  if(leafTimer) return;

  leafTimer = setInterval(() => {
    const scene = el("scene");
    if(!scene) return;

    // –ª–∏–º–∏—Ç, —á—Ç–æ–±—ã —ç–∫—Ä–∞–Ω –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–ª—Å—è –≤ —Å–∞–ª–∞—Ç
    const onScreen = scene.querySelectorAll(".leaf").length;
    if(onScreen >= LEAF_FALL.maxOnScreen) return;

    const w = (state.weather || "sun");
    const p = (LEAF_FALL.chance[w] ?? LEAF_FALL.chance.sun);

    const t = Date.now();
if(t - lastLeafAt < (LEAF_FALL.minGapMs || 0)) return;

if(Math.random() < p){
  lastLeafAt = t;
  spawnLeaf();
}
  }, LEAF_FALL.intervalMs);
}
    
    function spawnDrop(){
  if((state.weather || "sun") !== "rain") return;

  const layer = document.getElementById("dropsLayer");
  if(!layer) return;

  const d = document.createElement("div");
  d.className = "drop";
  d.style.left = (Math.random()*100) + "%";
  d.style.animationDuration = (3.5 + Math.random()*2.5) + "s";

  d.addEventListener("click", () => collectDrop(d));
  layer.appendChild(d);

  // –∞–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ
  setTimeout(() => d.remove(), 8000);
}

function collectDrop(node){
  const s = state;

  const r = Math.random();
  if(r < 0.55){
    s.inventory.leaves += 1;
    log("üíß –ö–∞–ø–ª—è: +–ª–∏—Å—Ç—å—è");
  } else if(r < 0.85){
    s.water = clamp(s.water + 3, 0, 100);
    log("üíß –ö–∞–ø–ª—è: +–≤–æ–¥–∞");
  } else {
    s.inventory.essence += 1;
    log("üíß –ö–∞–ø–ª—è: +—ç—Å—Å–µ–Ω—Ü–∏—è");
  }

  node.remove();
  saveState(s);
  render(s);
}

    // =========================
    // 7) –ò–≥—Ä–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    // =========================
    let state = loadState();

    function pulseTree(){
      const t = el("tree");
      t.classList.add("pulse");
      setTimeout(() => t.classList.remove("pulse"), 250);
    }

    function doWater(){
  const tree = state.treeId ? (TREES[state.treeId] || null) : null;
  const mods = tree?.mods || {};
  const waterActionMul = mods.waterActionMul ?? 1.0;

  const add = 25 * waterActionMul;
  const wasDry = state.water < 20;
state.water = clamp(state.water + add, 0, 100);
if(wasDry) state.health = clamp(state.health + 2, 0, 100);

markDailyTask(state, "water");

  saveState(state);
  pulseTree();
  log(`üíß –ü–æ–ª–∏–ª–∏ (+${Math.round(add)} –≤–æ–¥—ã). –î–µ—Ä–µ–≤–æ –¥–æ–≤–æ–ª—å–Ω–æ.`);
  render(state);
}

    function doClean(){
      state.pests = clamp(state.pests - 35, 0, 100);
      markDailyTask(state, "clean");
      saveState(state);
      pulseTree();
      log("üßπ –ñ—É–∫–∏ –∏–∑–≥–Ω–∞–Ω—ã.");
      render(state);
    }
    
function doMeditate(){
  const s = state;

  // –Ω–æ—á—å/–¥–µ–Ω—å: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é
  const night = isNightByLocalTime();
  const keyToday = todayKeyLocal();

  // —Ö—Ä–∞–Ω–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –¥–Ω—è –∏ –Ω–æ—á–∏
  if(!s.meditation) s.meditation = {};
  const usedKey = night ? s.meditation.nightKey : s.meditation.dayKey;

  if(usedKey === keyToday){
    log(night ? t("med_used_night") : t("med_used_day"));
    return;
  }

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ
showQuoteModalAction(
  t("med_title"),
  t("med_text"),
  () => {
    // –æ—Ç–º–µ—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–ø–æ—Å–ª–µ OK)
    if(night) s.meditation.nightKey = keyToday;
    else s.meditation.dayKey = keyToday;

    // ‚úÖ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ "–º–µ–¥–∏—Ç–∞—Ü–∏—è"
    ensureDailyToday(s);
    markDailyTask(s, "meditate");

    saveState(s);
    render(s); // –µ—Å–ª–∏ —É —Ç–µ–±—è render() –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ render();

    // –∑–∞–ø—É—Å–∫: –æ—Ç—Å—á—ë—Ç + 1 –º–∏–Ω –¥—ã—Ö–∞–Ω–∏—è
    runMeditation1Min();
  }
);
}

async function doPhoto(){
  const s = state;

  // 1) –¢–æ–ª—å–∫–æ –≤ —Å–æ–ª–Ω–µ—á–Ω—É—é –ø–æ–≥–æ–¥—É
  if((s.weather || "sun") !== "sun"){
    log("üì∏ –§–æ—Ç–æ-—Å–µ—Å—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Å–æ–ª–Ω–µ—á–Ω—É—é –ø–æ–≥–æ–¥—É.");
    return;
  }

  // 2) –¢–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å
  const today = todayKey();
  s.daily = s.daily || {};
  if(s.daily.sunPhotoUsed === today){
    log("üì∏ –°–µ–≥–æ–¥–Ω—è —Ç—ã —É–∂–µ –¥–µ–ª–∞–ª(–∞) —Ñ–æ—Ç–æ.");
    return;
  }
  s.daily.sunPhotoUsed = today;

  // 3) –ù–∞–≥—Ä–∞–¥–∞
  const leavesGain = 20;
  s.inventory.leaves += leavesGain;

  let rewardMsg = `üì∏ –§–æ—Ç–æ-—Å–µ—Å—Å–∏—è: +${leavesGain} –ª–∏—Å—Ç—å–µ–≤.`;
  if(Math.random() < 0.12){
    s.inventory.fruits += 1;
    rewardMsg = `üì∏ –§–æ—Ç–æ-—Å–µ—Å—Å–∏—è: +${leavesGain} –ª–∏—Å—Ç—å–µ–≤ –∏ üçé –ø–ª–æ–¥!`;
  }
  log(rewardMsg);

  // 4) –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –∏ –æ–±–Ω–æ–≤–∏–ª–∏ UI (—á—Ç–æ–±—ã –Ω–∞–≥—Ä–∞–¥–∞ —Å—Ä–∞–∑—É –æ—Ç—Ä–∏—Å–æ–≤–∞–ª–∞—Å—å)
  saveState(s);
  render(s);

  // 5) –ê –í–û–¢ –¢–£–¢ –†–ï–ê–õ–¨–ù–û–ï –§–û–¢–û + –ú–ï–ù–Æ ‚Äú–°–∫–∞—á–∞—Ç—å PNG‚Äù
  try{
    await makeScenePhoto(); // —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–∞–º–∞ –≤—ã–∑–æ–≤–µ—Ç showPhotoModal(dataUrl)
  }catch(e){
    // –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, —Ö–æ—Ç—è –±—ã –Ω–µ –ø–∞–¥–∞–µ–º
    log("üì∏ –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ (–æ—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–µ/–∫–∞—Ä—Ç–∏–Ω–∫–µ).");
    console.error(e);
  }
}
    
    // =========================
    // 8) –ó–∞–ø—É—Å–∫
    // =========================
    function boot(){

      // show language choice if not chosen
if(!getLang()){
  showLangChoice();
} else {
  // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —è–∑—ã–∫ ‚Äî –≤—Å—ë –∫–∞–∫ –æ–±—ã—á–Ω–æ
  maybeShowDailyQuote(); // —á—Ç–æ–±—ã —Ü–∏—Ç–∞—Ç—ã –±—ã–ª–∏ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã
}
  
  ensureDailyToday(state);
  renderToday(state);
  // –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ—Å–∫—É —É–¥–æ–±—Ä–µ–Ω–∏—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (—á—Ç–æ–±—ã —Ç–∏–∫–∞–ª —Ç–∞–π–º–µ—Ä)
if(!window.__buffTimer){
  window.__buffTimer = setInterval(() => {
    renderBuffLine(state);
  }, 1000);
}
  bindQuiz();
  bindQuizImages();
  startLeafFall();
  bindMainButtons();
  el("btnGrow")?.addEventListener("click", doGrowStage);
  renderBuffLine(state);
  el("btnDailyClaim")?.addEventListener("click", claimDailyBag);
  el("btnPhoto")?.addEventListener("click", doPhoto);
  bindWeatherUI();
  startWeatherLoop();
  maybeShowDailyQuote();
  const btnCollect = document.getElementById("btnCollect");
if(btnCollect) btnCollect.addEventListener("click", collectLeaves);
if(typeof state.weather === "string"){
  setWeatherFx(state.weather);
  updateGrowButton(state);
}
(function setupBgParallax(){
  const bg = document.getElementById("bgLayer");
  const scene = document.getElementById("scene");
  if(!bg || !scene) return;

  let targetX = 0, targetY = 0;
  let curX = 0, curY = 0;

  // –º–µ–¥–ª–µ–Ω–Ω—ã–π ‚Äú–¥—Ä–µ–π—Ñ‚Äù
  let driftT = 0;

  function onMove(clientX, clientY){
    const r = scene.getBoundingClientRect();
    const nx = ((clientX - (r.left + r.width/2)) / r.width);   // -0.5..0.5
    const ny = ((clientY - (r.top  + r.height/2)) / r.height); // -0.5..0.5
    targetX = nx * 16;   // —Å–∏–ª–∞ –ø–∞—Ä–∞–ª–ª–∞–∫—Å–∞ –ø–æ X
    targetY = ny * 12;   // —Å–∏–ª–∞ –ø–∞—Ä–∞–ª–ª–∞–∫—Å–∞ –ø–æ Y
  }

  // —Ç–∞—á
  scene.addEventListener("touchmove", (e) => {
    if(!e.touches || !e.touches[0]) return;
    onMove(e.touches[0].clientX, e.touches[0].clientY);
  }, {passive:true});

  // –º—ã—à—å (–¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–∞ –ü–ö)
  scene.addEventListener("mousemove", (e) => {
    onMove(e.clientX, e.clientY);
  }, {passive:true});

  function tick(){
  // —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
  curX += (targetX - curX) * 0.10;
  curY += (targetY - curY) * 0.10;

  // ‚ùå —É–±–∏—Ä–∞–µ–º –¥—Ä–µ–π—Ñ: –æ–Ω –≥–ª–∞–≤–Ω—ã–π –≤–∏–Ω–æ–≤–Ω–∏–∫ "—Å—Ç–∞—Ä–æ–≥–æ –¢–í"
  const driftX = 0;
  const driftY = 0;

  // ‚úÖ –∂—ë—Å—Ç–∫–æ –∫ —Ü–µ–ª—ã–º –ø–∏–∫—Å–µ–ª—è–º
  const tx = Math.round(curX + driftX);
  const ty = Math.round(curY + driftY);

  // ‚úÖ –∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ (–º–∞—Å—à—Ç–∞–± —Ç–æ–∂–µ –¥–∞—ë—Ç —à–∏–º–º–µ—Ä)
  bg.style.transform = `translate3d(${tx}px, ${ty}px, 0) scale(1)`;

  requestAnimationFrame(tick);
}
  tick();
})();

  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ü–µ–Ω—É (–ø–æ—Ç–æ–º showQuiz/showResult –µ—ë —Å–∫—Ä–æ—é—Ç)
  setMainUIVisible(true);
  showResult(false);

  // –µ—Å–ª–∏ –¥–µ—Ä–µ–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç –∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º ‚Äú–º–∏—Ä‚Äù
  if(!state.treeId){
    showQuiz(true);
    render(state); // –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—É—Å—Ç—å UI –Ω–µ –ø—É—Å—Ç–æ–π
    renderGround(state);
    log("–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –î—É—Ö –î–µ—Ä–µ–≤–∞.");
    return;
  }

  // 1) –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å
  const res = tickTree(state, nowMs());
  saveState(state);
render(state);
renderGround(state);
startWorld();
setupParallax();
if(res.msg) log(res.msg);
   }
    
  function doFertilize(){
  const cost = 15; // –ª–∏—Å—Ç—å—è
  if((state.inventory.leaves || 0) < cost){
    log("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏—Å—Ç—å–µ–≤ –¥–ª—è —É–¥–æ–±—Ä–µ–Ω–∏—è.");
    return;
  }
  state.inventory.leaves -= cost;
  state.growthBuffUntil = nowMs() + 8 * 3600000; // 8 —á–∞—Å–æ–≤
  saveState(state);
  render(state);
  renderGround(state);
  log("–î–µ—Ä–µ–≤–æ –ø–æ–ª—É—á–∏–ª–æ –ø–∏—Ç–∞–Ω–∏–µ. –†–æ—Å—Ç —É—Å–∫–æ—Ä–µ–Ω –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤.");
}

function spawnFirefly(){
  if(!isNightByLocalTime()) return;

  const scene = document.getElementById("scene");
  if(!scene) return;

  const f = document.createElement("div");
  f.className = "firefly";
  f.style.left = (10 + Math.random()*80) + "%";
  f.style.top = (20 + Math.random()*55) + "%";
  f.style.animationDuration = (3.5 + Math.random()*3.5) + "s";
  scene.appendChild(f);

  setTimeout(() => f.remove(), 7000);
}

function calcGrowthLevel(xp){
  let lvl = 0;
  for(let i=0;i<GROWTH_XP_THRESHOLDS.length;i++){
    if(xp >= GROWTH_XP_THRESHOLDS[i]) lvl = i;
  }
  return lvl;
}

function renderBuffLine(s){
  const elLine = document.getElementById("buffLine");
  if(!elLine) return;

  const now = Date.now();
  const until = s.growthBuffUntil || 0;
  const left = until - now;

  if(left > 0){
    elLine.style.display = "";
    elLine.textContent = `üåø –£–¥–æ–±—Ä–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ: –æ—Å—Ç–∞–ª–æ—Å—å ${formatHHMMSS(left)}`;
  } else {
    elLine.style.display = "none";
  }
}

function growthInfo(level){
  if(level <= 2) return { major:0, minor:level, label:"–°–µ–º–µ—á–∫–æ" };
  if(level <= 5) return { major:1, minor:level-3, label:"–†–æ—Å—Ç–æ–∫" };
  if(level <= 8) return { major:2, minor:level-6, label:"–ú–æ–ª–æ–¥–æ–µ" };
  return { major:3, minor:level-9, label:"–í–∑—Ä–æ—Å–ª–æ–µ" }; // minor 0..1
}
    
    // =========================
// 9) Quiz logic
// =========================
const quizAnswers = { q1:null, q2:null, q3:null, q4:null };

function quizAnsweredCount(){
  return Object.values(quizAnswers).filter(Boolean).length;
}

function updateQuizProgress(){
  el("quizProgress").textContent = `${quizAnsweredCount()}/4`;
}

function setMainUIVisible(visible){
  const scene = el("scene");
  if(scene) scene.style.display = visible ? "" : "none";

  const hudTop = el("hudTop");
  if(hudTop) hudTop.style.display = visible ? "" : "none";

  const hudRight = el("hudRight");
  if(hudRight) hudRight.style.display = visible ? "" : "none";
}

function showQuiz(show){
  el("quiz")?.classList.toggle("active", !!show);
  setMainUIVisible(!show);
  // –µ—Å–ª–∏ —Å–∫—Ä—ã–ª–∏ —Ç–µ—Å—Ç, —É–±–µ–¥–∏–º—Å—è —á—Ç–æ —Å—Ü–µ–Ω–∞ —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–∏–º–∞
  if(!show) setMainUIVisible(true);
}

function finalizeTreeChoice(treeId){
  state.treeId = treeId;
  saveState(state);

  showResult(false);
  showQuiz(false);
  setMainUIVisible(true);

  bindMainButtons();  // —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  setupParallax();    // —á—Ç–æ–±—ã –ø–∞—Ä–∞–ª–ª–∞–∫—Å —Ä–∞–±–æ—Ç–∞–ª —Å—Ä–∞–∑—É, –±–µ–∑ refresh

  render(state);
  renderGround(state);
  startWorld();
}

 function startWorld(){
  if(worldStarted) return;
  worldStarted = true;

  setInterval(() => {
  const w = state.weather || "sun";
  const p = (w === "rain" || w === "snow") ? 0.55 : 0.35;
  if(Math.random() < p) spawnLeaf();
}, 900);

  setInterval(() => {
  const r = tickTree(state, nowMs());
  saveState(state);
  render(state);
  renderGround(state);
  if(r.msg) log(r.msg);
}, 10000);
  
  setInterval(() => {
  if(isNightByLocalTime() && Math.random() < 0.35) spawnFirefly();
}, 1200);

setInterval(() => {
  if((state.weather || "sun") === "rain"){
    if(Math.random() < 0.40) spawnDrop();
  }
}, 1200);

setInterval(() => {
  renderBuffLine(state);
}, 1000);

}

function handleQuizOptionClick(btn){
  const q = btn.dataset.q;
  const a = btn.dataset.a;

  // 1) –∑–∞–ø–æ–º–Ω–∏–ª–∏ –æ—Ç–≤–µ—Ç
  quizAnswers[q] = a;

  // 2) –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞: —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞, –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤—ã–¥–µ–ª–∏—Ç—å
  document
    .querySelectorAll(`button[data-q="${q}"]`)
    .forEach(b => b.classList.remove("selected"));

  btn.classList.add("selected");

  // 3) –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
  updateQuizProgress();

  // 4) –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤—Å–µ 4 –≤–æ–ø—Ä–æ—Å–∞
  if(quizAnsweredCount() === 4){
    const res = pickTreeFromAnswers(quizAnswers);

    if(res.winner){
      renderResultOptions([res.winner]);
    } else {
      renderResultOptions(res.options);
    }

    // 5) –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
    showQuiz(false);              // <- –í–ê–ñ–ù–û: –ø—Ä—è—á–µ–º —Ç–µ—Å—Ç
    showResult(true);

    // 6) –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –Ω–∞–≤–µ—Ä—Ö, —á—Ç–æ–±—ã –Ω–µ –ø–æ—è–≤–ª—è–ª–æ—Å—å "—Å–Ω–∏–∑—É"
    document.querySelector(".app")?.scrollTo({ top: 0, behavior: "smooth" });
  }
}

function bindQuiz(){
  document.querySelectorAll(".qOpt").forEach(btn => {
    btn.addEventListener("click", () => handleQuizOptionClick(btn));
  });

  el("btnQuizReset").addEventListener("click", () => {
    quizAnswers.q1 = quizAnswers.q2 = quizAnswers.q3 = quizAnswers.q4 = null;
    document.querySelectorAll(".qOpt").forEach(b => {
      b.classList.remove("selected");
    });
    updateQuizProgress();
    log("–û—Ç–≤–µ—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã.");
  });

  el("btnResultBack").addEventListener("click", () => {
  showResult(false);
  showQuiz(true);
  setMainUIVisible(false); // —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ü–µ–Ω—É –≤–º–µ—Å—Ç–æ —Ç–µ—Å—Ç–∞
  document.querySelector(".app")?.scrollTo({ top: 0, behavior: "smooth" });
});

  updateQuizProgress();
}
    
    function bindQuizImages(){
  document.querySelectorAll('img[data-img]').forEach(img => {
    const key = img.dataset.img;
    img.src = IMG[key] || "";
  });
}

function showResult(show){
  const res = el("result");
  if(res) res.classList.toggle("active", !!show);

  // –ø—Ä—è—á–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π UI (—Å—Ü–µ–Ω–∞ + –Ω–∏–∂–Ω–∏–µ –ø–∞–Ω–µ–ª–∏) –±–µ–∑–æ–ø–∞—Å–Ω–æ
  setMainUIVisible(!show);

  // –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ –±–ª–æ–∫–∏ .grid/.actions ‚Äî –ø—Ä—è—á–µ–º —Ç–æ–∂–µ, –Ω–æ –±–µ–∑ –ø–∞–¥–µ–Ω–∏–π
  const grid = document.querySelector(".grid");
  if(grid) grid.style.display = show ? "none" : "";

  const actions = document.querySelector(".actions");
  if(actions) actions.style.display = show ? "none" : "";
}

function modsBadges(treeId){
  const t = TREES[treeId];
  const m = t.mods || {};
  const badges = [];

  const xp = Math.round((m.xpMul ?? 1) * 100);
  badges.push(`–†–æ—Å—Ç: ${xp}%`);

  const wd = Math.round((m.waterDecayMul ?? 1) * 100);
  badges.push(`–†–∞—Å—Ö–æ–¥ –≤–æ–¥—ã: ${wd}%`);

  const pm = Math.round((m.pestsMul ?? 1) * 100);
  badges.push(`–ñ—É–∫–∏: ${pm}%`);

  const nx = Math.round((m.nightXpMul ?? 1) * 100);
  if(nx !== 100) badges.push(`–ù–æ—á—å: ${nx}%`);

  return badges;
}

// ============================
// Motivational quotes (morning/night)
// ============================

// 1) –°–ø–∏—Å–∫–∏ —Ü–∏—Ç–∞—Ç. –ú–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å/–¥–æ–±–∞–≤–ª—è—Ç—å —Å–∫–æ–ª—å–∫–æ —Ö–æ—á–µ—à—å.
const MORNING_QUOTES = [
  "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ. –°–µ–≥–æ–¥–Ω—è –Ω–µ –æ–±—è–∑–∞–Ω –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–º. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Ç—å –≤ –¥–≤–∏–∂–µ–Ω–∏–∏.",
  "–ú–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ —Å–µ–≥–æ–¥–Ω—è –ª—É—á—à–µ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –∑–∞–≤—Ç—Ä–∞.",
  "–¢—ã –Ω–µ –¥–µ—Ä–µ–≤–æ‚Ä¶ —Ö–æ—Ç—è —Å—Ç–æ–ø. –¢—ã –±—É–∫–≤–∞–ª—å–Ω–æ –≤—ã—Ä–∞—â–∏–≤–∞–µ—à—å –¥–µ—Ä–µ–≤–æ. –¢–∞–∫ —á—Ç–æ –¥–∞–≤–∞–π —Ä–∞—Å—Ç–∏ –≤–º–µ—Å—Ç–µ.",
  "–°–¥–µ–ª–∞–π –æ–¥–Ω—É –ø–æ–ª–µ–∑–Ω—É—é –≤–µ—â—å –∏ –Ω–µ —É—Å—Ç—Ä–∞–∏–≤–∞–π –¥—Ä–∞–º—É. –≠—Ç–æ —É–∂–µ –ø–æ–±–µ–¥–∞."
];

const NIGHT_QUOTES = [
  "–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏. –í—Å—ë, —á—Ç–æ –Ω–µ —É—Å–ø–µ–ª, –∑–∞–≤—Ç—Ä–∞ –µ—â—ë –±—É–¥–µ—Ç —à–∞–Ω—Å –¥–æ–¥–µ–ª–∞—Ç—å. –ë–µ–∑ –ø–∞–Ω–∏–∫–∏.",
  "–°–µ–≥–æ–¥–Ω—è —Ç—ã –¥–æ–∂–∏–ª –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è. –≠—Ç–æ —É–∂–µ –Ω–µ–ø–ª–æ—Ö–æ. –û—Ç–¥—ã—Ö–∞–π.",
  "–û—Ç–ø—É—Å—Ç–∏ –¥–µ–Ω—å. –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –Ω–æ–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏ –Ω–æ–≤–æ–µ —Å–æ–ª–Ω—Ü–µ.",
  "–°–æ–Ω —ç—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–∞—Ñ—Ñ. –ü–æ–ª—å–∑—É–π—Å—è."
];

// 2) –£—Ç—Ä–æ/–Ω–æ—á—å –ø–æ —á–∞—Å–∞–º. –ú–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å.
const MORNING_START = 5;   // 05:00
const MORNING_END   = 15;  // –¥–æ 14:59 (15 –Ω–µ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
const NIGHT_START   = 18;  // 18:00
const NIGHT_END     = 4;   // –¥–æ 03:59

function pad2(n){ return String(n).padStart(2,"0"); }

// –î–∞—Ç–∞-–∫–ª—é—á "2026-02-17"
function todayKeyLocal(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ –¥–Ω—è: "morning" | "night" | null
function currentPeriod(){
  const h = new Date().getHours();

  if(h >= MORNING_START && h < MORNING_END) return "morning";

  // –ù–æ—á—å —Ö–∏—Ç—Ä–∞—è: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–µ—á–µ—Ä–æ–º –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏
  // –ü—Ä–∏–º–µ—Ä: 18..23 –∏–ª–∏ 0..3
  if(h >= NIGHT_START || h < NIGHT_END) return "night";

  return null;
}

function pickRandom(arr){
  return arr[Math.floor(Math.random() * arr.length)];
}

// 3) –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏
function showQuoteModal(title, text){
  const modal = document.getElementById("quoteModal");
  const t = document.getElementById("quoteTitle");
  const x = document.getElementById("quoteText");
  const btn = document.getElementById("quoteBtn");

  if(!modal || !t || !x || !btn) return;

  t.textContent = title;
  x.textContent = text;

  modal.classList.remove("hidden");

  const close = () => {
    modal.classList.add("hidden");
    btn.removeEventListener("click", close);
    modal.removeEventListener("click", onBackdrop);
  };

  const onBackdrop = (e) => {
    // –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ —Ñ–æ–Ω—É, –Ω–µ –ø–æ –∫–æ—Ä–æ–±–∫–µ
    if(e.target === modal) close();
  };

  btn.addEventListener("click", close);
  modal.addEventListener("click", onBackdrop);
}

// ===== Modal with OK action (reuses quoteModal UI) =====
function showQuoteModalAction(title, text, onOk){
  const modal = document.getElementById("quoteModal");
  const tt = document.getElementById("quoteTitle");
  const xx = document.getElementById("quoteText");
  const btn = document.getElementById("quoteBtn");
  if(!modal || !tt || !xx || !btn) return;

  tt.textContent = title;
  xx.textContent = text;
  modal.classList.remove("hidden");

  const close = () => {
    modal.classList.add("hidden");
    btn.removeEventListener("click", ok);
    modal.removeEventListener("click", onBackdrop);
  };

  const ok = () => {
    close();
    try{ onOk && onOk(); }catch(e){ console.error(e); }
  };

  const onBackdrop = (e) => {
    if(e.target === modal) close();
  };

  btn.addEventListener("click", ok);
  modal.addEventListener("click", onBackdrop);
}

// ===== Meditation: overlay + safe click sound (no files needed) =====
let _medAudioCtx = null;
function medClick(){
  try{
    if(!_medAudioCtx) _medAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ctx = _medAudioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 880;     // —Ç–æ–Ω –∫–ª–∏–∫–∞, –º–µ–Ω—è–π
    g.gain.value = 0.0001;

    o.connect(g);
    g.connect(ctx.destination);

    const t = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.18, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.06);

    o.start(t);
    o.stop(t + 0.07);
  }catch(e){
    // –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∫–∞–ø—Ä–∏–∑–Ω–∏—á–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏–º
  }
}

function showMedOverlay(bigText, smallText){
  const ov = document.getElementById("medOverlay");
  const b = document.getElementById("medBig");
  const s = document.getElementById("medSmall");
  if(!ov || !b || !s) return;
  b.textContent = bigText;
  s.textContent = smallText || "";
  ov.classList.remove("hidden");
}
function hideMedOverlay(){
  const ov = document.getElementById("medOverlay");
  if(ov) ov.classList.add("hidden");
}

function runMeditation1Min(){
  // 5..0 countdown, then 60 seconds breathing
  const inhaleSec = 4;    // –º–µ–Ω—è–π: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–¥–æ—Ö–∞
  const exhaleSec = 4;    // –º–µ–Ω—è–π: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–¥–æ—Ö–∞
  const totalSec = 60;

  let n = 5;
  showMedOverlay(String(n), t("med_ready"));
  medClick();

  const cd = setInterval(() => {
    n -= 1;
    if(n >= 0){
      showMedOverlay(String(n), t("med_ready"));
      medClick();
      return;
    }
    clearInterval(cd);

    // breathing phase
    let left = totalSec;
    let phase = "inhale";
    let phaseLeft = inhaleSec;

    showMedOverlay(String(left), `${t("med_inhale")} (${phaseLeft})`);
    medClick();

    const tick = setInterval(() => {
      left -= 1;
      phaseLeft -= 1;

      if(left <= 0){
        clearInterval(tick);
        hideMedOverlay();
        log(t("med_done"));
        return;
      }

      if(phaseLeft <= 0){
        phase = (phase === "inhale") ? "exhale" : "inhale";
        phaseLeft = (phase === "inhale") ? inhaleSec : exhaleSec;
        medClick();
      }

      const label = (phase === "inhale") ? t("med_inhale") : t("med_exhale");
      showMedOverlay(String(left), `${label} (${phaseLeft})`);
    }, 1000);

  }, 1000);
}

function showRewardModal(text){
  const modal = document.getElementById("rewardModal");
  const x = document.getElementById("rewardText");
  const btn = document.getElementById("rewardBtn");
  if(!modal || !x || !btn) return;

  x.innerHTML = text;
  modal.classList.remove("hidden");

  const close = () => {
    modal.classList.add("hidden");
    btn.removeEventListener("click", close);
    modal.removeEventListener("click", onBackdrop);
  };

  const onBackdrop = (e) => { if(e.target === modal) close(); };

  btn.addEventListener("click", close);
  modal.addEventListener("click", onBackdrop);
}

// 4) –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å 1 —Ä–∞–∑ –≤ –ø–µ—Ä–∏–æ–¥
function maybeShowDailyQuote(){
  const period = currentPeriod();
  if(!period) return;

  const day = todayKeyLocal();
  const storageKey = `quote_shown_${period}_${day}`;

  // –£–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥
  if(localStorage.getItem(storageKey) === "1") return;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
    if(period === "morning"){
    showQuoteModal(t("morningTitle"), tRandom("morningQuotes"));
  } else if(period === "night"){
    showQuoteModal(t("nightTitle"), tRandom("nightQuotes"));
  }

  // –°—Ç–∞–≤–∏–º ‚Äú–≥–∞–ª–æ—á–∫—É‚Äù, —á—Ç–æ–±—ã –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ —Å–µ–≥–æ–¥–Ω—è –Ω–µ —Å–ø–∞–º–∏—Ç—å
  localStorage.setItem(storageKey, "1");
}

function renderResultOptions(treeIds){
  const grid = el("resultGrid");
  grid.innerHTML = "";

  treeIds.forEach(treeId => {
    const t = TREES[treeId];
    const card = document.createElement("div");
    card.className = "rCard";

    const badges = modsBadges(treeId)
      .map(x => `<span class="badge">${x}</span>`)
      .join("");

    card.innerHTML = `
      <div class="rImg"><img src="${t.img}" alt=""></div>
      <div class="rBody">
        <div class="name">${t.icon} ${t.name}</div>
        <div class="desc">${t.desc}</div>
        <div class="mods">${badges}</div>
        <div class="rActions" style="margin-top:10px;">
          <button type="button" data-pick="${treeId}">–í—ã–±—Ä–∞—Ç—å</button>
        </div>
      </div>
    `;

    grid.appendChild(card);
  });

  grid.querySelectorAll("button[data-pick]").forEach(b => {
   b.addEventListener("click", () => {
  finalizeTreeChoice(b.dataset.pick);
});
  });
}
    

    boot();
  </script>
</body>
</html>
